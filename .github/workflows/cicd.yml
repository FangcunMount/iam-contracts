name: CI/CD Pipeline

# å¿…éœ€çš„ Secrets é…ç½® (åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­é…ç½®)
# Settings â†’ Secrets and variables â†’ Actions
# 
# Organization çº§åˆ« Secrets:
#   - SVRA_HOST, SVRA_USERNAME, SVRA_SSH_KEY, SVRA_SSH_PORT
#   - MYSQL_HOST, MYSQL_PORT, REDIS_HOST, REDIS_PORT
#
# Repository çº§åˆ« Secrets:
#   - MYSQL_USERNAME, MYSQL_PASSWORD, MYSQL_DBNAME
#   - REDIS_PASSWORD, REDIS_DB
#
# validate-secrets job ä¼šåœ¨è¿è¡Œæ—¶éªŒè¯è¿™äº› Secrets æ˜¯å¦å­˜åœ¨

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  GO_VERSION: '1.24'
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: fangcunmount/iam-contracts  # å¿…é¡»å°å†™ï¼ŒDocker ä¸æ”¯æŒå¤§å†™å­—æ¯

jobs:
  validate-secrets:
    name: Validate Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Check Required Secrets
        env:
          SVRA_HOST: ${{ secrets.SVRA_HOST }}
          SVRA_USERNAME: ${{ secrets.SVRA_USERNAME }}
          SVRA_SSH_KEY: ${{ secrets.SVRA_SSH_KEY }}
          MYSQL_HOST: ${{ secrets.MYSQL_HOST }}
          MYSQL_USERNAME: ${{ secrets.MYSQL_USERNAME }}
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
          MYSQL_DBNAME: ${{ secrets.MYSQL_DBNAME }}
        run: |
          echo "ğŸ” Validating required secrets..."
          
          # åˆå§‹åŒ–éªŒè¯çŠ¶æ€
          VALIDATION_FAILED=0
          
          # æ£€æŸ¥éƒ¨ç½²ç›¸å…³çš„ secrets(ä»…åœ¨ main åˆ†æ”¯éœ€è¦)
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "ğŸ“‹ Checking deployment secrets for main branch..."
            
            # æœåŠ¡å™¨è¿æ¥
            if [ -z "$SVRA_HOST" ]; then
              echo "âŒ SVRA_HOST is not set"
              VALIDATION_FAILED=1
            else
              echo "âœ… SVRA_HOST is set"
            fi
            
            if [ -z "$SVRA_USERNAME" ]; then
              echo "âŒ SVRA_USERNAME is not set"
              VALIDATION_FAILED=1
            else
              echo "âœ… SVRA_USERNAME is set"
            fi
            
            if [ -z "$SVRA_SSH_KEY" ]; then
              echo "âŒ SVRA_SSH_KEY is not set"
              VALIDATION_FAILED=1
            else
              echo "âœ… SVRA_SSH_KEY is set"
            fi
            
            # æ•°æ®åº“è¿æ¥
            if [ -z "$MYSQL_HOST" ]; then
              echo "âŒ MYSQL_HOST is not set"
              VALIDATION_FAILED=1
            else
              echo "âœ… MYSQL_HOST is set"
            fi
            
            if [ -z "$MYSQL_USERNAME" ]; then
              echo "âŒ MYSQL_USERNAME is not set"
              VALIDATION_FAILED=1
            else
              echo "âœ… MYSQL_USERNAME is set"
            fi
            
            if [ -z "$MYSQL_PASSWORD" ]; then
              echo "âŒ MYSQL_PASSWORD is not set"
              VALIDATION_FAILED=1
            else
              echo "âœ… MYSQL_PASSWORD is set"
            fi
            
            if [ -z "$MYSQL_DBNAME" ]; then
              echo "âŒ MYSQL_DBNAME is not set"
              VALIDATION_FAILED=1
            else
              echo "âœ… MYSQL_DBNAME is set"
            fi
          else
            echo "â„¹ï¸ Skipping deployment secrets check (not on main branch)"
          fi
          
          # æ£€æŸ¥ç»“æœ
          echo ""
          if [ $VALIDATION_FAILED -eq 1 ]; then
            echo "âŒ Secrets validation failed! Please configure missing secrets."
            exit 1
          else
            echo "âœ… All required secrets are configured!"
          fi

  test:
    name: Run Tests
    needs: [validate-secrets]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          
      - name: Get dependencies
        run: |
          go mod download
          go mod verify
          
      - name: Run tests
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
          
      - name: Generate coverage report
        run: |
          go tool cover -func=coverage.out
          
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.out
          flags: unittests
          name: codecov-umbrella

  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v7
        with:
          version: v2.1.6  # ä¸æœ¬åœ°ç‰ˆæœ¬ä¸€è‡´
          args: --timeout=5m

  build:
    name: Build Application
    needs: [test, lint]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          
      - name: Build
        run: |
          make build
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: iam-apiserver
          path: _output/bin/iam-apiserver
          retention-days: 7

  docker:
    name: Build Docker Image
    needs: [build]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
            
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./build/docker/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

  deploy:
    name: Deploy to Production
    needs: [build, docker]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://iam.example.com
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: iam-apiserver
          path: ./artifacts
      
      - name: Prepare deployment files
        run: |
          chmod +x ./artifacts/iam-apiserver
          mkdir -p deploy-package
          cp ./artifacts/iam-apiserver deploy-package/
          cp -r configs deploy-package/
          tar -czf deploy-package.tar.gz -C deploy-package .
          
      - name: Upload deployment package
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SVRA_HOST }}
          username: ${{ secrets.SVRA_USERNAME }}
          key: ${{ secrets.SVRA_SSH_KEY }}
          port: ${{ secrets.SVRA_SSH_PORT || 22 }}
          source: "deploy-package.tar.gz"
          target: "/tmp"
        
      - name: Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SVRA_HOST }}
          username: ${{ secrets.SVRA_USERNAME }}
          key: ${{ secrets.SVRA_SSH_KEY }}
          port: ${{ secrets.SVRA_SSH_PORT || 22 }}
          script: |
            set -e
            
            echo "=========================================="
            echo "Starting deployment to Production Server (SVRA)"
            echo "=========================================="
            
            # Create directory structure
            sudo mkdir -p /opt/iam/_output/bin
            sudo mkdir -p /opt/iam/configs
            
            # Backup current version
            echo "Creating backup..."
            BACKUP_DIR="/opt/backups/iam/deployments"
            sudo mkdir -p $BACKUP_DIR
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            sudo tar -czf $BACKUP_DIR/backup_${TIMESTAMP}.tar.gz \
                -C /opt/iam _output/bin/iam-apiserver configs/apiserver.yaml \
                2>/dev/null || echo "No previous version to backup"
            
            # Extract new version
            echo "Extracting new deployment package..."
            cd /tmp
            tar -xzf deploy-package.tar.gz
            sudo mv iam-apiserver /opt/iam/_output/bin/
            sudo cp -r configs/* /opt/iam/configs/
            sudo chown -R $(whoami):$(whoami) /opt/iam
            rm -f deploy-package.tar.gz
            
            # Pull latest Docker image (optional, for Docker-based deployment)
            echo "Pulling latest Docker image..."
            docker pull ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:latest || echo "Docker pull skipped"
            
            # Stop service
            echo "Stopping IAM service..."
            sudo systemctl stop iam-apiserver || echo "Service not running"
            
            # Start service with new binary
            echo "Starting IAM service..."
            sudo systemctl start iam-apiserver
            
            # Wait for service to be ready
            echo "Waiting for service to be ready..."
            sleep 10
            
            # Health check
            echo "Performing health check..."
            if systemctl is-active --quiet iam-apiserver; then
              echo "âœ… Service is running"
              systemctl status iam-apiserver --no-pager | head -10
              
              # API health check
              if curl -sf http://localhost:8080/healthz > /dev/null; then
                echo "âœ… API health check passed"
              else
                echo "âš ï¸ API health check failed"
                exit 1
              fi
            else
              echo "âŒ Service failed to start"
              echo "Checking logs..."
              sudo journalctl -u iam-apiserver -n 50 --no-pager
              exit 1
            fi
            
            # Clean up old backups (keep last 10)
            echo "Cleaning up old backups..."
            sudo ls -t $BACKUP_DIR/backup_*.tar.gz 2>/dev/null | tail -n +11 | xargs -r sudo rm -f 2>/dev/null || true
            
            echo "=========================================="
            echo "âœ… Deployment completed successfully"
            echo "=========================================="
            
      - name: Verify Deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SVRA_HOST }}
          username: ${{ secrets.SVRA_USERNAME }}
          key: ${{ secrets.SVRA_SSH_KEY }}
          port: ${{ secrets.SVRA_SSH_PORT || 22 }}
          script: |
            echo "Verifying deployment..."
            
            # Check service status
            if systemctl is-active --quiet iam-apiserver; then
              echo "âœ… Service is active"
            else
              echo "âŒ Service is not active"
              exit 1
            fi
            
            # Check API response
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/healthz)
            if [ "$RESPONSE" = "200" ]; then
              echo "âœ… API is responding correctly"
            else
              echo "âŒ API returned status: $RESPONSE"
              exit 1
            fi
            
            # Check version
            echo "Deployed version:"
            /opt/iam/_output/bin/iam-apiserver version || echo "Version check skipped"
            
            echo "âœ… Deployment verification passed"

  notify:
    name: Send Notification
    needs: [deploy]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Prepare notification message
        id: message
        run: |
          DEPLOY_STATUS="${{ needs.deploy.result }}"
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          ACTOR="${{ github.actor }}"
          
          if [ "$DEPLOY_STATUS" == "success" ]; then
            STATUS_EMOJI="âœ…"
            STATUS_TEXT="æˆåŠŸ"
            COLOR="#00FF00"
          else
            STATUS_EMOJI="âŒ"
            STATUS_TEXT="å¤±è´¥"
            COLOR="#FF0000"
          fi
          
          # For Enterprise WeChat
          WECHAT_MSG=$(cat <<EOF
          {
            "msgtype": "markdown",
            "markdown": {
              "content": "## ${STATUS_EMOJI} IAM éƒ¨ç½²é€šçŸ¥\n\n**çŠ¶æ€**: <font color=\"${COLOR}\">${STATUS_TEXT}</font>\n**ç¯å¢ƒ**: Production (SVRA)\n**æ—¶é—´**: ${TIMESTAMP}\n**æäº¤**: ${COMMIT_SHA:0:7}\n**ä¿¡æ¯**: ${COMMIT_MSG}\n**æ“ä½œäºº**: ${ACTOR}\n\n[æŸ¥çœ‹è¯¦æƒ…](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            }
          }
          EOF
          )
          
          echo "wechat_msg<<EOF" >> $GITHUB_OUTPUT
          echo "$WECHAT_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "status=${STATUS_TEXT}" >> $GITHUB_OUTPUT
          echo "emoji=${STATUS_EMOJI}" >> $GITHUB_OUTPUT
      
      # ä¼ä¸šå¾®ä¿¡é€šçŸ¥ (éœ€è¦é…ç½® WECHAT_WEBHOOK secret)
      - name: Send WeChat notification
        if: vars.ENABLE_WECHAT_NOTIFICATION == 'true'
        run: |
          curl -X POST "${{ secrets.WECHAT_WEBHOOK }}" \
            -H 'Content-Type: application/json' \
            -d '${{ steps.message.outputs.wechat_msg }}'
      
      # GitHub Issue è¯„è®ºé€šçŸ¥ (å¦‚æœå¤±è´¥)
      - name: Comment on related issue
        if: failure() && github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const message = `## ${{ steps.message.outputs.emoji }} éƒ¨ç½²å¤±è´¥é€šçŸ¥
            
            **ç¯å¢ƒ**: Production
            **æäº¤**: ${{ github.sha }}
            **æ—¶é—´**: ${new Date().toLocaleString('zh-CN', {timeZone: 'Asia/Shanghai'})}
            
            [æŸ¥çœ‹å¤±è´¥è¯¦æƒ…](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`;
            
            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é€»è¾‘æŸ¥æ‰¾ç›¸å…³ issue å¹¶è¯„è®º
            console.log(message);
      
      # ç®€å•çš„æ—¥å¿—è¾“å‡º(å§‹ç»ˆæ‰§è¡Œ)
      - name: Log deployment status
        run: |
          echo "${{ steps.message.outputs.emoji }} Deployment to production: ${{ steps.message.outputs.status }}"
          if [ "${{ needs.deploy.result }}" != "success" ]; then
            exit 1
          fi
