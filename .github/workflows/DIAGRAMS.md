# GitHub Actions CI/CD 流程图

## 完整 CI/CD 流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                          代码提交/PR                                  │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         CI 阶段 (并行)                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                 │
│  │   Lint      │  │    Test     │  │   Build     │                 │
│  │  代码检查   │  │  单元测试   │  │  构建二进制 │                 │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘                 │
│         │                │                │                         │
│         │                │                │                         │
│         └────────────────┴────────────────┘                         │
│                          │                                           │
└──────────────────────────┼───────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      Docker 镜像构建                                  │
│                                                                       │
│  ┌───────────────────────────────────────────────────────────┐     │
│  │  构建多架构镜像 (amd64, arm64)                              │     │
│  │  推送到 Docker Hub                                          │     │
│  └───────────────────────────────────────────────────────────┘     │
└──────────────────────────┬────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        CD 阶段 (根据分支)                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  develop 分支        release/** 分支        v*.*.* 标签              │
│       │                   │                      │                   │
│       ▼                   ▼                      ▼                   │
│  ┌─────────┐        ┌──────────┐          ┌──────────┐             │
│  │  开发环境│        │ 预发布环境│          │  生产环境 │             │
│  └─────────┘        └──────────┘          └──────────┘             │
│       │                   │                      │                   │
│       ▼                   ▼                      ▼                   │
│  二进制部署          Docker 部署            蓝绿部署                  │
│                                                                       │
└───────────────────────────┬───────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         健康检查                                      │
│                                                                       │
│  ┌───────────────────────────────────────────────────────────┐     │
│  │  - API 端点测试                                             │     │
│  │  - 数据库连接                                               │     │
│  │  - 服务状态验证                                             │     │
│  └───────────────────────────────────────────────────────────┘     │
└──────────────────────────┬────────────────────────────────────────┘
                           │
                           ▼
                    ┌──────┴──────┐
                    │             │
                    ▼             ▼
            ┌──────────┐    ┌──────────┐
            │  成功通知│    │  失败回滚│
            └──────────┘    └──────────┘
```

---

## 分支策略与部署流程

```
main (生产)
  │
  ├─── v1.0.0 ────────► 生产环境部署 (蓝绿)
  │    (标签)
  │
  ├─── release/v1.0.0 ─► 预发布环境 (Docker)
  │    │
  │    └─── develop ────► 开发环境 (二进制)
  │         │
  │         ├─── feature/login
  │         ├─── feature/auth
  │         └─── bugfix/issue-123
  │
  └─── hotfix/critical ─► 紧急修复 → 直接到生产
```

---

## 工作流触发关系

```
┌────────────────────────────────────────────────────────────┐
│                      触发事件                               │
└────────────────────────────────────────────────────────────┘
         │                │                │
         │                │                │
    Push/PR          定时任务          手动触发
         │                │                │
         ▼                ▼                ▼
┌─────────────┐  ┌──────────────┐  ┌─────────────┐
│  cicd.yml   │  │server-check  │  │  db-ops.yml │
│             │  │.yml          │  │             │
│  - Lint     │  │              │  │  - Backup   │
│  - Test     │  │- API Check   │  │  - Migrate  │
│  - Build    │  │- DB Check    │  │  - Seed     │
│  - Deploy   │  │- SSL Check   │  │             │
└─────────────┘  └──────────────┘  └─────────────┘
         │                │                │
         └────────────────┴────────────────┘
                          │
                          ▼
                  ┌──────────────┐
                  │  通知 & 报告  │
                  └──────────────┘
```

---

## 部署环境对比

```
┌──────────────┬──────────────┬──────────────┬──────────────┐
│   特性       │  开发环境    │  预发布环境  │  生产环境    │
├──────────────┼──────────────┼──────────────┼──────────────┤
│ 触发条件     │ develop 分支 │ release 分支 │ v*.*.* 标签  │
├──────────────┼──────────────┼──────────────┼──────────────┤
│ 部署方式     │ 二进制       │ Docker       │ 蓝绿部署     │
├──────────────┼──────────────┼──────────────┼──────────────┤
│ 健康检查     │ 基础         │ 完整         │ 完整+SSL     │
├──────────────┼──────────────┼──────────────┼──────────────┤
│ 回滚策略     │ 无           │ 手动         │ 自动         │
├──────────────┼──────────────┼──────────────┼──────────────┤
│ 备份         │ 无           │ 可选         │ 必须         │
├──────────────┼──────────────┼──────────────┼──────────────┤
│ 监控         │ 无           │ 基础         │ 完整         │
└──────────────┴──────────────┴──────────────┴──────────────┘
```

---

## 健康检查流程

```
定时触发 (每小时)
      │
      ▼
┌──────────────────────────────────────────┐
│        选择检查类型                       │
├──────────────────────────────────────────┤
│  - full (完整)                            │
│  - quick (快速)                           │
│  - api-only (API专项)                     │
│  - database-only (数据库专项)             │
└──────────┬───────────────────────────────┘
           │
           ▼
    ┌──────┴──────┐
    │             │
    ▼             ▼
┌────────┐   ┌─────────┐
│ API检查│   │ DB检查  │
└───┬────┘   └────┬────┘
    │             │
    │             ▼
    │        ┌─────────┐
    │        │SSL检查  │
    │        └────┬────┘
    │             │
    └─────┬───────┘
          │
          ▼
    ┌───────────┐
    │ 生成报告  │
    └─────┬─────┘
          │
    ┌─────┴──────┐
    │            │
    ▼            ▼
┌────────┐  ┌──────────┐
│ 成功   │  │失败→Issue│
└────────┘  └──────────┘
```

---

## 数据库操作流程

```
手动触发
    │
    ▼
┌────────────────────────────────┐
│      选择操作类型               │
├────────────────────────────────┤
│  1. Health Check               │
│  2. Backup                     │
│  3. Migrate                    │
│  4. Seed (非生产)              │
└────────┬───────────────────────┘
         │
    ┌────┴────┬──────┬──────┐
    │         │      │      │
    ▼         ▼      ▼      ▼
┌────────┐┌────────┐┌────────┐┌────────┐
│健康检查││ 备份   ││ 迁移   ││ 填充   │
└───┬────┘└───┬────┘└───┬────┘└───┬────┘
    │         │         │         │
    │         │         │         │
    │    ┌────┴─────┐   │         │
    │    │  压缩    │   │         │
    │    │  清理旧备│   │         │
    │    └────┬─────┘   │         │
    │         │         │         │
    └─────────┴─────────┴─────────┘
              │
              ▼
         ┌─────────┐
         │完成通知 │
         └─────────┘
```

---

## 生产环境蓝绿部署详细流程

```
标签推送 (v1.0.0)
      │
      ▼
┌─────────────┐
│  创建备份   │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 下载新版本  │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 停止旧服务  │  ◄── 蓝 (当前运行)
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 部署新服务  │  ◄── 绿 (新版本)
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 启动服务    │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 健康检查    │
└──────┬──────┘
       │
   ┌───┴───┐
   │       │
   ▼       ▼
┌────┐  ┌──────┐
│成功│  │ 失败 │
└────┘  └───┬──┘
            │
            ▼
       ┌─────────┐
       │ 恢复备份│
       │ 回滚服务│
       └─────────┘
```

---

## 监控与告警流程

```
各个工作流运行
      │
      ▼
┌──────────────┐
│  收集状态    │
└──────┬───────┘
       │
   ┌───┴───┐
   │       │
   ▼       ▼
┌────┐  ┌──────┐
│成功│  │ 失败 │
└─┬──┘  └───┬──┘
  │         │
  │         ▼
  │    ┌─────────┐
  │    │创建Issue│
  │    └────┬────┘
  │         │
  │         ▼
  │    ┌──────────┐
  │    │ 通知团队 │
  │    └──────────┘
  │
  ▼
┌──────────────┐
│  更新徽章    │
└──────────────┘
```

---

## 文件结构

```
.github/
└── workflows/
    ├── cicd.yml              # 主CI/CD工作流
    ├── server-check.yml      # 服务器健康检查
    ├── db-ops.yml            # 数据库操作
    ├── ping-runner.yml       # Runner测试
    ├── secrets.example       # Secrets模板
    ├── README.md             # 详细文档
    ├── QUICKSTART.md         # 快速开始
    ├── BADGES.md             # 徽章配置
    ├── MANIFEST.md           # 文件清单
    └── DIAGRAMS.md           # 流程图 (本文件)
```

---

## 使用场景示例

### 场景 1: 功能开发
```
开发者 → feature分支 → 创建PR
                         │
                         ▼
                    运行 CI (lint + test)
                         │
                     ┌───┴───┐
                     │       │
                     ▼       ▼
                  通过    失败 → 修复
                     │
                     ▼
                 合并到develop
                     │
                     ▼
                自动部署到开发环境
```

### 场景 2: 发布上线
```
develop → release/v1.0.0 → 部署预发布
            │
            │ (测试通过)
            ▼
         合并到main → 打标签v1.0.0
                         │
                         ▼
                    部署到生产
                         │
                         ▼
                    健康检查
                         │
                     ┌───┴───┐
                     │       │
                     ▼       ▼
                   成功   失败→回滚
```

### 场景 3: 紧急修复
```
main → hotfix/critical → 修复
          │
          │ (CI通过)
          ▼
      合并到main → 打标签v1.0.1
          │
          ▼
     快速部署到生产
          │
          ▼
      健康检查 & 通知
```

---

**文档版本：** 1.0.0  
**最后更新：** 2025-10-21
