name: Concurrency DB Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  mysql-concurrency-tests:
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: iam_test
          MYSQL_USER: iam
          MYSQL_PASSWORD: iam_password
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent" --health-interval=5s --health-timeout=5s --health-retries=30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Wait for MySQL to be ready
        run: |
          echo 'Waiting for MySQL to be available...'
          for i in {1..30}; do
            if mysql --host=127.0.0.1 --port=3306 -u iam -piam_password -e 'SELECT 1' >/dev/null 2>&1; then
              echo 'MySQL is ready'
              exit 0
            fi
            sleep 2
          done
          echo 'MySQL did not become ready in time' >&2
          exit 1
        env:
          MYSQL_PWD: iam_password

      - name: Install DB client (mysql)
        run: sudo apt-get update && sudo apt-get install -y default-mysql-client

      - name: Prepare DB schema for tests
        run: |
          mysql --host=127.0.0.1 --port=3306 -u root -proot -e "CREATE DATABASE IF NOT EXISTS iam_test;"

      - name: Run concurrency tests (dev-test-all if available)
        run: |
          set -e
          if command -v make >/dev/null 2>&1 && grep -q "dev-test-all" Makefile; then
            echo "Running make dev-test-all"
            MAKEFLAGS="" make dev-test-all
          else
            echo "Running targeted go tests"
            go test ./internal/apiserver/infra/mysql/... -v -count=1
          fi
        env:
          MYSQL_HOST: 127.0.0.1
          MYSQL_PORT: 3306
          MYSQL_USER: iam
          MYSQL_PASSWORD: iam_password
          MYSQL_DATABASE: iam_test
