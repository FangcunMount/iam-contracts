# å…­è¾¹å½¢æ¶æ„å®è·µ

> ğŸ¯ **æ ¸å¿ƒç»“è®º**: é€šè¿‡ç«¯å£ä¸é€‚é…å™¨æ¨¡å¼å®ç°ä¸šåŠ¡é€»è¾‘ä¸æŠ€æœ¯ç»†èŠ‚çš„è§£è€¦

---

## 1. æ¶æ„æ¦‚è¿°

### 1.1 å…­è¾¹å½¢æ¶æ„å›¾

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                  â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚              Driving Adapters (ä¸»åŠ¨é€‚é…å™¨)            â”‚    â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚    â”‚  â”‚  REST   â”‚  â”‚  gRPC   â”‚  â”‚  Event  â”‚  â”‚   CLI   â”‚ â”‚    â”‚
â”‚    â”‚  â”‚ Handler â”‚  â”‚ Handler â”‚  â”‚ Handler â”‚  â”‚ Command â”‚ â”‚    â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚            â”‚            â”‚            â”‚            â”‚             â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                               â”‚                                  â”‚
â”‚                               â–¼                                  â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚                   Input Ports (è¾“å…¥ç«¯å£)              â”‚    â”‚
â”‚    â”‚            ApplicationService interfaces             â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                               â”‚                                  â”‚
â”‚                               â–¼                                  â”‚
â”‚    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—    â”‚
â”‚    â•‘                    Domain Core                        â•‘    â”‚
â”‚    â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘    â”‚
â”‚    â•‘  â”‚  Entities    â”‚  Value Objects  â”‚  Domain Servicesâ”‚ â•‘    â”‚
â”‚    â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘    â”‚
â”‚    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                               â”‚                                  â”‚
â”‚                               â–¼                                  â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚                  Output Ports (è¾“å‡ºç«¯å£)              â”‚    â”‚
â”‚    â”‚              Repository / Client interfaces           â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                               â”‚                                  â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚            â”‚                  â”‚                  â”‚              â”‚
â”‚            â–¼                  â–¼                  â–¼              â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚             Driven Adapters (è¢«åŠ¨é€‚é…å™¨)              â”‚    â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚    â”‚  â”‚  MySQL  â”‚  â”‚  Redis  â”‚  â”‚  WeChat â”‚  â”‚  Email  â”‚ â”‚    â”‚
â”‚    â”‚  â”‚  Repo   â”‚  â”‚  Cache  â”‚  â”‚   SDK   â”‚  â”‚  Client â”‚ â”‚    â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒåŸåˆ™

| åŸåˆ™ | è¯´æ˜ |
|------|------|
| **ä¾èµ–å€’ç½®** | é¢†åŸŸå±‚ä¸ä¾èµ–åŸºç¡€è®¾æ–½ï¼Œé€šè¿‡ç«¯å£æŠ½è±¡ |
| **ç«¯å£éš”ç¦»** | è¾“å…¥è¾“å‡ºé€šè¿‡ç«¯å£è§£è€¦ |
| **é€‚é…å™¨å¯æ›¿æ¢** | åˆ‡æ¢æŠ€æœ¯æ ˆåªéœ€æ›´æ¢é€‚é…å™¨ |
| **é¢†åŸŸçº¯å‡€** | é¢†åŸŸå±‚åªåŒ…å«ä¸šåŠ¡é€»è¾‘ |

---

## 2. åˆ†å±‚è®¾è®¡

### 2.1 ç›®å½•ç»“æ„

```text
internal/apiserver/
â”œâ”€â”€ domain/                    # é¢†åŸŸå±‚ (æ ¸å¿ƒ)
â”‚   â””â”€â”€ authn/
â”‚       â”œâ”€â”€ entity/            # èšåˆæ ¹ã€å®ä½“
â”‚       â”œâ”€â”€ valueobject/       # å€¼å¯¹è±¡
â”‚       â”œâ”€â”€ service/           # é¢†åŸŸæœåŠ¡
â”‚       â”œâ”€â”€ port/              # ç«¯å£å®šä¹‰
â”‚       â””â”€â”€ event/             # é¢†åŸŸäº‹ä»¶
â”‚
â”œâ”€â”€ application/               # åº”ç”¨å±‚
â”‚   â””â”€â”€ authn/
â”‚       â”œâ”€â”€ login_app_service.go
â”‚       â”œâ”€â”€ dto/               # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚       â””â”€â”€ assembler/         # DTO <-> Domain è½¬æ¢
â”‚
â”œâ”€â”€ infra/                     # åŸºç¡€è®¾æ–½å±‚
â”‚   â””â”€â”€ authn/
â”‚       â”œâ”€â”€ repository/        # ä»“å‚¨å®ç°
â”‚       â”œâ”€â”€ wechat/            # å¾®ä¿¡SDKé€‚é…å™¨
â”‚       â””â”€â”€ redis/             # Redisé€‚é…å™¨
â”‚
â””â”€â”€ interface/                 # æ¥å£å±‚
    â”œâ”€â”€ rest/                  # REST Handler
    â””â”€â”€ grpc/                  # gRPC Handler
```

### 2.2 å±‚æ¬¡ä¾èµ–

```mermaid
graph TB
    subgraph "ä¾èµ–æ–¹å‘ (ç”±å¤–å‘å†…)"
        I[Interface æ¥å£å±‚]
        A[Application åº”ç”¨å±‚]
        D[Domain é¢†åŸŸå±‚]
        INF[Infra åŸºç¡€è®¾æ–½å±‚]
    end
    
    I --> A
    A --> D
    INF --> D
    
    style D fill:#f9f,stroke:#333,stroke-width:2px
```

---

## 3. ç«¯å£è®¾è®¡

### 3.1 è¾“å…¥ç«¯å£ (Driving Ports)

```go
// ä¼ªä»£ç : åº”ç”¨æœåŠ¡æ¥å£ä½œä¸ºè¾“å…¥ç«¯å£
// æºç : internal/apiserver/application/authn/login_app_service.go

// è¾“å…¥ç«¯å£: å®šä¹‰åº”ç”¨å¯ä»¥åšä»€ä¹ˆ
type LoginAppService interface {
    // å¾®ä¿¡ç™»å½•
    WeChatLogin(ctx context.Context, req WeChatLoginRequest) (*TokenPair, error)
    
    // å¯†ç ç™»å½•
    PasswordLogin(ctx context.Context, req PasswordLoginRequest) (*TokenPair, error)
    
    // Token åˆ·æ–°
    RefreshToken(ctx context.Context, refreshToken string) (*TokenPair, error)
    
    // ç™»å‡º
    Logout(ctx context.Context, accessToken string) error
}

// DTO: è¯·æ±‚æ•°æ®
type WeChatLoginRequest struct {
    Code     string `json:"code"`
    DeviceID string `json:"device_id"`
}
```

### 3.2 è¾“å‡ºç«¯å£ (Driven Ports)

```go
// ä¼ªä»£ç : ä»“å‚¨ç«¯å£ (ç”±é¢†åŸŸå±‚å®šä¹‰)
// æºç : internal/apiserver/domain/authn/port/repository.go

// è¾“å‡ºç«¯å£: å®šä¹‰é¢†åŸŸéœ€è¦ä»€ä¹ˆ
type AccountRepository interface {
    FindByID(ctx context.Context, id AccountID) (*Account, error)
    FindByCredential(ctx context.Context, credType CredentialType, identifier string) (*Account, error)
    Save(ctx context.Context, account *Account) error
}

// è¾“å‡ºç«¯å£: å¤–éƒ¨æœåŠ¡
type WeChatClient interface {
    Code2Session(ctx context.Context, code string) (*WeChatSession, error)
}

// è¾“å‡ºç«¯å£: ç¼“å­˜
type SessionCache interface {
    Get(ctx context.Context, sessionID string) (*Session, error)
    Set(ctx context.Context, session *Session, ttl time.Duration) error
    Delete(ctx context.Context, sessionID string) error
}
```

---

## 4. é€‚é…å™¨å®ç°

### 4.1 é©±åŠ¨é€‚é…å™¨ (REST Handler)

```go
// ä¼ªä»£ç : REST é€‚é…å™¨
// æºç : internal/apiserver/interface/rest/auth_handler.go

type AuthHandler struct {
    loginService LoginAppService  // ä¾èµ–è¾“å…¥ç«¯å£
}

func NewAuthHandler(loginService LoginAppService) *AuthHandler {
    return &AuthHandler{loginService: loginService}
}

// é€‚é… HTTP è¯·æ±‚åˆ°åº”ç”¨æœåŠ¡
func (h *AuthHandler) WeChatLogin(c *gin.Context) {
    // 1. è§£æ HTTP è¯·æ±‚
    var req WeChatLoginRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        c.JSON(400, gin.H{"error": "invalid request"})
        return
    }
    
    // 2. è°ƒç”¨åº”ç”¨æœåŠ¡ (è¾“å…¥ç«¯å£)
    result, err := h.loginService.WeChatLogin(c.Request.Context(), req)
    if err != nil {
        c.JSON(500, gin.H{"error": err.Error()})
        return
    }
    
    // 3. è¿”å› HTTP å“åº”
    c.JSON(200, result)
}

// è·¯ç”±æ³¨å†Œ
func (h *AuthHandler) RegisterRoutes(r *gin.RouterGroup) {
    auth := r.Group("/auth")
    auth.POST("/wechat/login", h.WeChatLogin)
    auth.POST("/password/login", h.PasswordLogin)
    auth.POST("/token/refresh", h.RefreshToken)
    auth.POST("/logout", h.Logout)
}
```

### 4.2 è¢«é©±åŠ¨é€‚é…å™¨ (MySQL Repository)

```go
// ä¼ªä»£ç : MySQL ä»“å‚¨é€‚é…å™¨
// æºç : internal/apiserver/infra/authn/repository/account_repository.go

type MySQLAccountRepository struct {
    db *gorm.DB
}

// å®ç°è¾“å‡ºç«¯å£
func NewMySQLAccountRepository(db *gorm.DB) *MySQLAccountRepository {
    return &MySQLAccountRepository{db: db}
}

func (r *MySQLAccountRepository) FindByID(ctx context.Context, id AccountID) (*Account, error) {
    var po AccountPO
    if err := r.db.WithContext(ctx).Where("id = ?", id).First(&po).Error; err != nil {
        if errors.Is(err, gorm.ErrRecordNotFound) {
            return nil, ErrAccountNotFound
        }
        return nil, err
    }
    return po.ToDomain(), nil
}

func (r *MySQLAccountRepository) Save(ctx context.Context, account *Account) error {
    po := NewAccountPO(account)
    return r.db.WithContext(ctx).Save(po).Error
}

// PO: æŒä¹…åŒ–å¯¹è±¡ (æ•°æ®åº“æ¨¡å‹)
type AccountPO struct {
    ID        string    `gorm:"primaryKey"`
    UserID    string    `gorm:"index"`
    Status    string
    CreatedAt time.Time
    UpdatedAt time.Time
}

// PO <-> Domain è½¬æ¢
func (po *AccountPO) ToDomain() *Account {
    return &Account{
        ID:        AccountID(po.ID),
        UserID:    UserID(po.UserID),
        Status:    AccountStatus(po.Status),
        CreatedAt: po.CreatedAt,
        UpdatedAt: po.UpdatedAt,
    }
}
```

### 4.3 è¢«é©±åŠ¨é€‚é…å™¨ (å¾®ä¿¡ SDK)

```go
// ä¼ªä»£ç : å¾®ä¿¡ SDK é€‚é…å™¨
// æºç : internal/apiserver/infra/authn/wechat/client.go

type WeChatClientImpl struct {
    appID     string
    appSecret string
    httpClient *http.Client
}

// å®ç°è¾“å‡ºç«¯å£
func NewWeChatClient(appID, appSecret string) *WeChatClientImpl {
    return &WeChatClientImpl{
        appID:     appID,
        appSecret: appSecret,
        httpClient: &http.Client{Timeout: 10 * time.Second},
    }
}

func (c *WeChatClientImpl) Code2Session(ctx context.Context, code string) (*WeChatSession, error) {
    url := fmt.Sprintf(
        "https://api.weixin.qq.com/sns/jscode2session?appid=%s&secret=%s&js_code=%s&grant_type=authorization_code",
        c.appID, c.appSecret, code,
    )
    
    resp, err := c.httpClient.Get(url)
    if err != nil {
        return nil, err
    }
    defer resp.Body.Close()
    
    var result struct {
        OpenID     string `json:"openid"`
        UnionID    string `json:"unionid"`
        SessionKey string `json:"session_key"`
        ErrCode    int    `json:"errcode"`
        ErrMsg     string `json:"errmsg"`
    }
    
    if err := json.NewDecoder(resp.Body).Decode(&result); err != nil {
        return nil, err
    }
    
    if result.ErrCode != 0 {
        return nil, fmt.Errorf("wechat error: %s", result.ErrMsg)
    }
    
    return &WeChatSession{
        OpenID:     result.OpenID,
        UnionID:    result.UnionID,
        SessionKey: result.SessionKey,
    }, nil
}
```

---

## 5. ä¾èµ–æ³¨å…¥

### 5.1 å®¹å™¨é…ç½®

```go
// ä¼ªä»£ç : ä¾èµ–æ³¨å…¥å®¹å™¨
// æºç : internal/apiserver/container/container.go

type Container struct {
    // åŸºç¡€è®¾æ–½
    DB    *gorm.DB
    Redis *redis.Client
    
    // ä»“å‚¨
    AccountRepo  port.AccountRepository
    SessionRepo  port.SessionRepository
    
    // å¤–éƒ¨æœåŠ¡
    WeChatClient port.WeChatClient
    
    // é¢†åŸŸæœåŠ¡
    AuthService *service.AuthenticationService
    TokenService *service.TokenService
    
    // åº”ç”¨æœåŠ¡
    LoginAppService application.LoginAppService
}

func NewContainer(cfg *config.Config) *Container {
    c := &Container{}
    
    // åˆå§‹åŒ–åŸºç¡€è®¾æ–½
    c.DB = database.NewGorm(cfg.Database)
    c.Redis = cache.NewRedis(cfg.Redis)
    
    // åˆå§‹åŒ–é€‚é…å™¨ (å®ç°ç«¯å£)
    c.AccountRepo = repository.NewMySQLAccountRepository(c.DB)
    c.SessionRepo = repository.NewRedisSessionRepository(c.Redis)
    c.WeChatClient = wechat.NewWeChatClient(cfg.WeChat.AppID, cfg.WeChat.Secret)
    
    // åˆå§‹åŒ–é¢†åŸŸæœåŠ¡
    c.AuthService = service.NewAuthenticationService(c.AccountRepo, c.WeChatClient)
    c.TokenService = service.NewTokenService(cfg.JWT)
    
    // åˆå§‹åŒ–åº”ç”¨æœåŠ¡
    c.LoginAppService = application.NewLoginAppService(c.AuthService, c.TokenService, c.SessionRepo)
    
    return c
}
```

### 5.2 Handler æ³¨å†Œ

```go
// ä¼ªä»£ç : è·¯ç”±æ³¨å†Œ
// æºç : internal/apiserver/routers.go

func SetupRouters(container *Container) *gin.Engine {
    r := gin.Default()
    
    // åˆ›å»º Handler (æ³¨å…¥åº”ç”¨æœåŠ¡)
    authHandler := rest.NewAuthHandler(container.LoginAppService)
    userHandler := rest.NewUserHandler(container.UserAppService)
    
    // æ³¨å†Œè·¯ç”±
    api := r.Group("/api/v1")
    authHandler.RegisterRoutes(api)
    userHandler.RegisterRoutes(api)
    
    return r
}
```

---

## 6. æµ‹è¯•ç­–ç•¥

### 6.1 åˆ†å±‚æµ‹è¯•

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æµ‹è¯•é‡‘å­—å¡”                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚                    â”‚   E2E Test   â”‚  å°‘é‡                   â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚               â”‚  Integration Test   â”‚  é€‚é‡                 â”‚
â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚         â”‚         Unit Test               â”‚  å¤§é‡           â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                              â”‚
â”‚  Unit Test:        é¢†åŸŸé€»è¾‘ã€å€¼å¯¹è±¡éªŒè¯                      â”‚
â”‚  Integration Test: åº”ç”¨æœåŠ¡ + Mock é€‚é…å™¨                   â”‚
â”‚  E2E Test:         å®Œæ•´ HTTP è¯·æ±‚                           â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 Mock ç«¯å£

```go
// ä¼ªä»£ç : Mock ä»“å‚¨
// æºç : internal/apiserver/domain/authn/port/repository_mock.go

type MockAccountRepository struct {
    accounts map[string]*Account
}

func NewMockAccountRepository() *MockAccountRepository {
    return &MockAccountRepository{
        accounts: make(map[string]*Account),
    }
}

func (r *MockAccountRepository) FindByID(ctx context.Context, id AccountID) (*Account, error) {
    if account, ok := r.accounts[string(id)]; ok {
        return account, nil
    }
    return nil, ErrAccountNotFound
}

func (r *MockAccountRepository) Save(ctx context.Context, account *Account) error {
    r.accounts[string(account.ID)] = account
    return nil
}
```

---

## 7. æºç ç´¢å¼•

| ç»„ä»¶ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| **ç«¯å£å®šä¹‰** | | |
| Repository Port | `domain/*/port/repository.go` | ä»“å‚¨ç«¯å£ |
| Client Port | `domain/*/port/*_client.go` | å¤–éƒ¨æœåŠ¡ç«¯å£ |
| **é©±åŠ¨é€‚é…å™¨** | | |
| REST Handler | `interface/rest/*.go` | HTTP é€‚é…å™¨ |
| gRPC Handler | `interface/grpc/*.go` | gRPC é€‚é…å™¨ |
| **è¢«é©±åŠ¨é€‚é…å™¨** | | |
| MySQL Repository | `infra/*/repository/*.go` | MySQL å®ç° |
| Redis | `infra/*/redis/*.go` | Redis é€‚é…å™¨ï¼ˆç¼“å­˜ã€ä»¤ç‰Œç­‰ï¼‰ |
| WeChat Client | `infra/authn/wechat/*.go` | å¾®ä¿¡ SDK |
| **ä¾èµ–æ³¨å…¥** | | |
| Container | `container/container.go` | DI å®¹å™¨ |
