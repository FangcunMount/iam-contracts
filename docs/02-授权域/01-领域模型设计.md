# æˆæƒåŸŸé¢†åŸŸæ¨¡å‹è®¾è®¡

> ğŸ¯ **æ ¸å¿ƒç»“è®º**: é‡‡ç”¨ Role èšåˆæ ¹ç®¡ç†æƒé™åˆ†é…ï¼ŒPolicy ä½œä¸º Casbin ç­–ç•¥çš„é¢†åŸŸå°è£…

---

## 1. è®¾è®¡æ¦‚è¿°

### 1.1 é¢†åŸŸè¾¹ç•Œ

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æˆæƒåŸŸ (Authz)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  èŒè´£: æƒé™æ£€æŸ¥ã€ç­–ç•¥ç®¡ç†ã€è§’è‰²ç®¡ç†ã€èµ„æºæ³¨å†Œ                â”‚
â”‚  ä¸è´Ÿè´£: ç”¨æˆ·ç®¡ç†ã€èº«ä»½è®¤è¯                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 èšåˆåˆ’åˆ†

| èšåˆ | èšåˆæ ¹ | èŒè´£ |
|------|--------|------|
| è§’è‰²èšåˆ | Role | ç®¡ç†è§’è‰²å®šä¹‰ä¸æƒé™é›†åˆ |
| èµ„æºèšåˆ | Resource | ç®¡ç†å¯æˆæƒèµ„æºå®šä¹‰ |

---

## 2. é¢†åŸŸæ¨¡å‹

### 2.1 èšåˆå…³ç³»å›¾

```mermaid
classDiagram
    class Role {
        +RoleID id
        +String name
        +String code
        +String description
        +List~Permission~ permissions
        +RoleStatus status
        +AddPermission(perm)
        +RemovePermission(perm)
        +HasPermission(resource, action)
    }
    
    class Permission {
        +ResourceCode resource
        +Action action
        +String effect
    }
    
    class Resource {
        +ResourceID id
        +String code
        +String name
        +List~Action~ actions
        +ResourceType type
    }
    
    class Policy {
        +String subject
        +String object
        +String action
        +String effect
    }
    
    class Action {
        <<enumeration>>
        READ
        WRITE
        DELETE
        ADMIN
    }
    
    Role "1" --> "*" Permission : contains
    Permission "*" --> "1" Resource : references
    Permission --> Action : uses
    Role ..> Policy : generates
```

### 2.2 Role èšåˆæ ¹

```go
// ä¼ªä»£ç : Role èšåˆæ ¹
// æºç : internal/apiserver/domain/authz/entity/role.go

type Role struct {
    ID          RoleID        // è§’è‰²å”¯ä¸€æ ‡è¯†
    Name        string        // è§’è‰²åç§° (æ˜¾ç¤ºç”¨)
    Code        string        // è§’è‰²ä»£ç  (admin, guardian)
    Description string        // è§’è‰²æè¿°
    Permissions []Permission  // æƒé™åˆ—è¡¨
    Status      RoleStatus    // è§’è‰²çŠ¶æ€
    CreatedAt   time.Time
    UpdatedAt   time.Time
}

// æ·»åŠ æƒé™
func (r *Role) AddPermission(perm Permission) error {
    // ä¸šåŠ¡è§„åˆ™: åŒä¸€èµ„æº+æ“ä½œä¸èƒ½é‡å¤
    if r.hasPermission(perm.Resource, perm.Action) {
        return ErrPermissionExists
    }
    r.Permissions = append(r.Permissions, perm)
    return nil
}

// æ£€æŸ¥æƒé™
func (r *Role) HasPermission(resource ResourceCode, action Action) bool {
    for _, p := range r.Permissions {
        if p.Resource == resource && p.Action == action {
            return true
        }
    }
    return false
}

// ç”Ÿæˆ Casbin ç­–ç•¥
func (r *Role) ToPolicies() []Policy {
    policies := make([]Policy, 0, len(r.Permissions))
    for _, p := range r.Permissions {
        policies = append(policies, Policy{
            Subject: r.Code,
            Object:  string(p.Resource),
            Action:  string(p.Action),
            Effect:  "allow",
        })
    }
    return policies
}
```

### 2.3 Permission å€¼å¯¹è±¡

```go
// ä¼ªä»£ç : Permission å€¼å¯¹è±¡
// æºç : internal/apiserver/domain/authz/valueobject/permission.go

type Permission struct {
    Resource ResourceCode  // èµ„æºä»£ç 
    Action   Action        // æ“ä½œç±»å‹
    Effect   string        // allow/deny
}

type Action string

const (
    ActionRead   Action = "read"
    ActionWrite  Action = "write"
    ActionDelete Action = "delete"
    ActionAdmin  Action = "admin"
)

// æƒé™å­—ç¬¦ä¸²è¡¨ç¤º
func (p *Permission) String() string {
    return fmt.Sprintf("%s:%s", p.Resource, p.Action)
}
```

### 2.4 Resource å®ä½“

```go
// ä¼ªä»£ç : Resource å®ä½“
// æºç : internal/apiserver/domain/authz/entity/resource.go

type Resource struct {
    ID      ResourceID     // èµ„æºID
    Code    ResourceCode   // èµ„æºä»£ç  (user, child, report)
    Name    string         // èµ„æºåç§°
    Actions []Action       // å¯ç”¨æ“ä½œåˆ—è¡¨
    Type    ResourceType   // èµ„æºç±»å‹
}

type ResourceType string

const (
    ResourceTypeAPI  ResourceType = "api"   // API èµ„æº
    ResourceTypeData ResourceType = "data"  // æ•°æ®èµ„æº
    ResourceTypeMenu ResourceType = "menu"  // èœå•èµ„æº
)

// é¢„å®šä¹‰èµ„æº
var PredefinedResources = []Resource{
    {Code: "user", Name: "ç”¨æˆ·ç®¡ç†", Actions: []Action{ActionRead, ActionWrite, ActionDelete}},
    {Code: "child", Name: "å„¿ç«¥æ¡£æ¡ˆ", Actions: []Action{ActionRead, ActionWrite, ActionDelete}},
    {Code: "report", Name: "æµ‹è¯„æŠ¥å‘Š", Actions: []Action{ActionRead}},
    {Code: "role", Name: "è§’è‰²ç®¡ç†", Actions: []Action{ActionRead, ActionWrite, ActionDelete, ActionAdmin}},
}
```

### 2.5 Policy å€¼å¯¹è±¡

```go
// ä¼ªä»£ç : Policy å€¼å¯¹è±¡ (Casbin ç­–ç•¥å°è£…)
// æºç : internal/apiserver/domain/authz/valueobject/policy.go

type Policy struct {
    Subject string  // ä¸»ä½“ (è§’è‰²ä»£ç æˆ–ç”¨æˆ·ID)
    Object  string  // å¯¹è±¡ (èµ„æºä»£ç )
    Action  string  // æ“ä½œ
    Effect  string  // æ•ˆæœ (allow/deny)
}

// è½¬æ¢ä¸º Casbin æ ¼å¼
func (p *Policy) ToCasbinPolicy() []string {
    return []string{p.Subject, p.Object, p.Action}
}

// ä» Casbin æ ¼å¼åˆ›å»º
func PolicyFromCasbin(rule []string) Policy {
    return Policy{
        Subject: rule[0],
        Object:  rule[1],
        Action:  rule[2],
        Effect:  "allow",
    }
}
```

---

## 3. é¢†åŸŸæœåŠ¡

### 3.1 æœåŠ¡åˆ’åˆ†

```mermaid
graph TB
    subgraph "é¢†åŸŸæœåŠ¡"
        ES[EnforcerService<br/>æƒé™å†³ç­–]
        PS[PolicyService<br/>ç­–ç•¥ç®¡ç†]
        RS[RoleService<br/>è§’è‰²ç®¡ç†]
    end
    
    subgraph "èšåˆ"
        Role[Role]
        Resource[Resource]
    end
    
    subgraph "å¤–éƒ¨"
        Casbin[Casbinå¼•æ“]
        Cache[Redisç¼“å­˜]
    end
    
    ES --> Casbin
    ES --> Cache
    PS --> Role
    RS --> Role
    RS --> Resource
```

### 3.2 EnforcerService

```go
// ä¼ªä»£ç : æƒé™å†³ç­–æœåŠ¡
// æºç : internal/apiserver/domain/authz/service/enforcer_service.go

type EnforcerService struct {
    enforcer *casbin.Enforcer
    cache    PolicyCache
}

// æƒé™æ£€æŸ¥
func (s *EnforcerService) Enforce(ctx context.Context, req EnforceRequest) (bool, error) {
    // 1. å°è¯•ä»ç¼“å­˜è·å–
    if result, found := s.cache.Get(req.CacheKey()); found {
        return result, nil
    }
    
    // 2. Casbin å†³ç­–
    allowed, err := s.enforcer.Enforce(req.Subject, req.Object, req.Action)
    if err != nil {
        return false, err
    }
    
    // 3. ç¼“å­˜ç»“æœ
    s.cache.Set(req.CacheKey(), allowed, 5*time.Minute)
    
    return allowed, nil
}

type EnforceRequest struct {
    Subject string  // ç”¨æˆ·ID æˆ– è§’è‰²ä»£ç 
    Object  string  // èµ„æºä»£ç 
    Action  string  // æ“ä½œ
}
```

### 3.3 PolicyService

```go
// ä¼ªä»£ç : ç­–ç•¥ç®¡ç†æœåŠ¡
// æºç : internal/apiserver/domain/authz/service/policy_service.go

type PolicyService struct {
    roleRepo   RoleRepository
    enforcer   *casbin.Enforcer
    eventBus   EventBus
}

// æ·»åŠ ç­–ç•¥
func (s *PolicyService) AddPolicy(ctx context.Context, roleCode string, perm Permission) error {
    // 1. è·å–è§’è‰²
    role, err := s.roleRepo.FindByCode(ctx, roleCode)
    if err != nil {
        return err
    }
    
    // 2. æ·»åŠ æƒé™åˆ°è§’è‰²
    if err := role.AddPermission(perm); err != nil {
        return err
    }
    
    // 3. æŒä¹…åŒ–
    if err := s.roleRepo.Save(ctx, role); err != nil {
        return err
    }
    
    // 4. åŒæ­¥åˆ° Casbin
    policy := Policy{Subject: roleCode, Object: string(perm.Resource), Action: string(perm.Action)}
    s.enforcer.AddPolicy(policy.ToCasbinPolicy()...)
    
    // 5. å‘å¸ƒäº‹ä»¶
    s.eventBus.Publish(PolicyChangedEvent{
        Type:   PolicyAdded,
        Policy: policy,
    })
    
    return nil
}
```

---

## 4. ç«¯å£å®šä¹‰

### 4.1 ä»“å‚¨ç«¯å£

```go
// ä¼ªä»£ç : ä»“å‚¨ç«¯å£
// æºç : internal/apiserver/domain/authz/port/repository.go

type RoleRepository interface {
    FindByID(ctx context.Context, id RoleID) (*Role, error)
    FindByCode(ctx context.Context, code string) (*Role, error)
    FindAll(ctx context.Context) ([]*Role, error)
    Save(ctx context.Context, role *Role) error
    Delete(ctx context.Context, id RoleID) error
}

type ResourceRepository interface {
    FindByCode(ctx context.Context, code ResourceCode) (*Resource, error)
    FindAll(ctx context.Context) ([]*Resource, error)
    Save(ctx context.Context, resource *Resource) error
}
```

### 4.2 ç¼“å­˜ç«¯å£

```go
// ä¼ªä»£ç : ç¼“å­˜ç«¯å£
// æºç : internal/apiserver/domain/authz/port/cache.go

type PolicyCache interface {
    Get(key string) (bool, bool)  // result, found
    Set(key string, result bool, ttl time.Duration)
    Invalidate(pattern string) error
    InvalidateAll() error
}
```

---

## 5. é¢„å®šä¹‰è§’è‰²

```yaml
# ç§å­æ•°æ®
# æºç : configs/seeddata.yaml

roles:
  - code: super_admin
    name: è¶…çº§ç®¡ç†å‘˜
    permissions:
      - resource: "*"
        action: "*"
        
  - code: admin
    name: ç®¡ç†å‘˜
    permissions:
      - resource: user
        action: [read, write]
      - resource: child
        action: [read, write]
      - resource: report
        action: read
        
  - code: guardian
    name: ç›‘æŠ¤äºº
    permissions:
      - resource: child
        action: read      # åªèƒ½æŸ¥çœ‹è‡ªå·±çš„å„¿ç«¥
      - resource: report
        action: read      # åªèƒ½æŸ¥çœ‹è‡ªå·±å„¿ç«¥çš„æŠ¥å‘Š
        
  - code: staff
    name: å·¥ä½œäººå‘˜
    permissions:
      - resource: report
        action: read
```

---

## 6. æºç ç´¢å¼•

| ç»„ä»¶ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| **èšåˆæ ¹** | | |
| Role | `domain/authz/entity/role.go` | è§’è‰²èšåˆæ ¹ |
| Resource | `domain/authz/entity/resource.go` | èµ„æºå®ä½“ |
| **å€¼å¯¹è±¡** | | |
| Permission | `domain/authz/valueobject/permission.go` | æƒé™å€¼å¯¹è±¡ |
| Policy | `domain/authz/valueobject/policy.go` | ç­–ç•¥å€¼å¯¹è±¡ |
| Action | `domain/authz/valueobject/action.go` | æ“ä½œæšä¸¾ |
| **é¢†åŸŸæœåŠ¡** | | |
| EnforcerService | `domain/authz/service/enforcer_service.go` | æƒé™å†³ç­– |
| PolicyService | `domain/authz/service/policy_service.go` | ç­–ç•¥ç®¡ç† |
| **ç«¯å£** | | |
| RoleRepository | `domain/authz/port/repository.go` | è§’è‰²ä»“å‚¨ |
| PolicyCache | `domain/authz/port/cache.go` | ç­–ç•¥ç¼“å­˜ |
