# æƒé™å†³ç­–æµç¨‹è®¾è®¡

> ğŸ¯ **æ ¸å¿ƒç»“è®º**: é‡‡ç”¨ Casbin ä½œä¸ºç­–ç•¥å¼•æ“ï¼Œç»“åˆ Redis ç¼“å­˜å®ç°é«˜æ€§èƒ½æƒé™å†³ç­–

---

## 1. è®¾è®¡æ¦‚è¿°

### 1.1 å†³ç­–æµç¨‹æ€»è§ˆ

```mermaid
flowchart TB
    REQ[è¯·æ±‚] --> MW[è®¤è¯ä¸­é—´ä»¶]
    MW --> PARSE[è§£æ Token]
    PARSE --> EXTRACT[æå–ç”¨æˆ·/è§’è‰²]
    EXTRACT --> CHECK{æƒé™æ£€æŸ¥}
    
    CHECK --> CACHE{ç¼“å­˜å‘½ä¸­?}
    CACHE -->|æ˜¯| RESULT[è¿”å›ç»“æœ]
    CACHE -->|å¦| CASBIN[Casbin å†³ç­–]
    CASBIN --> CACHE_SET[ç¼“å­˜ç»“æœ]
    CACHE_SET --> RESULT
    
    RESULT -->|å…è®¸| NEXT[ç»§ç»­å¤„ç†]
    RESULT -->|æ‹’ç»| DENY[403 Forbidden]
```

### 1.2 è®¾è®¡ç›®æ ‡

| ç›®æ ‡ | æ–¹æ¡ˆ |
|------|------|
| **é«˜æ€§èƒ½** | Redis ç¼“å­˜ï¼Œå‡å°‘ Casbin è°ƒç”¨ |
| **çµæ´»æ€§** | RBAC æ¨¡å‹ï¼Œæ”¯æŒèµ„æºçº§æƒé™ |
| **å¯æ‰©å±•** | ç­–ç•¥å¯åŠ¨æ€æ›´æ–°ï¼Œæ— éœ€é‡å¯ |
| **ä¸€è‡´æ€§** | äº‹ä»¶é©±åŠ¨åŒæ­¥ï¼Œå¤šå®ä¾‹ä¸€è‡´ |

---

## 2. Casbin é›†æˆ

### 2.1 Model å®šä¹‰

```text
# Casbin Model
# æºç : configs/casbin_model.conf

[request_definition]
r = sub, obj, act

[policy_definition]
p = sub, obj, act

[role_definition]
g = _, _

[policy_effect]
e = some(where (p.eft == allow))

[matchers]
m = g(r.sub, p.sub) && keyMatch2(r.obj, p.obj) && r.act == p.act
```

**è¯´æ˜:**

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [request_definition] r = sub, obj, act                      â”‚
â”‚  è¯·æ±‚æ ¼å¼: è°(sub) å¯¹ä»€ä¹ˆ(obj) åšä»€ä¹ˆ(act)                   â”‚
â”‚  ç¤ºä¾‹: user_123, /users/456, read                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [policy_definition] p = sub, obj, act                       â”‚
â”‚  ç­–ç•¥æ ¼å¼: è§’è‰²(sub) å¯ä»¥å¯¹èµ„æº(obj) æ‰§è¡Œæ“ä½œ(act)           â”‚
â”‚  ç¤ºä¾‹: admin, /users/*, write                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [role_definition] g = _, _                                  â”‚
â”‚  è§’è‰²ç»§æ‰¿: ç”¨æˆ· -> è§’è‰² çš„æ˜ å°„                               â”‚
â”‚  ç¤ºä¾‹: user_123, admin                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [matchers]                                                  â”‚
â”‚  åŒ¹é…è§„åˆ™: æ£€æŸ¥ç”¨æˆ·è§’è‰² + èµ„æºåŒ¹é… + æ“ä½œåŒ¹é…                â”‚
â”‚  keyMatch2 æ”¯æŒé€šé…ç¬¦: /users/* åŒ¹é… /users/123              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ç­–ç•¥ç¤ºä¾‹

```csv
# ç­–ç•¥æ•°æ® (p = ç­–ç•¥, g = è§’è‰²æ˜ å°„)
# æºç : configs/policy.csv

# è§’è‰²ç­–ç•¥
p, admin, user, read
p, admin, user, write
p, admin, child, read
p, admin, child, write
p, guardian, child, read
p, guardian, report, read

# ç”¨æˆ·-è§’è‰²æ˜ å°„
g, user_001, admin
g, user_002, guardian
g, user_003, guardian
```

---

## 3. å†³ç­–æµç¨‹è¯¦è§£

### 3.1 æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant GW as APIç½‘å…³
    participant MW as AuthMiddleware
    participant Cache as Redis
    participant Enforcer as Casbin
    participant DB as MySQL
    
    Client->>GW: GET /users/123 + Token
    GW->>MW: è½¬å‘è¯·æ±‚
    
    MW->>MW: è§£æ JWT Token
    MW->>MW: æå– user_id, roles
    
    MW->>Cache: GET authz:user_001:user:read
    
    alt ç¼“å­˜å‘½ä¸­
        Cache-->>MW: allow/deny
    else ç¼“å­˜æœªå‘½ä¸­
        MW->>Enforcer: Enforce(user_001, user, read)
        Enforcer->>Enforcer: æŸ¥æ‰¾è§’è‰²æ˜ å°„
        Enforcer->>Enforcer: åŒ¹é…ç­–ç•¥
        Enforcer-->>MW: allow
        MW->>Cache: SET authz:user_001:user:read = allow (TTL: 5m)
    end
    
    alt å…è®¸
        MW->>GW: ç»§ç»­å¤„ç†
        GW-->>Client: 200 OK
    else æ‹’ç»
        MW-->>Client: 403 Forbidden
    end
```

### 3.2 æ ¸å¿ƒå®ç°

```go
// ä¼ªä»£ç : æƒé™ä¸­é—´ä»¶
// æºç : internal/apiserver/infra/middleware/authz.go

type AuthzMiddleware struct {
    enforcer EnforcerService
    extractor ResourceExtractor
}

func (m *AuthzMiddleware) Handle() gin.HandlerFunc {
    return func(c *gin.Context) {
        // 1. è·å–ç”¨æˆ·ä¿¡æ¯ (ç”±è®¤è¯ä¸­é—´ä»¶è®¾ç½®)
        userID := c.GetString("user_id")
        roles := c.GetStringSlice("roles")
        
        // 2. æå–èµ„æºå’Œæ“ä½œ
        resource := m.extractor.ExtractResource(c.Request)
        action := m.extractor.ExtractAction(c.Request.Method)
        
        // 3. æƒé™æ£€æŸ¥
        allowed, err := m.enforcer.Enforce(c.Request.Context(), EnforceRequest{
            Subject: userID,
            Object:  resource,
            Action:  action,
        })
        
        if err != nil || !allowed {
            c.AbortWithStatusJSON(403, gin.H{"error": "forbidden"})
            return
        }
        
        c.Next()
    }
}
```

### 3.3 èµ„æºæå–

```go
// ä¼ªä»£ç : èµ„æºæå–å™¨
// æºç : internal/apiserver/infra/middleware/resource_extractor.go

type ResourceExtractor struct {
    routes map[string]string  // è·¯ç”± -> èµ„æºæ˜ å°„
}

// ä»è¯·æ±‚ä¸­æå–èµ„æº
func (e *ResourceExtractor) ExtractResource(r *http.Request) string {
    // æ–¹æ¡ˆ1: è·¯ç”±å‰ç¼€æ˜ å°„
    // /users/* -> user
    // /children/* -> child
    
    path := r.URL.Path
    for pattern, resource := range e.routes {
        if matchPath(pattern, path) {
            return resource
        }
    }
    return "unknown"
}

// ä» HTTP æ–¹æ³•æå–æ“ä½œ
func (e *ResourceExtractor) ExtractAction(method string) string {
    switch method {
    case "GET":
        return "read"
    case "POST", "PUT", "PATCH":
        return "write"
    case "DELETE":
        return "delete"
    default:
        return "unknown"
    }
}

// è·¯ç”±-èµ„æºæ˜ å°„é…ç½®
var ResourceRoutes = map[string]string{
    "/api/v1/users/*":    "user",
    "/api/v1/children/*": "child",
    "/api/v1/reports/*":  "report",
    "/api/v1/roles/*":    "role",
}
```

---

## 4. ç¼“å­˜ç­–ç•¥

### 4.1 ç¼“å­˜ç»“æ„

```text
Redis Key è®¾è®¡:

authz:{subject}:{object}:{action}
â”œâ”€â”€ å€¼: "1" (å…è®¸) / "0" (æ‹’ç»)
â””â”€â”€ TTL: 5 åˆ†é’Ÿ

ç¤ºä¾‹:
authz:user_001:user:read = "1"
authz:user_001:child:delete = "0"
```

### 4.2 ç¼“å­˜å®ç°

```go
// ä¼ªä»£ç : æƒé™ç¼“å­˜
// æºç : internal/apiserver/infra/authz/redis_cache.go

type RedisAuthzCache struct {
    client *redis.Client
    ttl    time.Duration
}

func (c *RedisAuthzCache) Get(subject, object, action string) (bool, bool) {
    key := fmt.Sprintf("authz:%s:%s:%s", subject, object, action)
    val, err := c.client.Get(ctx, key).Result()
    if err == redis.Nil {
        return false, false  // æœªæ‰¾åˆ°
    }
    return val == "1", true
}

func (c *RedisAuthzCache) Set(subject, object, action string, allowed bool) {
    key := fmt.Sprintf("authz:%s:%s:%s", subject, object, action)
    val := "0"
    if allowed {
        val = "1"
    }
    c.client.Set(ctx, key, val, c.ttl)
}

// å¤±æ•ˆæŒ‡å®šç”¨æˆ·çš„æ‰€æœ‰ç¼“å­˜
func (c *RedisAuthzCache) InvalidateUser(subject string) {
    pattern := fmt.Sprintf("authz:%s:*", subject)
    keys, _ := c.client.Keys(ctx, pattern).Result()
    if len(keys) > 0 {
        c.client.Del(ctx, keys...)
    }
}
```

### 4.3 ç¼“å­˜å¤±æ•ˆæ—¶æœº

| æ—¶æœº | å¤±æ•ˆèŒƒå›´ |
|------|---------|
| è§’è‰²å˜æ›´ | è¯¥è§’è‰²ä¸‹æ‰€æœ‰ç”¨æˆ·ç¼“å­˜ |
| ç­–ç•¥å˜æ›´ | ç›¸å…³èµ„æºçš„æ‰€æœ‰ç¼“å­˜ |
| ç”¨æˆ·è§’è‰²å˜æ›´ | è¯¥ç”¨æˆ·çš„æ‰€æœ‰ç¼“å­˜ |
| å®šæ—¶è¿‡æœŸ | è‡ªåŠ¨è¿‡æœŸ (TTL: 5åˆ†é’Ÿ) |

---

## 5. å¤šçº§æƒé™æ£€æŸ¥

### 5.1 æ£€æŸ¥å±‚æ¬¡

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æƒé™æ£€æŸ¥å±‚æ¬¡                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  L1: è·¯ç”±çº§æƒé™                                              â”‚
â”‚      - åœ¨ä¸­é—´ä»¶ç»Ÿä¸€æ£€æŸ¥                                      â”‚
â”‚      - åŸºäº URL + Method                                     â”‚
â”‚      - ç²—ç²’åº¦ï¼Œæ€§èƒ½é«˜                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  L2: èµ„æºçº§æƒé™                                              â”‚
â”‚      - åœ¨ä¸šåŠ¡é€»è¾‘ä¸­æ£€æŸ¥                                      â”‚
â”‚      - åŸºäºå…·ä½“èµ„æº ID                                       â”‚
â”‚      - å¦‚: åªèƒ½æŸ¥çœ‹è‡ªå·±çš„å„¿ç«¥                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  L3: å­—æ®µçº§æƒé™                                              â”‚
â”‚      - åœ¨è¿”å›æ•°æ®æ—¶è¿‡æ»¤                                      â”‚
â”‚      - éšè—æ•æ„Ÿå­—æ®µ                                          â”‚
â”‚      - å¦‚: æ™®é€šç”¨æˆ·çœ‹ä¸åˆ°èº«ä»½è¯å·                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 èµ„æºçº§æƒé™ç¤ºä¾‹

```go
// ä¼ªä»£ç : èµ„æºçº§æƒé™æ£€æŸ¥
// æºç : internal/apiserver/application/child_app_service.go

func (s *ChildAppService) GetChild(ctx context.Context, userID, childID string) (*Child, error) {
    // 1. è·¯ç”±çº§æƒé™å·²åœ¨ä¸­é—´ä»¶æ£€æŸ¥è¿‡
    
    // 2. èµ„æºçº§æƒé™æ£€æŸ¥: ç”¨æˆ·æ˜¯å¦æ˜¯è¯¥å„¿ç«¥çš„ç›‘æŠ¤äºº
    isGuardian, err := s.guardianRepo.IsGuardian(ctx, userID, childID)
    if err != nil {
        return nil, err
    }
    
    // å¦‚æœä¸æ˜¯ç›‘æŠ¤äººï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯ç®¡ç†å‘˜
    if !isGuardian {
        isAdmin, _ := s.enforcer.Enforce(ctx, EnforceRequest{
            Subject: userID,
            Object:  "child",
            Action:  "admin",
        })
        if !isAdmin {
            return nil, ErrForbidden
        }
    }
    
    // 3. è·å–æ•°æ®
    return s.childRepo.FindByID(ctx, childID)
}
```

---

## 6. é…ç½®é¡¹

```yaml
# æˆæƒç›¸å…³é…ç½®
# æºç : configs/apiserver.yaml

authz:
  casbin:
    model_path: "configs/casbin_model.conf"
    auto_load_interval: 60s   # è‡ªåŠ¨åŠ è½½ç­–ç•¥é—´éš”
    
  cache:
    enabled: true
    ttl: 5m                   # ç¼“å­˜è¿‡æœŸæ—¶é—´
    prefix: "authz:"
    
  routes:
    - pattern: "/api/v1/users/*"
      resource: "user"
    - pattern: "/api/v1/children/*"
      resource: "child"
    - pattern: "/api/v1/reports/*"
      resource: "report"
```

---

## 7. æºç ç´¢å¼•

| ç»„ä»¶ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| **ä¸­é—´ä»¶** | | |
| AuthzMiddleware | `infra/middleware/authz.go` | æƒé™ä¸­é—´ä»¶ |
| ResourceExtractor | `infra/middleware/resource_extractor.go` | èµ„æºæå– |
| **Casbin** | | |
| EnforcerService | `domain/authz/service/enforcer_service.go` | æƒé™å†³ç­– |
| CasbinAdapter | `infra/authz/casbin_adapter.go` | Casbin é€‚é…å™¨ |
| **ç¼“å­˜** | | |
| RedisAuthzCache | `infra/authz/redis_cache.go` | Redis ç¼“å­˜ |
| **é…ç½®** | | |
| casbin_model.conf | `configs/casbin_model.conf` | Casbin æ¨¡å‹ |
