# ç›‘æŠ¤å…³ç³»è®¾è®¡

> ğŸ¯ **æ ¸å¿ƒç»“è®º**: ç›‘æŠ¤å…³ç³»æ˜¯è¿æ¥ç”¨æˆ·ä¸å„¿ç«¥çš„æ ¸å¿ƒä¸šåŠ¡ï¼Œæ”¯æŒå¤šç›‘æŠ¤äººåœºæ™¯

---

## 1. ä¸šåŠ¡åœºæ™¯

### 1.1 åœºæ™¯æè¿°

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç›‘æŠ¤å…³ç³»ä¸šåŠ¡åœºæ™¯                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  åœºæ™¯1: å®¶é•¿å¸¦å­©å­åšå¿ƒç†æµ‹è¯„                                 â”‚
â”‚  - å®¶é•¿(ç›‘æŠ¤äºº)ç™»å½•å°ç¨‹åº                                    â”‚
â”‚  - åˆ›å»ºå„¿ç«¥æ¡£æ¡ˆ                                              â”‚
â”‚  - ä»£æ›¿å­©å­å®Œæˆæµ‹è¯„                                          â”‚
â”‚  - æŸ¥çœ‹æµ‹è¯„æŠ¥å‘Š                                              â”‚
â”‚                                                              â”‚
â”‚  åœºæ™¯2: çˆ¶æ¯åŒæ–¹éƒ½éœ€è¦æŸ¥çœ‹æŠ¥å‘Š                               â”‚
â”‚  - ä¸»ç›‘æŠ¤äºº(çˆ¸çˆ¸)åˆ›å»ºå„¿ç«¥æ¡£æ¡ˆ                                â”‚
â”‚  - é‚€è¯·æ¬¡ç›‘æŠ¤äºº(å¦ˆå¦ˆ)åŠ å…¥                                    â”‚
â”‚  - åŒæ–¹éƒ½å¯æŸ¥çœ‹å­©å­çš„æµ‹è¯„æŠ¥å‘Š                                â”‚
â”‚                                                              â”‚
â”‚  åœºæ™¯3: ç¦»å¼‚å®¶åº­                                             â”‚
â”‚  - è§£é™¤ä¸€æ–¹ç›‘æŠ¤æƒ                                            â”‚
â”‚  - ä¿ç•™å¦ä¸€æ–¹çš„è®¿é—®æƒé™                                      â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ä¸šåŠ¡è§„åˆ™

| è§„åˆ™ | è¯´æ˜ |
|------|------|
| æ¯ä¸ªå„¿ç«¥æœ€å¤š 2 ä¸ªç›‘æŠ¤äºº | é€šå¸¸æ˜¯çˆ¶æ¯åŒæ–¹ |
| å¿…é¡»æœ‰ 1 ä¸ªä¸»ç›‘æŠ¤äºº | åˆ›å»ºå„¿ç«¥æ—¶è‡ªåŠ¨æˆä¸ºä¸»ç›‘æŠ¤äºº |
| ä¸»ç›‘æŠ¤äººå¯é‚€è¯·æ¬¡ç›‘æŠ¤äºº | é€šè¿‡é‚€è¯·ç æˆ–æ‰‹æœºå· |
| åªæœ‰ä¸»ç›‘æŠ¤äººå¯è§£é™¤ä»–äººç›‘æŠ¤æƒ | é˜²æ­¢æƒé™æ»¥ç”¨ |
| è§£é™¤åä»ä¿ç•™å†å²è®°å½• | å®¡è®¡éœ€è¦ |

---

## 2. æµç¨‹è®¾è®¡

### 2.1 åˆ›å»ºå„¿ç«¥å¹¶ç»‘å®š

```mermaid
sequenceDiagram
    participant G as ç›‘æŠ¤äºº
    participant API as IAM API
    participant UC as UCæœåŠ¡
    participant DB as æ•°æ®åº“
    participant Event as äº‹ä»¶æ€»çº¿
    
    G->>API: POST /children {name, birthday...}
    API->>UC: CreateChild(guardianID, childInfo)
    
    UC->>UC: åˆ›å»º Child èšåˆ
    UC->>UC: åˆ›å»º Guardianship (primary)
    UC->>DB: ä¿å­˜ Child
    UC->>DB: ä¿å­˜ Guardianship
    
    UC->>Event: ChildCreated
    UC->>Event: GuardianshipCreated
    
    UC-->>API: Child + Guardianship
    API-->>G: 201 Created
```

### 2.2 é‚€è¯·æ¬¡ç›‘æŠ¤äºº

```mermaid
sequenceDiagram
    participant P as ä¸»ç›‘æŠ¤äºº
    participant API as IAM API
    participant UC as UCæœåŠ¡
    participant S as æ¬¡ç›‘æŠ¤äºº
    
    P->>API: POST /children/{id}/invite
    API->>UC: CreateInvitation(childID, phone)
    UC-->>API: inviteCode
    API-->>P: é‚€è¯·ç /é“¾æ¥
    
    P-->>S: åˆ†äº«é‚€è¯·ç 
    
    S->>API: POST /guardianships/accept {inviteCode}
    API->>UC: AcceptInvitation(userID, inviteCode)
    
    UC->>UC: éªŒè¯é‚€è¯·ç 
    UC->>UC: åˆ›å»º Guardianship (secondary)
    UC-->>API: Guardianship
    API-->>S: ç»‘å®šæˆåŠŸ
```

### 2.3 è§£é™¤ç›‘æŠ¤å…³ç³»

```mermaid
sequenceDiagram
    participant P as ä¸»ç›‘æŠ¤äºº
    participant API as IAM API
    participant UC as UCæœåŠ¡
    participant Event as äº‹ä»¶æ€»çº¿
    
    P->>API: DELETE /guardianships/{id}
    API->>UC: RemoveGuardianship(operatorID, guardianshipID)
    
    UC->>UC: éªŒè¯æ“ä½œè€…æ˜¯ä¸»ç›‘æŠ¤äºº
    UC->>UC: æ ‡è®° Guardianship ä¸º inactive
    UC->>Event: GuardianshipRemoved
    
    UC-->>API: success
    API-->>P: 204 No Content
```

---

## 3. è¯¦ç»†è®¾è®¡

### 3.1 é‚€è¯·æœºåˆ¶

```go
// ä¼ªä»£ç : é‚€è¯·ç ç”Ÿæˆä¸éªŒè¯
// æºç : internal/apiserver/domain/uc/service/invitation_service.go

type Invitation struct {
    Code      string    // é‚€è¯·ç 
    ChildID   ChildID   // å„¿ç«¥ID
    InviterID UserID    // é‚€è¯·äººID
    ExpiresAt time.Time // è¿‡æœŸæ—¶é—´
}

type InvitationService struct {
    cache InvitationCache
}

// åˆ›å»ºé‚€è¯·
func (s *InvitationService) Create(ctx context.Context, childID ChildID, inviterID UserID) (*Invitation, error) {
    invitation := &Invitation{
        Code:      generateCode(6),         // 6ä½éšæœºç 
        ChildID:   childID,
        InviterID: inviterID,
        ExpiresAt: time.Now().Add(24*time.Hour),
    }
    
    // å­˜å‚¨åˆ° Redisï¼Œ24å°æ—¶è¿‡æœŸ
    s.cache.Set(invitation.Code, invitation)
    
    return invitation, nil
}

// éªŒè¯å¹¶æ¶ˆè´¹é‚€è¯·
func (s *InvitationService) Accept(ctx context.Context, code string, userID UserID) (*Invitation, error) {
    invitation, err := s.cache.Get(code)
    if err != nil {
        return nil, ErrInvitationNotFound
    }
    
    if invitation.ExpiresAt.Before(time.Now()) {
        return nil, ErrInvitationExpired
    }
    
    // æ¶ˆè´¹é‚€è¯·ç 
    s.cache.Delete(code)
    
    return invitation, nil
}
```

### 3.2 æƒé™éªŒè¯

```go
// ä¼ªä»£ç : ç›‘æŠ¤å…³ç³»æƒé™éªŒè¯
// æºç : internal/apiserver/domain/uc/service/guardianship_service.go

// éªŒè¯æ˜¯å¦å¯ä»¥æ“ä½œå„¿ç«¥æ•°æ®
func (s *GuardianshipService) CanAccessChild(ctx context.Context, userID UserID, childID ChildID) (bool, error) {
    user, err := s.userRepo.FindByID(ctx, userID)
    if err != nil {
        return false, err
    }
    
    return user.IsGuardianOf(childID), nil
}

// éªŒè¯æ˜¯å¦å¯ä»¥ç®¡ç†ç›‘æŠ¤å…³ç³»
func (s *GuardianshipService) CanManageGuardianship(ctx context.Context, userID UserID, childID ChildID) (bool, error) {
    user, err := s.userRepo.FindByID(ctx, userID)
    if err != nil {
        return false, err
    }
    
    for _, g := range user.Guardianships {
        if g.ChildID == childID && g.Type == GuardianTypePrimary && g.Status == GuardianshipStatusActive {
            return true, nil
        }
    }
    return false, nil
}
```

### 3.3 æ•°æ®éš”ç¦»

```go
// ä¼ªä»£ç : å„¿ç«¥æ•°æ®æŸ¥è¯¢ (å¸¦æƒé™è¿‡æ»¤)
// æºç : internal/apiserver/application/child_query_service.go

type ChildQueryService struct {
    childRepo  ChildRepository
    guardianSvc *GuardianshipService
}

// æŸ¥è¯¢ç”¨æˆ·å¯è®¿é—®çš„æ‰€æœ‰å„¿ç«¥
func (s *ChildQueryService) ListChildrenForUser(ctx context.Context, userID UserID) ([]*Child, error) {
    // åªè¿”å›è¯¥ç”¨æˆ·ä½œä¸ºç›‘æŠ¤äººçš„å„¿ç«¥
    return s.childRepo.FindByGuardian(ctx, userID)
}

// æŸ¥è¯¢å•ä¸ªå„¿ç«¥ (å¸¦æƒé™æ£€æŸ¥)
func (s *ChildQueryService) GetChild(ctx context.Context, userID UserID, childID ChildID) (*Child, error) {
    // æƒé™æ£€æŸ¥
    canAccess, err := s.guardianSvc.CanAccessChild(ctx, userID, childID)
    if err != nil || !canAccess {
        return nil, ErrForbidden
    }
    
    return s.childRepo.FindByID(ctx, childID)
}
```

---

## 4. çŠ¶æ€æœº

### 4.1 ç›‘æŠ¤å…³ç³»çŠ¶æ€

```mermaid
stateDiagram-v2
    [*] --> Pending: åˆ›å»ºé‚€è¯·
    Pending --> Active: æ¥å—é‚€è¯·
    Pending --> Expired: è¶…æ—¶
    Active --> Inactive: è§£é™¤
    Inactive --> [*]
    Expired --> [*]
```

### 4.2 çŠ¶æ€å®šä¹‰

```go
// ä¼ªä»£ç : ç›‘æŠ¤å…³ç³»çŠ¶æ€
// æºç : internal/apiserver/domain/uc/valueobject/guardianship_status.go

type GuardianshipStatus string

const (
    GuardianshipStatusPending  GuardianshipStatus = "pending"   // å¾…æ¥å—
    GuardianshipStatusActive   GuardianshipStatus = "active"    // ç”Ÿæ•ˆä¸­
    GuardianshipStatusInactive GuardianshipStatus = "inactive"  // å·²è§£é™¤
    GuardianshipStatusExpired  GuardianshipStatus = "expired"   // å·²è¿‡æœŸ
)

// çŠ¶æ€è½¬æ¢éªŒè¯
func (s GuardianshipStatus) CanTransitionTo(target GuardianshipStatus) bool {
    transitions := map[GuardianshipStatus][]GuardianshipStatus{
        GuardianshipStatusPending: {GuardianshipStatusActive, GuardianshipStatusExpired},
        GuardianshipStatusActive:  {GuardianshipStatusInactive},
    }
    
    allowed, ok := transitions[s]
    if !ok {
        return false
    }
    
    for _, t := range allowed {
        if t == target {
            return true
        }
    }
    return false
}
```

---

## 5. API è®¾è®¡

### 5.1 æ¥å£åˆ—è¡¨

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| POST | `/children` | åˆ›å»ºå„¿ç«¥ (è‡ªåŠ¨ç»‘å®š) |
| GET | `/children` | æŸ¥è¯¢æˆ‘çš„å„¿ç«¥åˆ—è¡¨ |
| GET | `/children/:id` | æŸ¥è¯¢å„¿ç«¥è¯¦æƒ… |
| PUT | `/children/:id` | æ›´æ–°å„¿ç«¥ä¿¡æ¯ |
| POST | `/children/:id/invite` | é‚€è¯·æ¬¡ç›‘æŠ¤äºº |
| POST | `/guardianships/accept` | æ¥å—é‚€è¯· |
| DELETE | `/guardianships/:id` | è§£é™¤ç›‘æŠ¤å…³ç³» |

### 5.2 æ¥å£ç¤ºä¾‹

```yaml
# åˆ›å»ºå„¿ç«¥
POST /api/v1/children
Authorization: Bearer {token}

Request:
{
  "name": "å°æ˜",
  "gender": "male",
  "birthday": "2015-06-01"
}

Response: 201
{
  "id": "child_123",
  "name": "å°æ˜",
  "guardianship": {
    "id": "gs_456",
    "type": "primary",
    "status": "active"
  }
}
```

```yaml
# é‚€è¯·æ¬¡ç›‘æŠ¤äºº
POST /api/v1/children/child_123/invite
Authorization: Bearer {token}

Response: 200
{
  "invite_code": "ABC123",
  "expires_at": "2024-01-02T00:00:00Z"
}
```

---

## 6. æºç ç´¢å¼•

| ç»„ä»¶ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| **é¢†åŸŸæœåŠ¡** | | |
| GuardianshipService | `domain/uc/service/guardianship_service.go` | ç›‘æŠ¤å…³ç³»æœåŠ¡ |
| InvitationService | `domain/uc/service/invitation_service.go` | é‚€è¯·æœåŠ¡ |
| **åº”ç”¨æœåŠ¡** | | |
| ChildAppService | `application/uc/child_app_service.go` | å„¿ç«¥åº”ç”¨æœåŠ¡ |
| GuardianAppService | `application/uc/guardian_app_service.go` | ç›‘æŠ¤åº”ç”¨æœåŠ¡ |
| **Handler** | | |
| ChildHandler | `interface/rest/child_handler.go` | å„¿ç«¥API |
| GuardianHandler | `interface/rest/guardian_handler.go` | ç›‘æŠ¤API |
