# ç”¨æˆ·åŸŸé¢†åŸŸæ¨¡å‹è®¾è®¡

> ğŸ¯ **æ ¸å¿ƒç»“è®º**: User å’Œ Child ä½œä¸ºç‹¬ç«‹èšåˆæ ¹ï¼ŒGuardianship ä½œä¸ºå…³è”å®ä½“ç®¡ç†ç›‘æŠ¤å…³ç³»

---

## 1. è®¾è®¡æ¦‚è¿°

### 1.1 é¢†åŸŸè¾¹ç•Œ

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ç”¨æˆ·åŸŸ (UC)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  èŒè´£: ç”¨æˆ·ç®¡ç†ã€å„¿ç«¥æ¡£æ¡ˆã€ç›‘æŠ¤å…³ç³»                          â”‚
â”‚  ä¸è´Ÿè´£: è®¤è¯å‡­è¯ç®¡ç†ã€æƒé™ç­–ç•¥ç®¡ç†                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 èšåˆåˆ’åˆ†

| èšåˆ | èšåˆæ ¹ | èŒè´£ |
|------|--------|------|
| ç”¨æˆ·èšåˆ | User | ç”¨æˆ·æ¡£æ¡ˆã€ç›‘æŠ¤å…³ç³»ç®¡ç† |
| å„¿ç«¥èšåˆ | Child | å„¿ç«¥æ¡£æ¡ˆç®¡ç† |

---

## 2. é¢†åŸŸæ¨¡å‹

### 2.1 èšåˆå…³ç³»å›¾

```mermaid
classDiagram
    class User {
        +UserID id
        +Profile profile
        +Contact contact
        +List~RoleCode~ roles
        +List~Guardianship~ guardianships
        +UserStatus status
        +UpdateProfile(profile)
        +BindChild(child, type)
        +UnbindChild(childID)
        +IsGuardianOf(childID)
    }
    
    class Profile {
        +String nickname
        +Gender gender
        +Date birthday
        +String avatar
    }
    
    class Contact {
        +String phone
        +String email
        +String address
    }
    
    class Guardianship {
        +GuardianshipID id
        +UserID guardianID
        +ChildID childID
        +GuardianType type
        +GuardianshipStatus status
        +DateTime createdAt
    }
    
    class Child {
        +ChildID id
        +ChildProfile profile
        +ChildStatus status
        +UserID createdBy
        +UpdateProfile(profile)
    }
    
    class ChildProfile {
        +String name
        +Gender gender
        +Date birthday
        +String idCard
        +String school
        +String grade
    }
    
    User "1" --> "1" Profile
    User "1" --> "1" Contact
    User "1" --> "*" Guardianship
    Guardianship "*" --> "1" Child
    Child "1" --> "1" ChildProfile
```

### 2.2 User èšåˆæ ¹

```go
// ä¼ªä»£ç : User èšåˆæ ¹
// æºç : internal/apiserver/domain/uc/entity/user.go

type User struct {
    ID            UserID          // ç”¨æˆ·ID
    Profile       Profile         // ç”¨æˆ·æ¡£æ¡ˆ
    Contact       Contact         // è”ç³»æ–¹å¼
    Roles         []RoleCode      // è§’è‰²åˆ—è¡¨
    Guardianships []Guardianship  // ç›‘æŠ¤å…³ç³»
    Status        UserStatus      // ç”¨æˆ·çŠ¶æ€
    CreatedAt     time.Time
    UpdatedAt     time.Time
}

// ç»‘å®šå„¿ç«¥
func (u *User) BindChild(childID ChildID, guardianType GuardianType) (*Guardianship, error) {
    // ä¸šåŠ¡è§„åˆ™: æ£€æŸ¥æ˜¯å¦å·²ç»‘å®š
    if u.IsGuardianOf(childID) {
        return nil, ErrAlreadyGuardian
    }
    
    // ä¸šåŠ¡è§„åˆ™: æ¯ä¸ªå„¿ç«¥æœ€å¤š 2 ä¸ªç›‘æŠ¤äºº
    // (æ­¤è§„åˆ™éœ€è¦è·¨èšåˆæŸ¥è¯¢ï¼Œæ”¾åœ¨é¢†åŸŸæœåŠ¡ä¸­)
    
    guardianship := &Guardianship{
        ID:         NewGuardianshipID(),
        GuardianID: u.ID,
        ChildID:    childID,
        Type:       guardianType,
        Status:     GuardianshipStatusActive,
        CreatedAt:  time.Now(),
    }
    
    u.Guardianships = append(u.Guardianships, *guardianship)
    return guardianship, nil
}

// è§£é™¤ç»‘å®š
func (u *User) UnbindChild(childID ChildID) error {
    for i, g := range u.Guardianships {
        if g.ChildID == childID {
            u.Guardianships[i].Status = GuardianshipStatusInactive
            return nil
        }
    }
    return ErrGuardianshipNotFound
}

// æ£€æŸ¥æ˜¯å¦æ˜¯æŸå„¿ç«¥çš„ç›‘æŠ¤äºº
func (u *User) IsGuardianOf(childID ChildID) bool {
    for _, g := range u.Guardianships {
        if g.ChildID == childID && g.Status == GuardianshipStatusActive {
            return true
        }
    }
    return false
}
```

### 2.3 Profile å€¼å¯¹è±¡

```go
// ä¼ªä»£ç : Profile å€¼å¯¹è±¡
// æºç : internal/apiserver/domain/uc/valueobject/profile.go

type Profile struct {
    Nickname string    // æ˜µç§°
    Gender   Gender    // æ€§åˆ«
    Birthday *Date     // ç”Ÿæ—¥ (å¯é€‰)
    Avatar   string    // å¤´åƒ URL
}

type Gender string

const (
    GenderMale    Gender = "male"
    GenderFemale  Gender = "female"
    GenderUnknown Gender = "unknown"
)

// éªŒè¯
func (p *Profile) Validate() error {
    if len(p.Nickname) < 2 || len(p.Nickname) > 20 {
        return ErrInvalidNickname
    }
    return nil
}
```

### 2.4 Child èšåˆæ ¹

```go
// ä¼ªä»£ç : Child èšåˆæ ¹
// æºç : internal/apiserver/domain/uc/entity/child.go

type Child struct {
    ID        ChildID       // å„¿ç«¥ID
    Profile   ChildProfile  // å„¿ç«¥æ¡£æ¡ˆ
    Status    ChildStatus   // çŠ¶æ€
    CreatedBy UserID        // åˆ›å»ºè€… (é¦–ä¸ªç›‘æŠ¤äºº)
    CreatedAt time.Time
    UpdatedAt time.Time
}

type ChildProfile struct {
    Name     string   // å§“å
    Gender   Gender   // æ€§åˆ«
    Birthday Date     // ç”Ÿæ—¥
    IDCard   *string  // èº«ä»½è¯å· (å¯é€‰ï¼ŒåŠ å¯†å­˜å‚¨)
    School   *string  // å­¦æ ¡
    Grade    *string  // å¹´çº§
}

// æ›´æ–°æ¡£æ¡ˆ
func (c *Child) UpdateProfile(profile ChildProfile) error {
    if err := profile.Validate(); err != nil {
        return err
    }
    c.Profile = profile
    c.UpdatedAt = time.Now()
    return nil
}

// éªŒè¯å„¿ç«¥æ¡£æ¡ˆ
func (p *ChildProfile) Validate() error {
    if len(p.Name) < 2 {
        return ErrInvalidChildName
    }
    // ä¸šåŠ¡è§„åˆ™: å¿…é¡»æ˜¯æœªæˆå¹´äºº
    if p.Birthday.AddDate(18, 0, 0).Before(time.Now()) {
        return ErrNotMinor
    }
    return nil
}
```

### 2.5 Guardianship å®ä½“

```go
// ä¼ªä»£ç : Guardianship å®ä½“
// æºç : internal/apiserver/domain/uc/entity/guardianship.go

type Guardianship struct {
    ID         GuardianshipID     // å…³ç³»ID
    GuardianID UserID             // ç›‘æŠ¤äººID
    ChildID    ChildID            // å„¿ç«¥ID
    Type       GuardianType       // ç›‘æŠ¤äººç±»å‹
    Status     GuardianshipStatus // å…³ç³»çŠ¶æ€
    CreatedAt  time.Time
}

type GuardianType string

const (
    GuardianTypePrimary   GuardianType = "primary"   // ä¸»ç›‘æŠ¤äºº
    GuardianTypeSecondary GuardianType = "secondary" // æ¬¡ç›‘æŠ¤äºº
)

type GuardianshipStatus string

const (
    GuardianshipStatusActive   GuardianshipStatus = "active"
    GuardianshipStatusInactive GuardianshipStatus = "inactive"
)
```

---

## 3. é¢†åŸŸæœåŠ¡

### 3.1 æœåŠ¡åˆ’åˆ†

```mermaid
graph TB
    subgraph "é¢†åŸŸæœåŠ¡"
        RS[RegisterService<br/>æ³¨å†ŒæœåŠ¡]
        GS[GuardianshipService<br/>ç›‘æŠ¤å…³ç³»æœåŠ¡]
    end
    
    subgraph "èšåˆ"
        User[User]
        Child[Child]
    end
    
    subgraph "äº‹ä»¶"
        E1[UserRegistered]
        E2[ChildBound]
    end
    
    RS --> User
    RS --> E1
    GS --> User
    GS --> Child
    GS --> E2
```

### 3.2 RegisterService

```go
// ä¼ªä»£ç : æ³¨å†Œé¢†åŸŸæœåŠ¡
// æºç : internal/apiserver/domain/uc/service/register_service.go

type RegisterService struct {
    userRepo     UserRepository
    eventBus     EventBus
}

// æ³¨å†Œç”¨æˆ·
func (s *RegisterService) Register(ctx context.Context, req RegisterRequest) (*User, error) {
    // 1. åˆ›å»ºç”¨æˆ·
    user := &User{
        ID:      NewUserID(),
        Profile: req.Profile,
        Contact: req.Contact,
        Roles:   []RoleCode{RoleGuardian}, // é»˜è®¤è§’è‰²
        Status:  UserStatusActive,
    }
    
    // 2. éªŒè¯
    if err := user.Validate(); err != nil {
        return nil, err
    }
    
    // 3. æŒä¹…åŒ–
    if err := s.userRepo.Save(ctx, user); err != nil {
        return nil, err
    }
    
    // 4. å‘å¸ƒäº‹ä»¶
    s.eventBus.Publish(UserRegisteredEvent{
        UserID:    user.ID,
        Timestamp: time.Now(),
    })
    
    return user, nil
}
```

### 3.3 GuardianshipService

```go
// ä¼ªä»£ç : ç›‘æŠ¤å…³ç³»é¢†åŸŸæœåŠ¡
// æºç : internal/apiserver/domain/uc/service/guardianship_service.go

type GuardianshipService struct {
    userRepo  UserRepository
    childRepo ChildRepository
    eventBus  EventBus
}

// ç»‘å®šå„¿ç«¥ (è·¨èšåˆæ“ä½œ)
func (s *GuardianshipService) BindChild(ctx context.Context, guardianID UserID, childID ChildID, guardianType GuardianType) error {
    // 1. è·å–ç›‘æŠ¤äºº
    guardian, err := s.userRepo.FindByID(ctx, guardianID)
    if err != nil {
        return err
    }
    
    // 2. è·å–å„¿ç«¥
    child, err := s.childRepo.FindByID(ctx, childID)
    if err != nil {
        return err
    }
    
    // 3. ä¸šåŠ¡è§„åˆ™: æ¯ä¸ªå„¿ç«¥æœ€å¤š 2 ä¸ªç›‘æŠ¤äºº
    guardians, _ := s.userRepo.FindGuardiansOfChild(ctx, childID)
    if len(guardians) >= 2 {
        return ErrMaxGuardiansReached
    }
    
    // 4. ç»‘å®š
    guardianship, err := guardian.BindChild(childID, guardianType)
    if err != nil {
        return err
    }
    
    // 5. æŒä¹…åŒ–
    if err := s.userRepo.Save(ctx, guardian); err != nil {
        return err
    }
    
    // 6. å‘å¸ƒäº‹ä»¶
    s.eventBus.Publish(ChildBoundEvent{
        GuardianID:     guardianID,
        ChildID:        childID,
        GuardianshipID: guardianship.ID,
        Timestamp:      time.Now(),
    })
    
    return nil
}
```

---

## 4. ç«¯å£å®šä¹‰

### 4.1 ä»“å‚¨ç«¯å£

```go
// ä¼ªä»£ç : ä»“å‚¨ç«¯å£
// æºç : internal/apiserver/domain/uc/port/repository.go

type UserRepository interface {
    FindByID(ctx context.Context, id UserID) (*User, error)
    FindByPhone(ctx context.Context, phone string) (*User, error)
    FindGuardiansOfChild(ctx context.Context, childID ChildID) ([]*User, error)
    Save(ctx context.Context, user *User) error
    Delete(ctx context.Context, id UserID) error
}

type ChildRepository interface {
    FindByID(ctx context.Context, id ChildID) (*Child, error)
    FindByGuardian(ctx context.Context, guardianID UserID) ([]*Child, error)
    Save(ctx context.Context, child *Child) error
    Delete(ctx context.Context, id ChildID) error
}
```

### 4.2 äº‹ä»¶å‘å¸ƒç«¯å£

```go
// ä¼ªä»£ç : äº‹ä»¶å‘å¸ƒç«¯å£
// æºç : internal/apiserver/domain/uc/port/event_publisher.go

type EventBus interface {
    Publish(event DomainEvent) error
}

type DomainEvent interface {
    EventType() string
    Timestamp() time.Time
}
```

---

## 5. æºç ç´¢å¼•

| ç»„ä»¶ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| **èšåˆæ ¹** | | |
| User | `domain/uc/entity/user.go` | ç”¨æˆ·èšåˆæ ¹ |
| Child | `domain/uc/entity/child.go` | å„¿ç«¥èšåˆæ ¹ |
| **å®ä½“** | | |
| Guardianship | `domain/uc/entity/guardianship.go` | ç›‘æŠ¤å…³ç³» |
| **å€¼å¯¹è±¡** | | |
| Profile | `domain/uc/valueobject/profile.go` | ç”¨æˆ·æ¡£æ¡ˆ |
| ChildProfile | `domain/uc/valueobject/child_profile.go` | å„¿ç«¥æ¡£æ¡ˆ |
| Contact | `domain/uc/valueobject/contact.go` | è”ç³»æ–¹å¼ |
| **é¢†åŸŸæœåŠ¡** | | |
| RegisterService | `domain/uc/service/register_service.go` | æ³¨å†ŒæœåŠ¡ |
| GuardianshipService | `domain/uc/service/guardianship_service.go` | ç›‘æŠ¤å…³ç³»æœåŠ¡ |
| **ç«¯å£** | | |
| UserRepository | `domain/uc/port/repository.go` | ç”¨æˆ·ä»“å‚¨ |
| ChildRepository | `domain/uc/port/repository.go` | å„¿ç«¥ä»“å‚¨ |
