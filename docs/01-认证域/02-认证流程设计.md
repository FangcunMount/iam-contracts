# è®¤è¯æµç¨‹è®¾è®¡

> ğŸ¯ **æ ¸å¿ƒç»“è®º**: é‡‡ç”¨ç­–ç•¥æ¨¡å¼æ”¯æŒå¤šæ¸ é“ç™»å½•ï¼ŒRS256 ç­¾åçš„ JWT æ”¯æŒä¸šåŠ¡æœåŠ¡è‡ªéªŒè¯

---

## 1. è®¾è®¡æ¦‚è¿°

### 1.1 è§£å†³ä»€ä¹ˆé—®é¢˜

| é—®é¢˜ | è§£å†³æ–¹æ¡ˆ |
|------|---------|
| å¤šæ¸ é“ç™»å½•ï¼ˆå¾®ä¿¡ã€å¯†ç ç­‰ï¼‰ | ç­–ç•¥æ¨¡å¼ï¼Œç»Ÿä¸€è®¤è¯æ¥å£ |
| Token éªŒè¯æ€§èƒ½ | JWKS å…¬é’¥å‘å¸ƒï¼Œä¸šåŠ¡æœåŠ¡æœ¬åœ°éªŒè¯ |
| Token å®‰å…¨æ€§ | RS256 éå¯¹ç§°ç­¾å + çŸ­æœŸæœ‰æ•ˆ + Refresh æœºåˆ¶ |
| ä¼šè¯ç®¡ç† | Redis å­˜å‚¨æ´»è·ƒä¼šè¯ï¼Œæ”¯æŒå¼ºåˆ¶ç™»å‡º |

### 1.2 è®¾è®¡æ€æƒ³

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è®¾è®¡åŸåˆ™åº”ç”¨                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç­–ç•¥æ¨¡å¼     â†’  å¤šè®¤è¯æ¸ é“ï¼ˆå¾®ä¿¡/å¯†ç /OAuthï¼‰           â”‚
â”‚  å·¥å‚æ¨¡å¼     â†’  Token ç”Ÿæˆï¼ˆAccess/Refreshï¼‰            â”‚
â”‚  å•ä¸€èŒè´£     â†’  è®¤è¯ã€ç­¾å‘ã€éªŒè¯åˆ†ç¦»                    â”‚
â”‚  ä¾èµ–å€’ç½®     â†’  é¢†åŸŸå±‚å®šä¹‰ç«¯å£ï¼ŒåŸºç¡€è®¾æ–½å®ç°            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. è®¤è¯æµç¨‹

### 2.1 å¾®ä¿¡å°ç¨‹åºç™»å½•

```mermaid
sequenceDiagram
    participant MP as å°ç¨‹åº
    participant IAM as IAM æœåŠ¡
    participant WX as å¾®ä¿¡æœåŠ¡å™¨
    participant UC as UC æœåŠ¡
    participant Redis as Redis
    
    MP->>IAM: POST /auth/wechat/login {code}
    IAM->>WX: code2session(code)
    WX-->>IAM: {openid, unionid, session_key}
    
    IAM->>UC: æŸ¥è¯¢/åˆ›å»ºç”¨æˆ·(unionid)
    UC-->>IAM: User
    
    IAM->>IAM: ç”Ÿæˆ JWT Token
    IAM->>Redis: å­˜å‚¨ Session
    IAM-->>MP: {access_token, refresh_token}
```

**å…³é”®ä»£ç è·¯å¾„:**

```go
// ä¼ªä»£ç : å¾®ä¿¡ç™»å½•ç­–ç•¥
// æºç : internal/apiserver/domain/authn/service/wechat_strategy.go

type WeChatLoginStrategy struct {
    wechatClient port.WeChatClient
    userService  port.UserQueryService
}

func (s *WeChatLoginStrategy) Authenticate(ctx context.Context, req LoginRequest) (*Account, error) {
    // 1. è°ƒç”¨å¾®ä¿¡è·å– OpenID/UnionID
    wxSession, err := s.wechatClient.Code2Session(ctx, req.Code)
    
    // 2. æŸ¥è¯¢æˆ–åˆ›å»ºç”¨æˆ·
    user, err := s.userService.GetOrCreateByUnionID(ctx, wxSession.UnionID)
    
    // 3. æ„å»ºè´¦æˆ·èšåˆ
    return account.NewFromWeChatSession(user, wxSession), nil
}
```

### 2.2 Token ç­¾å‘æµç¨‹

```mermaid
flowchart TB
    subgraph "Token ç­¾å‘"
        A[è®¤è¯æˆåŠŸ] --> B[æ„å»º Claims]
        B --> C{Token ç±»å‹}
        C -->|Access| D[çŸ­æœŸæœ‰æ•ˆ 15min]
        C -->|Refresh| E[é•¿æœŸæœ‰æ•ˆ 7d]
        D --> F[RS256 ç­¾å]
        E --> F
        F --> G[è¿”å› Token]
    end
    
    subgraph "Claims ç»“æ„"
        H[sub: user_id]
        I[iss: iam.service]
        J[aud: ç›®æ ‡æœåŠ¡]
        K[exp: è¿‡æœŸæ—¶é—´]
        L[roles: è§’è‰²åˆ—è¡¨]
    end
```

**Token Claims ç»“æ„:**

```go
// ä¼ªä»£ç : JWT Claims
// æºç : internal/apiserver/domain/authn/valueobject/claims.go

type Claims struct {
    // æ ‡å‡† Claims
    Subject   string    `json:"sub"`   // ç”¨æˆ·ID
    Issuer    string    `json:"iss"`   // ç­¾å‘è€…
    Audience  []string  `json:"aud"`   // å—ä¼—
    ExpiresAt time.Time `json:"exp"`   // è¿‡æœŸæ—¶é—´
    IssuedAt  time.Time `json:"iat"`   // ç­¾å‘æ—¶é—´
    
    // è‡ªå®šä¹‰ Claims
    UserID    string   `json:"uid"`    // ç”¨æˆ·ID
    Roles     []string `json:"roles"`  // è§’è‰²åˆ—è¡¨
    SessionID string   `json:"sid"`    // ä¼šè¯ID
}
```

### 2.3 Token åˆ·æ–°æµç¨‹

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant IAM as IAM æœåŠ¡
    participant Redis as Redis
    
    Client->>IAM: POST /auth/token/refresh {refresh_token}
    
    IAM->>IAM: éªŒè¯ Refresh Token ç­¾å
    IAM->>Redis: æ£€æŸ¥ Session æœ‰æ•ˆæ€§
    
    alt Session æœ‰æ•ˆ
        IAM->>IAM: ç”Ÿæˆæ–° Access Token
        IAM->>Redis: æ›´æ–° Session æ—¶é—´æˆ³
        IAM-->>Client: {access_token, refresh_token}
    else Session å·²å¤±æ•ˆ
        IAM-->>Client: 401 Unauthorized
    end
```

---

## 3. JWKS å…¬é’¥å‘å¸ƒ

### 3.1 è®¾è®¡ç›®æ ‡

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    JWKS è®¾è®¡ç›®æ ‡                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. ä¸šåŠ¡æœåŠ¡å¯æœ¬åœ°éªŒè¯ Tokenï¼Œæ— éœ€æ¯æ¬¡è°ƒç”¨ IAM          â”‚
â”‚  2. æ”¯æŒå¯†é’¥è½®æ¢ï¼Œå¹³æ»‘è¿‡æ¸¡                               â”‚
â”‚  3. éµå¾ª RFC 7517 JWKS æ ‡å‡†                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 JWKS ç«¯ç‚¹

```text
GET /.well-known/jwks.json

å“åº”:
{
  "keys": [
    {
      "kty": "RSA",
      "kid": "key-2024-01",      // å¯†é’¥IDï¼Œå¯¹åº” Token Header
      "use": "sig",
      "alg": "RS256",
      "n": "base64url(modulus)",
      "e": "base64url(exponent)"
    },
    {
      "kty": "RSA",
      "kid": "key-2023-12",      // æ—§å¯†é’¥ï¼Œæ”¯æŒè¿‡æ¸¡æœŸéªŒè¯
      ...
    }
  ]
}
```

### 3.3 ä¸šåŠ¡æœåŠ¡éªŒè¯æµç¨‹

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant QS as QS æœåŠ¡
    participant Cache as æœ¬åœ°ç¼“å­˜
    participant IAM as IAM JWKS
    
    Client->>QS: è¯·æ±‚ + JWT Token
    
    QS->>QS: è§£æ Token Header (kid)
    QS->>Cache: æŸ¥è¯¢å…¬é’¥(kid)
    
    alt å…¬é’¥å­˜åœ¨
        Cache-->>QS: å…¬é’¥
    else å…¬é’¥ä¸å­˜åœ¨
        QS->>IAM: GET /.well-known/jwks.json
        IAM-->>QS: JWKS
        QS->>Cache: ç¼“å­˜å…¬é’¥ (TTL: 1h)
    end
    
    QS->>QS: ä½¿ç”¨å…¬é’¥éªŒè¯ç­¾å
    QS-->>Client: å“åº”
```

---

## 4. å¯†é’¥è½®æ¢

### 4.1 è½®æ¢ç­–ç•¥

```text
æ—¶é—´çº¿:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
    T0              T1              T2              T3
    â”‚               â”‚               â”‚               â”‚
    â”‚<â”€â”€ Key A â”€â”€â”€â”€>â”‚               â”‚               â”‚
    â”‚               â”‚<â”€â”€ Key B â”€â”€â”€â”€>â”‚               â”‚
    â”‚               â”‚               â”‚<â”€â”€ Key C â”€â”€â”€â”€>â”‚
                    â”‚               â”‚
                    è¿‡æ¸¡æœŸ          è¿‡æ¸¡æœŸ
                    (A+B å¹¶å­˜)      (B+C å¹¶å­˜)
```

### 4.2 è½®æ¢æµç¨‹

```go
// ä¼ªä»£ç : å¯†é’¥è½®æ¢
// æºç : internal/apiserver/domain/authn/service/key_rotation.go

func (s *KeyRotationService) Rotate(ctx context.Context) error {
    // 1. ç”Ÿæˆæ–°å¯†é’¥å¯¹
    newKey, err := s.keyGenerator.GenerateRSAKey()
    
    // 2. å°†æ–°å¯†é’¥è®¾ä¸º Active
    s.keyStore.SetActiveKey(newKey)
    
    // 3. æ—§å¯†é’¥ç§»å…¥ Passive åˆ—è¡¨ (ä»å¯éªŒè¯)
    s.keyStore.MarkAsPassive(oldKey)
    
    // 4. åˆ é™¤è¶…è¿‡ä¿ç•™æœŸçš„æ—§å¯†é’¥
    s.keyStore.PurgeExpired(retentionPeriod)
    
    return nil
}
```

---

## 5. æºç ç´¢å¼•

| ç»„ä»¶ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| **è®¤è¯ç­–ç•¥** | | |
| å¾®ä¿¡ç™»å½• | `domain/authn/service/wechat_strategy.go` | å¾®ä¿¡è®¤è¯å®ç° |
| å¯†ç ç™»å½• | `domain/authn/service/password_strategy.go` | å¯†ç è®¤è¯å®ç° |
| **Token æœåŠ¡** | | |
| Token ç­¾å‘ | `domain/authn/service/token_service.go` | JWT ç”Ÿæˆ |
| Claims å®šä¹‰ | `domain/authn/valueobject/claims.go` | Claims å€¼å¯¹è±¡ |
| **JWKS æœåŠ¡** | | |
| JWKS ç”Ÿæˆ | `domain/authn/service/jwks_service.go` | å…¬é’¥é›†ç”Ÿæˆ |
| å¯†é’¥è½®æ¢ | `domain/authn/service/key_rotation.go` | å¯†é’¥ç®¡ç† |
| **ä¼šè¯ç®¡ç†** | | |
| ä¼šè¯å­˜å‚¨ | `infra/authn/redis/session_store.go` | Redis å®ç° |

---

## 6. é…ç½®é¡¹

```yaml
# configs/apiserver.yaml
authn:
  jwt:
    algorithm: RS256
    access_token_ttl: 15m
    refresh_token_ttl: 168h     # 7 days
    issuer: "iam.service"
    
  jwks:
    cache_ttl: 1h               # å…¬é’¥ç¼“å­˜æ—¶é—´
    key_rotation_period: 720h   # 30 days
    key_retention_period: 48h   # æ—§å¯†é’¥ä¿ç•™æ—¶é—´
    
  session:
    redis_prefix: "iam:session:"
    max_concurrent: 5           # æœ€å¤§å¹¶å‘ä¼šè¯æ•°
```
