# è®¤è¯åŸŸé¢†åŸŸæ¨¡å‹è®¾è®¡

> ğŸ¯ **æ ¸å¿ƒç»“è®º**: é‡‡ç”¨ Account èšåˆæ ¹ç®¡ç†å¤šå‡­è¯ï¼ŒSession èšåˆæ ¹ç®¡ç†ä¼šè¯ç”Ÿå‘½å‘¨æœŸ

---

## 1. è®¾è®¡æ¦‚è¿°

### 1.1 é¢†åŸŸè¾¹ç•Œ

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       è®¤è¯åŸŸ (Authn)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  èŒè´£: èº«ä»½è®¤è¯ã€Token ç®¡ç†ã€ä¼šè¯ç®¡ç†ã€JWKS å‘å¸ƒ             â”‚
â”‚  ä¸è´Ÿè´£: ç”¨æˆ·æ¡£æ¡ˆç®¡ç†ã€æƒé™ç­–ç•¥ç®¡ç†                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 èšåˆåˆ’åˆ†

| èšåˆ | èšåˆæ ¹ | èŒè´£ |
|------|--------|------|
| è´¦æˆ·èšåˆ | Account | ç®¡ç†ç”¨æˆ·è®¤è¯å‡­è¯ |
| ä¼šè¯èšåˆ | Session | ç®¡ç†ç™»å½•ä¼šè¯ç”Ÿå‘½å‘¨æœŸ |

---

## 2. é¢†åŸŸæ¨¡å‹

### 2.1 èšåˆå…³ç³»å›¾

```mermaid
classDiagram
    class Account {
        +AccountID id
        +UserID userID
        +List~Credential~ credentials
        +AccountStatus status
        +DateTime createdAt
        +AddCredential(credential)
        +RemoveCredential(type)
        +Authenticate(type, secret)
    }
    
    class Credential {
        +CredentialType type
        +String identifier
        +String secret
        +DateTime createdAt
        +Verify(input)
    }
    
    class Session {
        +SessionID id
        +AccountID accountID
        +DeviceInfo device
        +DateTime createdAt
        +DateTime expiresAt
        +SessionStatus status
        +Refresh()
        +Revoke()
        +IsValid()
    }
    
    class Token {
        +String value
        +TokenType type
        +Claims claims
        +DateTime expiresAt
    }
    
    class Claims {
        +String sub
        +String iss
        +List~String~ aud
        +DateTime exp
        +DateTime iat
        +String uid
        +List~String~ roles
        +String sid
    }
    
    Account "1" --> "*" Credential : contains
    Account "1" --> "*" Session : creates
    Session "1" --> "2" Token : generates
    Token "1" --> "1" Claims : contains
```

### 2.2 Account èšåˆæ ¹

```go
// ä¼ªä»£ç : Account èšåˆæ ¹
// æºç : internal/apiserver/domain/authn/entity/account.go

type Account struct {
    ID          AccountID       // è´¦æˆ·å”¯ä¸€æ ‡è¯†
    UserID      UserID          // å…³è”ç”¨æˆ·ID
    Credentials []Credential    // å‡­è¯åˆ—è¡¨
    Status      AccountStatus   // è´¦æˆ·çŠ¶æ€
    CreatedAt   time.Time
    UpdatedAt   time.Time
}

// æ·»åŠ å‡­è¯
func (a *Account) AddCredential(cred Credential) error {
    // ä¸šåŠ¡è§„åˆ™: åŒç±»å‹å‡­è¯åªèƒ½æœ‰ä¸€ä¸ª
    if a.hasCredentialType(cred.Type) {
        return ErrCredentialTypeExists
    }
    a.Credentials = append(a.Credentials, cred)
    return nil
}

// è®¤è¯
func (a *Account) Authenticate(credType CredentialType, secret string) error {
    cred := a.findCredential(credType)
    if cred == nil {
        return ErrCredentialNotFound
    }
    return cred.Verify(secret)
}
```

### 2.3 Credential å€¼å¯¹è±¡

```go
// ä¼ªä»£ç : Credential å€¼å¯¹è±¡
// æºç : internal/apiserver/domain/authn/valueobject/credential.go

type CredentialType string

const (
    CredentialTypeWeChatUnionID CredentialType = "wechat_unionid"
    CredentialTypeWeChatOpenID  CredentialType = "wechat_openid"
    CredentialTypePhone         CredentialType = "phone"
    CredentialTypePassword      CredentialType = "password"
)

type Credential struct {
    Type       CredentialType  // å‡­è¯ç±»å‹
    Identifier string          // æ ‡è¯†ç¬¦ (unionid/phoneç­‰)
    Secret     string          // å¯†é’¥ (å¯†ç å“ˆå¸Œå€¼)
    CreatedAt  time.Time
}

func (c *Credential) Verify(input string) error {
    switch c.Type {
    case CredentialTypePassword:
        return bcrypt.CompareHashAndPassword([]byte(c.Secret), []byte(input))
    case CredentialTypeWeChatUnionID, CredentialTypeWeChatOpenID:
        if c.Identifier != input {
            return ErrCredentialMismatch
        }
        return nil
    default:
        return ErrUnsupportedCredentialType
    }
}
```

### 2.4 Session èšåˆæ ¹

```go
// ä¼ªä»£ç : Session èšåˆæ ¹
// æºç : internal/apiserver/domain/authn/entity/session.go

type Session struct {
    ID        SessionID      // ä¼šè¯ID
    AccountID AccountID      // è´¦æˆ·ID
    Device    DeviceInfo     // è®¾å¤‡ä¿¡æ¯
    Status    SessionStatus  // ä¼šè¯çŠ¶æ€
    CreatedAt time.Time
    ExpiresAt time.Time
}

type SessionStatus string

const (
    SessionStatusActive  SessionStatus = "active"
    SessionStatusExpired SessionStatus = "expired"
    SessionStatusRevoked SessionStatus = "revoked"
)

// åˆ·æ–°ä¼šè¯
func (s *Session) Refresh(duration time.Duration) error {
    if s.Status != SessionStatusActive {
        return ErrSessionInactive
    }
    s.ExpiresAt = time.Now().Add(duration)
    return nil
}

// åŠé”€ä¼šè¯
func (s *Session) Revoke() {
    s.Status = SessionStatusRevoked
}

// æ£€æŸ¥æœ‰æ•ˆæ€§
func (s *Session) IsValid() bool {
    return s.Status == SessionStatusActive && time.Now().Before(s.ExpiresAt)
}
```

### 2.5 Token å€¼å¯¹è±¡

```go
// ä¼ªä»£ç : Token å€¼å¯¹è±¡
// æºç : internal/apiserver/domain/authn/valueobject/token.go

type TokenType string

const (
    TokenTypeAccess  TokenType = "access"
    TokenTypeRefresh TokenType = "refresh"
)

type Token struct {
    Value     string
    Type      TokenType
    Claims    Claims
    ExpiresAt time.Time
}

type Claims struct {
    // æ ‡å‡† JWT Claims
    Subject   string    `json:"sub"`   // ä¸»é¢˜ (ç”¨æˆ·ID)
    Issuer    string    `json:"iss"`   // ç­¾å‘è€…
    Audience  []string  `json:"aud"`   // å—ä¼—
    ExpiresAt time.Time `json:"exp"`   // è¿‡æœŸæ—¶é—´
    IssuedAt  time.Time `json:"iat"`   // ç­¾å‘æ—¶é—´
    
    // è‡ªå®šä¹‰ Claims
    UserID    string   `json:"uid"`    // ç”¨æˆ·ID
    Roles     []string `json:"roles"`  // è§’è‰²åˆ—è¡¨
    SessionID string   `json:"sid"`    // ä¼šè¯ID
}
```

---

## 3. é¢†åŸŸæœåŠ¡

### 3.1 æœåŠ¡åˆ’åˆ†

```mermaid
graph TB
    subgraph "é¢†åŸŸæœåŠ¡"
        AS[AuthenticationService<br/>è®¤è¯æœåŠ¡]
        TS[TokenService<br/>ä»¤ç‰ŒæœåŠ¡]
        JS[JWKSService<br/>å…¬é’¥æœåŠ¡]
    end
    
    subgraph "èšåˆ"
        Account[Account]
        Session[Session]
    end
    
    AS --> Account
    AS --> Session
    TS --> Session
    JS -.->|å‘å¸ƒå…¬é’¥| External[å¤–éƒ¨æœåŠ¡]
```

### 3.2 AuthenticationService

```go
// ä¼ªä»£ç : è®¤è¯é¢†åŸŸæœåŠ¡
// æºç : internal/apiserver/domain/authn/service/authentication_service.go

type AuthenticationService struct {
    accountRepo  AccountRepository
    sessionRepo  SessionRepository
    strategies   map[CredentialType]AuthStrategy
}

// è®¤è¯å…¥å£
func (s *AuthenticationService) Authenticate(ctx context.Context, req AuthRequest) (*Session, error) {
    // 1. è·å–è®¤è¯ç­–ç•¥
    strategy := s.strategies[req.CredentialType]
    
    // 2. æ‰§è¡Œè®¤è¯
    account, err := strategy.Authenticate(ctx, req)
    if err != nil {
        return nil, err
    }
    
    // 3. åˆ›å»ºä¼šè¯
    session := NewSession(account.ID, req.Device)
    
    // 4. æŒä¹…åŒ–
    if err := s.sessionRepo.Save(ctx, session); err != nil {
        return nil, err
    }
    
    return session, nil
}
```

### 3.3 TokenService

```go
// ä¼ªä»£ç : ä»¤ç‰Œé¢†åŸŸæœåŠ¡
// æºç : internal/apiserver/domain/authn/service/token_service.go

type TokenService struct {
    privateKey  *rsa.PrivateKey
    keyID       string
    issuer      string
}

// ç”Ÿæˆä»¤ç‰Œå¯¹
func (s *TokenService) GenerateTokenPair(session *Session, user *User) (*TokenPair, error) {
    claims := Claims{
        Subject:   session.AccountID.String(),
        Issuer:    s.issuer,
        UserID:    user.ID.String(),
        Roles:     user.Roles,
        SessionID: session.ID.String(),
    }
    
    accessToken := s.generateToken(claims, TokenTypeAccess, 15*time.Minute)
    refreshToken := s.generateToken(claims, TokenTypeRefresh, 7*24*time.Hour)
    
    return &TokenPair{
        AccessToken:  accessToken,
        RefreshToken: refreshToken,
    }, nil
}
```

---

## 4. ç«¯å£å®šä¹‰

### 4.1 ä»“å‚¨ç«¯å£

```go
// ä¼ªä»£ç : ä»“å‚¨ç«¯å£
// æºç : internal/apiserver/domain/authn/port/repository.go

type AccountRepository interface {
    FindByID(ctx context.Context, id AccountID) (*Account, error)
    FindByCredential(ctx context.Context, credType CredentialType, identifier string) (*Account, error)
    Save(ctx context.Context, account *Account) error
}

type SessionRepository interface {
    FindByID(ctx context.Context, id SessionID) (*Session, error)
    FindByAccountID(ctx context.Context, accountID AccountID) ([]*Session, error)
    Save(ctx context.Context, session *Session) error
    Delete(ctx context.Context, id SessionID) error
}
```

### 4.2 å¤–éƒ¨æœåŠ¡ç«¯å£

```go
// ä¼ªä»£ç : å¤–éƒ¨æœåŠ¡ç«¯å£
// æºç : internal/apiserver/domain/authn/port/wechat_client.go

type WeChatClient interface {
    Code2Session(ctx context.Context, code string) (*WeChatSession, error)
}

type WeChatSession struct {
    OpenID     string
    UnionID    string
    SessionKey string
}
```

---

## 5. æºç ç´¢å¼•

| ç»„ä»¶ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| **èšåˆæ ¹** | | |
| Account | `domain/authn/entity/account.go` | è´¦æˆ·èšåˆæ ¹ |
| Session | `domain/authn/entity/session.go` | ä¼šè¯èšåˆæ ¹ |
| **å€¼å¯¹è±¡** | | |
| Credential | `domain/authn/valueobject/credential.go` | å‡­è¯å€¼å¯¹è±¡ |
| Token | `domain/authn/valueobject/token.go` | ä»¤ç‰Œå€¼å¯¹è±¡ |
| Claims | `domain/authn/valueobject/claims.go` | Claimså€¼å¯¹è±¡ |
| **é¢†åŸŸæœåŠ¡** | | |
| AuthenticationService | `domain/authn/service/authentication_service.go` | è®¤è¯æœåŠ¡ |
| TokenService | `domain/authn/service/token_service.go` | ä»¤ç‰ŒæœåŠ¡ |
| **ç«¯å£** | | |
| AccountRepository | `domain/authn/port/repository.go` | è´¦æˆ·ä»“å‚¨ç«¯å£ |
| SessionRepository | `domain/authn/port/repository.go` | ä¼šè¯ä»“å‚¨ç«¯å£ |
| WeChatClient | `domain/authn/port/wechat_client.go` | å¾®ä¿¡å®¢æˆ·ç«¯ç«¯å£ |
