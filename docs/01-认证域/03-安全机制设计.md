# è®¤è¯å®‰å…¨æœºåˆ¶è®¾è®¡

> ğŸ¯ **æ ¸å¿ƒç»“è®º**: é‡‡ç”¨ RS256 éå¯¹ç§°ç­¾å + å¯†é’¥è½®æ¢ + ä¼šè¯é»‘åå•å®ç°å®‰å…¨è®¤è¯

---

## 1. å®‰å…¨æ¶æ„

### 1.1 å®‰å…¨å±‚æ¬¡

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å®‰å…¨æœºåˆ¶åˆ†å±‚                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  L4: ä¼šè¯ç®¡ç†    â”‚  ä¼šè¯è¶…æ—¶ã€å¼ºåˆ¶ç™»å‡ºã€å¹¶å‘æ§åˆ¶            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  L3: Tokenå®‰å…¨   â”‚  RS256ç­¾åã€çŸ­æœŸæœ‰æ•ˆã€åˆ·æ–°æœºåˆ¶            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  L2: å‡­è¯å®‰å…¨    â”‚  å¯†ç å“ˆå¸Œã€é˜²é‡æ”¾æ”»å‡»                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  L1: ä¼ è¾“å®‰å…¨    â”‚  HTTPSã€TLS 1.3                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 å®‰å…¨ç‰¹æ€§

| ç‰¹æ€§ | å®ç°æ–¹å¼ | é˜²æŠ¤ç›®æ ‡ |
|------|---------|---------|
| **JWT ç­¾å** | RS256 éå¯¹ç§°åŠ å¯† | ä»¤ç‰Œä¼ªé€  |
| **å¯†é’¥è½®æ¢** | å®šæœŸè‡ªåŠ¨è½®æ¢ | å¯†é’¥æ³„éœ² |
| **å¯†ç å­˜å‚¨** | BCrypt å“ˆå¸Œ | æ˜æ–‡æ³„éœ² |
| **ä¼šè¯ç®¡ç†** | Redis + é»‘åå• | ä»¤ç‰Œç›—ç”¨ |
| **é€Ÿç‡é™åˆ¶** | æ»‘åŠ¨çª—å£è®¡æ•° | æš´åŠ›ç ´è§£ |

---

## 2. JWT å®‰å…¨

### 2.1 ç­¾åç®—æ³•é€‰æ‹©

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç®—æ³•å¯¹æ¯”                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç®—æ³•     â”‚  ç‰¹ç‚¹               â”‚  é€‚ç”¨åœºæ™¯                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  HS256   â”‚  å¯¹ç§°åŠ å¯†ï¼Œå…±äº«å¯†é’¥  â”‚  å•ä½“åº”ç”¨ï¼Œå¯†é’¥éœ€å®‰å…¨ä¼ è¾“   â”‚
â”‚  RS256 âœ“ â”‚  éå¯¹ç§°ï¼Œå…¬ç§é’¥åˆ†ç¦»  â”‚  å¾®æœåŠ¡ï¼Œä¸šåŠ¡å¯è‡ªè¡ŒéªŒç­¾     â”‚
â”‚  ES256   â”‚  æ¤­åœ†æ›²çº¿ï¼Œç­¾åæ›´çŸ­  â”‚  ç§»åŠ¨ç«¯ï¼Œå¸¦å®½æ•æ„Ÿåœºæ™¯       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é€‰æ‹© RS256 çš„ç†ç”±ï¼š
1. ä¸šåŠ¡æœåŠ¡åªéœ€å…¬é’¥å³å¯éªŒè¯ï¼Œæ— éœ€è®¿é—® IAM
2. ç§é’¥ä»… IAM æŒæœ‰ï¼Œå®‰å…¨æ€§æ›´é«˜
3. æ”¯æŒ JWKS æ ‡å‡†ï¼Œå¯†é’¥è½®æ¢é€æ˜
```

### 2.2 Token ç”Ÿå‘½å‘¨æœŸ

```mermaid
stateDiagram-v2
    [*] --> Issued: ç™»å½•æˆåŠŸ
    Issued --> Valid: æœªè¿‡æœŸ
    Valid --> Expired: è¶…è¿‡ TTL
    Valid --> Refreshed: åˆ·æ–°
    Valid --> Revoked: å¼ºåˆ¶åŠé”€
    Refreshed --> Valid: æ–°Token
    Expired --> [*]
    Revoked --> [*]
```

### 2.3 Token é…ç½®

```yaml
# ä¼ªä»£ç : Token é…ç½®
# æºç : configs/apiserver.yaml

jwt:
  algorithm: RS256
  access_token:
    ttl: 15m              # çŸ­æœŸæœ‰æ•ˆï¼Œé™ä½æ³„éœ²é£é™©
  refresh_token:
    ttl: 168h             # 7å¤©ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
  issuer: "iam.service"
  audience:
    - "qs.service"        # æµ‹è¯„ç³»ç»Ÿ
    - "admin.service"     # ç®¡ç†åå°
```

---

## 3. å¯†é’¥ç®¡ç†

### 3.1 å¯†é’¥è½®æ¢æµç¨‹

```mermaid
sequenceDiagram
    participant Scheduler as å®šæ—¶ä»»åŠ¡
    participant KeyMgr as å¯†é’¥ç®¡ç†å™¨
    participant Redis as Redis
    participant JWKS as JWKSç«¯ç‚¹
    
    Scheduler->>KeyMgr: è§¦å‘è½®æ¢
    KeyMgr->>KeyMgr: ç”Ÿæˆæ–°å¯†é’¥å¯¹
    KeyMgr->>Redis: ä¿å­˜æ–°å¯†é’¥(active)
    KeyMgr->>Redis: æ—§å¯†é’¥->passive
    KeyMgr->>JWKS: æ›´æ–°å…¬é’¥é›†
    
    Note over JWKS: å…¬é’¥é›†åŒ…å«æ–°æ—§å¯†é’¥
    Note over Redis: æ—§å¯†é’¥ä¿ç•™48hååˆ é™¤
```

### 3.2 å¤šå¯†é’¥å¹¶å­˜

```text
æ—¶é—´çº¿ç¤ºæ„:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”>

T1              T2              T3              T4
â”‚               â”‚               â”‚               â”‚
â”‚<â”€â”€ Key-A(ç­¾å‘) â”€â”€>â”‚               â”‚               â”‚
â”‚               â”‚<â”€â”€ Key-B(ç­¾å‘) â”€â”€>â”‚               â”‚
â”‚               â”‚               â”‚<â”€â”€ Key-C(ç­¾å‘) â”€â”€>â”‚
â”‚               â”‚               â”‚
â”‚<â”€â”€â”€â”€â”€â”€ Key-A(éªŒè¯) â”€â”€â”€â”€â”€>â”‚               â”‚
â”‚               â”‚<â”€â”€â”€â”€â”€â”€ Key-B(éªŒè¯) â”€â”€â”€â”€â”€>â”‚
â”‚               â”‚               â”‚<â”€â”€â”€â”€â”€â”€ Key-C(éªŒè¯) â”€â”€â”€â”€â”€>â”‚

è¯´æ˜:
- ç­¾å‘: åªç”¨æœ€æ–°å¯†é’¥ç­¾å‘æ–°Token
- éªŒè¯: æ–°æ—§å¯†é’¥éƒ½å¯éªŒè¯
- è¿‡æ¸¡æœŸ: 48å°æ—¶ï¼Œä¿è¯å·²ç­¾å‘Tokenä»å¯éªŒè¯
```

### 3.3 JWKS ç«¯ç‚¹

```go
// ä¼ªä»£ç : JWKS å“åº”
// æºç : internal/apiserver/domain/authn/service/jwks_service.go

type JWKS struct {
    Keys []JWK `json:"keys"`
}

type JWK struct {
    Kty string `json:"kty"`  // "RSA"
    Kid string `json:"kid"`  // å¯†é’¥IDï¼Œå¯¹åº”Token Header
    Use string `json:"use"`  // "sig"
    Alg string `json:"alg"`  // "RS256"
    N   string `json:"n"`    // RSA modulus (Base64URL)
    E   string `json:"e"`    // RSA exponent (Base64URL)
}

// GET /.well-known/jwks.json
func (s *JWKSService) GetJWKS() *JWKS {
    keys := []JWK{}
    
    // æ·»åŠ æ´»è·ƒå¯†é’¥
    keys = append(keys, s.activeKey.ToJWK())
    
    // æ·»åŠ è¿‡æ¸¡æœŸå¯†é’¥
    for _, key := range s.passiveKeys {
        keys = append(keys, key.ToJWK())
    }
    
    return &JWKS{Keys: keys}
}
```

---

## 4. å¯†ç å®‰å…¨

### 4.1 å¯†ç å“ˆå¸Œ

```go
// ä¼ªä»£ç : å¯†ç å“ˆå¸Œ
// æºç : internal/apiserver/infra/authn/password_hasher.go

const (
    bcryptCost = 12  // 2^12 = 4096 è½®è¿­ä»£
)

func HashPassword(password string) (string, error) {
    // ä½¿ç”¨ BCryptï¼Œè‡ªåŠ¨åŠ ç›
    hash, err := bcrypt.GenerateFromPassword([]byte(password), bcryptCost)
    return string(hash), err
}

func VerifyPassword(password, hash string) error {
    return bcrypt.CompareHashAndPassword([]byte(hash), []byte(password))
}
```

### 4.2 å¯†ç ç­–ç•¥

| ç­–ç•¥ | è¦æ±‚ |
|------|------|
| æœ€å°é•¿åº¦ | 8 å­—ç¬¦ |
| å¤æ‚åº¦ | åŒ…å«å¤§å°å†™å­—æ¯ + æ•°å­— |
| å†å²è®°å½• | ä¸èƒ½ä½¿ç”¨æœ€è¿‘ 5 æ¬¡å¯†ç  |
| è¿‡æœŸæ—¶é—´ | 90 å¤©ï¼ˆå¯é€‰ï¼‰ |

---

## 5. ä¼šè¯å®‰å…¨

### 5.1 ä¼šè¯å­˜å‚¨ç»“æ„

```text
Redis Key è®¾è®¡:

iam:session:{session_id}
â”œâ”€â”€ account_id    # è´¦æˆ·ID
â”œâ”€â”€ device        # è®¾å¤‡ä¿¡æ¯
â”œâ”€â”€ created_at    # åˆ›å»ºæ—¶é—´
â”œâ”€â”€ expires_at    # è¿‡æœŸæ—¶é—´
â””â”€â”€ status        # çŠ¶æ€

iam:account:{account_id}:sessions
â””â”€â”€ Set<session_id>  # è´¦æˆ·çš„æ‰€æœ‰ä¼šè¯

iam:token:blacklist:{jti}
â””â”€â”€ TTL = tokenå‰©ä½™æœ‰æ•ˆæœŸ
```

### 5.2 ä¼šè¯æ§åˆ¶

```mermaid
flowchart TB
    subgraph "ä¼šè¯æ§åˆ¶ç­–ç•¥"
        A[ç™»å½•è¯·æ±‚] --> B{å½“å‰ä¼šè¯æ•°}
        B -->|< 5| C[åˆ›å»ºæ–°ä¼šè¯]
        B -->|>= 5| D[è¸¢å‡ºæœ€æ—©ä¼šè¯]
        D --> C
        
        E[ç™»å‡ºè¯·æ±‚] --> F[æ ‡è®°ä¼šè¯å¤±æ•ˆ]
        F --> G[TokenåŠ å…¥é»‘åå•]
        
        H[å¼ºåˆ¶ç™»å‡º] --> I[æ¸…é™¤æ‰€æœ‰ä¼šè¯]
        I --> J[æ‰€æœ‰Tokenå¤±æ•ˆ]
    end
```

### 5.3 Token åŠé”€

```go
// ä¼ªä»£ç : Token åŠé”€
// æºç : internal/apiserver/infra/authn/token_blacklist.go

type TokenBlacklist interface {
    Add(ctx context.Context, jti string, expiresAt time.Time) error
    IsBlacklisted(ctx context.Context, jti string) (bool, error)
}

// éªŒè¯ Token æ—¶æ£€æŸ¥é»‘åå•
func (s *TokenValidator) Validate(token string) (*Claims, error) {
    claims, err := s.parseAndVerify(token)
    if err != nil {
        return nil, err
    }
    
    // æ£€æŸ¥é»‘åå•
    if blacklisted, _ := s.blacklist.IsBlacklisted(ctx, claims.JTI); blacklisted {
        return nil, ErrTokenRevoked
    }
    
    return claims, nil
}
```

---

## 6. é˜²æŠ¤æœºåˆ¶

### 6.1 é€Ÿç‡é™åˆ¶

```go
// ä¼ªä»£ç : é€Ÿç‡é™åˆ¶
// æºç : internal/apiserver/infra/middleware/rate_limit.go

type RateLimiter struct {
    redis  *redis.Client
    limit  int           // é™åˆ¶æ¬¡æ•°
    window time.Duration // æ—¶é—´çª—å£
}

// æ»‘åŠ¨çª—å£è®¡æ•°
func (r *RateLimiter) Allow(key string) (bool, error) {
    now := time.Now().UnixNano()
    windowStart := now - r.window.Nanoseconds()
    
    pipe := r.redis.Pipeline()
    // ç§»é™¤çª—å£å¤–çš„è®°å½•
    pipe.ZRemRangeByScore(key, "0", strconv.FormatInt(windowStart, 10))
    // æ·»åŠ å½“å‰è¯·æ±‚
    pipe.ZAdd(key, &redis.Z{Score: float64(now), Member: now})
    // è®¡ç®—çª—å£å†…è¯·æ±‚æ•°
    pipe.ZCard(key)
    // è®¾ç½®è¿‡æœŸæ—¶é—´
    pipe.Expire(key, r.window)
    
    results, _ := pipe.Exec()
    count := results[2].(*redis.IntCmd).Val()
    
    return count <= int64(r.limit), nil
}
```

### 6.2 é™åˆ¶é…ç½®

| ç«¯ç‚¹ | é™åˆ¶ | çª—å£ |
|------|------|------|
| ç™»å½• | 5 æ¬¡ | 1 åˆ†é’Ÿ |
| Token åˆ·æ–° | 10 æ¬¡ | 1 åˆ†é’Ÿ |
| å¯†ç é‡ç½® | 3 æ¬¡ | 10 åˆ†é’Ÿ |

### 6.3 é˜²é‡æ”¾æ”»å‡»

```go
// ä¼ªä»£ç : Nonce é˜²é‡æ”¾
// æºç : internal/apiserver/infra/authn/nonce_validator.go

type NonceValidator struct {
    redis *redis.Client
    ttl   time.Duration
}

func (v *NonceValidator) Validate(nonce string, timestamp int64) error {
    // 1. æ£€æŸ¥æ—¶é—´æˆ³æ˜¯å¦åœ¨å…è®¸èŒƒå›´å†…
    now := time.Now().Unix()
    if abs(now-timestamp) > 300 { // 5åˆ†é’Ÿ
        return ErrTimestampExpired
    }
    
    // 2. æ£€æŸ¥ nonce æ˜¯å¦å·²ä½¿ç”¨
    key := fmt.Sprintf("nonce:%s", nonce)
    exists, _ := v.redis.SetNX(key, "1", v.ttl).Result()
    if !exists {
        return ErrNonceReused
    }
    
    return nil
}
```

---

## 7. é…ç½®æ±‡æ€»

```yaml
# å®‰å…¨ç›¸å…³é…ç½®
# æºç : configs/apiserver.yaml

security:
  jwt:
    algorithm: RS256
    access_token_ttl: 15m
    refresh_token_ttl: 168h
    
  key_rotation:
    enabled: true
    period: 720h          # 30å¤©
    retention: 48h        # æ—§å¯†é’¥ä¿ç•™æ—¶é—´
    
  password:
    bcrypt_cost: 12
    min_length: 8
    require_uppercase: true
    require_number: true
    
  session:
    max_concurrent: 5
    idle_timeout: 30m
    absolute_timeout: 24h
    
  rate_limit:
    login:
      limit: 5
      window: 1m
    token_refresh:
      limit: 10
      window: 1m
```

---

## 8. æºç ç´¢å¼•

| ç»„ä»¶ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| **å¯†é’¥ç®¡ç†** | | |
| KeyManager | `domain/authn/service/key_manager.go` | å¯†é’¥ç”Ÿå‘½å‘¨æœŸç®¡ç† |
| JWKSService | `domain/authn/service/jwks_service.go` | JWKS ç«¯ç‚¹æœåŠ¡ |
| **å¯†ç å®‰å…¨** | | |
| PasswordHasher | `infra/authn/password_hasher.go` | BCrypt å“ˆå¸Œ |
| PasswordValidator | `domain/authn/service/password_validator.go` | å¯†ç ç­–ç•¥éªŒè¯ |
| **ä¼šè¯ç®¡ç†** | | |
| SessionStore | `infra/authn/redis/session_store.go` | Redis ä¼šè¯å­˜å‚¨ |
| TokenBlacklist | `infra/authn/token_blacklist.go` | Token é»‘åå• |
| **é˜²æŠ¤æœºåˆ¶** | | |
| RateLimiter | `infra/middleware/rate_limit.go` | é€Ÿç‡é™åˆ¶ |
| NonceValidator | `infra/authn/nonce_validator.go` | Nonce éªŒè¯ |
