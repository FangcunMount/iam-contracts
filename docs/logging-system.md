# æ—¥å¿—æ¨¡å—è®¾è®¡

## ğŸ¯ è®¾è®¡ç†å¿µ

æ—¥å¿—ç³»ç»Ÿæ˜¯æ¡†æ¶çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼ŒåŸºäºZapé«˜æ€§èƒ½æ—¥å¿—åº“æ„å»ºï¼Œæä¾›ç»“æ„åŒ–æ—¥å¿—è®°å½•ã€å¤šçº§åˆ«æ—¥å¿—ã€æ—¥å¿—è½®è½¬ç­‰åŠŸèƒ½ã€‚ç³»ç»Ÿæ”¯æŒå¤šç§è¾“å‡ºæ ¼å¼å’Œè¾“å‡ºç›®æ ‡ï¼Œæ»¡è¶³ä¸åŒç¯å¢ƒä¸‹çš„æ—¥å¿—éœ€æ±‚ã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Logging System                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                Log Interface                            â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚
â”‚  â”‚  â”‚   Debug     â”‚  â”‚    Info     â”‚  â”‚    Error    â”‚    â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                Output Targets                           â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚
â”‚  â”‚  â”‚   Console   â”‚  â”‚    File     â”‚  â”‚   Network   â”‚    â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                Log Formats                              â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚
â”‚  â”‚  â”‚   Console   â”‚  â”‚     JSON    â”‚  â”‚   Custom    â”‚    â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ æ ¸å¿ƒç»„ä»¶

### é…ç½®é€‰é¡¹

```go
// Options æ—¥å¿—é…ç½®é€‰é¡¹
type Options struct {
    Level             string   `json:"level" mapstructure:"level"`
    Format            string   `json:"format" mapstructure:"format"`
    EnableColor       bool     `json:"enable-color" mapstructure:"enable-color"`
    DisableCaller     bool     `json:"disable-caller" mapstructure:"disable-caller"`
    DisableStacktrace bool     `json:"disable-stacktrace" mapstructure:"disable-stacktrace"`
    Development       bool     `json:"development" mapstructure:"development"`
    Name              string   `json:"name" mapstructure:"name"`
    OutputPaths       []string `json:"output-paths" mapstructure:"output-paths"`
    ErrorOutputPaths  []string `json:"error-output-paths" mapstructure:"error-output-paths"`
    MaxSize           int      `json:"max-size" mapstructure:"max-size"`
    MaxAge            int      `json:"max-age" mapstructure:"max-age"`
    MaxBackups        int      `json:"max-backups" mapstructure:"max-backups"`
    Compress          bool     `json:"compress" mapstructure:"compress"`
}
```

### é»˜è®¤é…ç½®

```go
// NewOptions åˆ›å»ºé»˜è®¤é…ç½®
func NewOptions() *Options {
    return &Options{
        Level:             "info",
        Format:            "console",
        EnableColor:       false,
        DisableCaller:     false,
        DisableStacktrace: false,
        Development:       false,
        Name:              "",
        OutputPaths:       []string{"stdout"},
        ErrorOutputPaths:  []string{"stderr"},
        MaxSize:           100,    // 100MB
        MaxAge:            30,     // 30å¤©
        MaxBackups:        10,     // 10ä¸ªå¤‡ä»½
        Compress:          true,   // å‹ç¼©
    }
}
```

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬åˆå§‹åŒ–

```go
// ä½¿ç”¨é»˜è®¤é…ç½®
log.Init(nil)
defer log.Flush()

// ä½¿ç”¨è‡ªå®šä¹‰é…ç½®
opts := &log.Options{
    Level:      "debug",
    Format:     "json",
    OutputPaths: []string{"stdout", "/var/log/app.log"},
}
log.Init(opts)
defer log.Flush()
```

### åŸºæœ¬æ—¥å¿—è®°å½•

```go
// ä¸åŒçº§åˆ«çš„æ—¥å¿—
log.Debug("Debug message")
log.Info("Info message")
log.Warn("Warning message")
log.Error("Error message")
log.Fatal("Fatal message")  // ä¼šè°ƒç”¨os.Exit(1)
log.Panic("Panic message")  // ä¼šè°ƒç”¨panic

// æ ¼å¼åŒ–æ—¥å¿—
log.Infof("User %s logged in", username)
log.Errorf("Failed to connect to %s: %v", host, err)

// ç»“æ„åŒ–æ—¥å¿—ï¼ˆæ¨èï¼‰
log.Infow("User login",
    "user_id", 123,
    "ip", "192.168.1.1",
    "user_agent", "Mozilla/5.0...",
)

log.Errorw("Database error",
    "table", "users",
    "operation", "insert",
    "error", err,
)
```

### å­—æ®µåŒ–æ—¥å¿—

```go
// ä½¿ç”¨ç±»å‹åŒ–å­—æ®µï¼ˆæ€§èƒ½æ›´å¥½ï¼‰
log.Info("Request processed",
    log.String("method", "POST"),
    log.String("path", "/api/users"),
    log.Int("status", 200),
    log.Duration("latency", time.Millisecond*15),
    log.Int64("user_id", 12345),
    log.Bool("cached", true),
    log.Any("headers", headers),
)

// å¸¸ç”¨å­—æ®µç±»å‹
log.String("key", "value")          // å­—ç¬¦ä¸²
log.Int("count", 10)                // æ•´æ•°
log.Float64("score", 95.5)          // æµ®ç‚¹æ•°
log.Bool("success", true)           // å¸ƒå°”å€¼
log.Duration("latency", duration)   // æ—¶é—´é—´éš”
log.Time("timestamp", time.Now())   // æ—¶é—´
log.Err(err)                        // é”™è¯¯
log.Any("data", complexObject)      // ä»»æ„ç±»å‹
```

## ğŸ”„ é«˜çº§åŠŸèƒ½

### ä¸Šä¸‹æ–‡æ—¥å¿—

```go
// å°†loggerå­˜å…¥context
ctx := log.WithContext(context.Background())

// ä»contextè·å–logger
logger := log.FromContext(ctx)
logger.Info("Operation completed")

// åœ¨HTTPå¤„ç†å™¨ä¸­ä½¿ç”¨
func handler(w http.ResponseWriter, r *http.Request) {
    ctx := r.Context()
    logger := log.FromContext(ctx)
    logger.Info("Handling request", 
        log.String("method", r.Method),
        log.String("path", r.URL.Path),
    )
}
```

### å…·åLogger

```go
// åˆ›å»ºå…·ålogger
userLogger := log.WithName("user-service")
userLogger.Info("User service started")

// åˆ›å»ºå¸¦é»˜è®¤å­—æ®µçš„logger
requestLogger := log.WithValues(
    "request_id", "req-123",
    "user_id", 456,
)
requestLogger.Info("Processing request")
requestLogger.Error("Request failed")
```

### çº§åˆ«æ§åˆ¶

```go
// æ£€æŸ¥çº§åˆ«æ˜¯å¦å¯ç”¨
if log.V(log.DebugLevel).Enabled() {
    log.V(log.DebugLevel).Info("Expensive debug operation")
}

// æ¡ä»¶æ—¥å¿—
if log.V(1).Enabled() {
    log.V(1).Info("Verbose logging enabled")
}
```

## ğŸ“Š æ—¥å¿—è½®è½¬

### é…ç½®è½®è½¬

```go
opts := &log.Options{
    OutputPaths: []string{"/var/log/app.log"},
    MaxSize:     100,    // 100MB
    MaxAge:      30,     // 30å¤©
    MaxBackups:  10,     // ä¿ç•™10ä¸ªæ—§æ–‡ä»¶
    Compress:    true,   // å‹ç¼©æ—§æ–‡ä»¶
}
log.Init(opts)
```

### è½®è½¬è¡Œä¸º

- å½“æ—¥å¿—æ–‡ä»¶è¾¾åˆ°`MaxSize`æ—¶ï¼Œä¼šè‡ªåŠ¨è½®è½¬
- æ—§æ–‡ä»¶ä¼šè¢«é‡å‘½åä¸º`app.log.2024-01-01.1.gz`
- è¶…è¿‡`MaxAge`å¤©çš„æ–‡ä»¶ä¼šè¢«è‡ªåŠ¨åˆ é™¤
- æœ€å¤šä¿ç•™`MaxBackups`ä¸ªæ—§æ–‡ä»¶
- å¦‚æœå¯ç”¨`Compress`ï¼Œæ—§æ–‡ä»¶ä¼šè¢«å‹ç¼©

## ğŸ¨ è¾“å‡ºæ ¼å¼

### Consoleæ ¼å¼

```go
opts := &log.Options{
    Format:      "console",
    EnableColor: true,
    OutputPaths: []string{"stdout"},
}
```

è¾“å‡ºç¤ºä¾‹ï¼š

```text
2024-01-01T12:00:00.000Z    INFO    user-service/main.go:25    User service started
2024-01-01T12:00:01.000Z    INFO    user-service/handler.go:15    User login    {"user_id": 123, "ip": "192.168.1.1"}
```

### JSONæ ¼å¼

```go
opts := &log.Options{
    Format:      "json",
    OutputPaths: []string{"stdout"},
}
```

è¾“å‡ºç¤ºä¾‹ï¼š

```json
{
  "level": "info",
  "ts": 1704110400.000,
  "caller": "user-service/main.go:25",
  "msg": "User service started",
  "service": "user-service"
}
{
  "level": "info",
  "ts": 1704110401.000,
  "caller": "user-service/handler.go:15",
  "msg": "User login",
  "user_id": 123,
  "ip": "192.168.1.1"
}
```

## ğŸ”§ ä¸­é—´ä»¶é›†æˆ

### HTTPæ—¥å¿—ä¸­é—´ä»¶

```go
func LoggingMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        start := time.Now()
        
        // åˆ›å»ºè¯·æ±‚ä¸“ç”¨logger
        requestLogger := log.WithValues(
            "request_id", generateRequestID(),
            "method", c.Request.Method,
            "path", c.Request.URL.Path,
            "remote_addr", c.ClientIP(),
        )
        
        // å°†loggerå­˜å…¥context
        ctx := requestLogger.WithContext(c.Request.Context())
        c.Request = c.Request.WithContext(ctx)
        
        requestLogger.Info("Request started")
        
        // å¤„ç†è¯·æ±‚
        c.Next()
        
        // è®°å½•å“åº”
        requestLogger.Info("Request completed",
            log.Int("status", c.Writer.Status()),
            log.Duration("latency", time.Since(start)),
        )
    }
}
```

### é”™è¯¯æ—¥å¿—ä¸­é—´ä»¶

```go
func ErrorLoggingMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        c.Next()
        
        // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
        if len(c.Errors) > 0 {
            logger := log.FromContext(c.Request.Context())
            for _, err := range c.Errors {
                logger.Errorw("Request error",
                    "error", err.Error(),
                    "type", err.Type,
                    "meta", err.Meta,
                )
            }
        }
    }
}
```

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•

```go
func TestLogger(t *testing.T) {
    // åˆ›å»ºæµ‹è¯•é…ç½®
    opts := &log.Options{
        Level:      "debug",
        Format:     "console",
        OutputPaths: []string{"stdout"},
    }
    log.Init(opts)
    defer log.Flush()
    
    // æµ‹è¯•æ—¥å¿—è®°å½•
    log.Info("Test message")
    log.Error("Test error")
}
```

### æ€§èƒ½æµ‹è¯•

```go
func BenchmarkLogger(b *testing.B) {
    opts := &log.Options{
        Level:      "info",
        Format:     "json",
        OutputPaths: []string{"/dev/null"},
    }
    log.Init(opts)
    defer log.Flush()
    
    b.ResetTimer()
    for i := 0; i < b.N; i++ {
        log.Info("Benchmark message",
            log.Int("iteration", i),
            log.String("test", "performance"),
        )
    }
}
```

## ğŸ¯ æœ€ä½³å®è·µ

### 1. æ—¥å¿—çº§åˆ«ä½¿ç”¨

- **Debug**: è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼Œä»…åœ¨å¼€å‘ç¯å¢ƒä½¿ç”¨
- **Info**: ä¸€èˆ¬ä¿¡æ¯ï¼Œè®°å½•é‡è¦çš„ä¸šåŠ¡äº‹ä»¶
- **Warn**: è­¦å‘Šä¿¡æ¯ï¼Œä¸å½±å“ç³»ç»Ÿè¿è¡Œä½†éœ€è¦æ³¨æ„
- **Error**: é”™è¯¯ä¿¡æ¯ï¼Œå½±å“åŠŸèƒ½ä½†ç³»ç»Ÿå¯ä»¥ç»§ç»­è¿è¡Œ
- **Fatal**: è‡´å‘½é”™è¯¯ï¼Œç³»ç»Ÿæ— æ³•ç»§ç»­è¿è¡Œ
- **Panic**: ä¸¥é‡é”™è¯¯ï¼Œä¼šè§¦å‘panic

### 2. ç»“æ„åŒ–æ—¥å¿—

```go
// æ¨èï¼šä½¿ç”¨ç»“æ„åŒ–å­—æ®µ
log.Info("User operation", 
    log.String("action", "login"),
    log.Int("user_id", 123),
    log.Duration("latency", time.Millisecond*15),
)

// ä¸æ¨èï¼šä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥
log.Info("User " + username + " logged in with ID " + strconv.Itoa(userID))
```

### 3. é”™è¯¯æ—¥å¿—

```go
// æ¨èï¼šè®°å½•é”™è¯¯è¯¦æƒ…
log.Errorw("Database operation failed",
    "table", "users",
    "operation", "insert",
    "user_id", userID,
    "error", err,
)

// ä¸æ¨èï¼šåªè®°å½•é”™è¯¯æ¶ˆæ¯
log.Error("Database error: " + err.Error())
```

### 4. æ€§èƒ½è€ƒè™‘

```go
// æ¨èï¼šæ¡ä»¶æ—¥å¿—
if log.V(log.DebugLevel).Enabled() {
    log.V(log.DebugLevel).Info("Expensive debug operation",
        log.Any("data", expensiveData),
    )
}

// ä¸æ¨èï¼šæ— æ¡ä»¶è®°å½•
log.Debug("Expensive debug operation", log.Any("data", expensiveData))
```

### 5. ä¸Šä¸‹æ–‡ä¼ é€’

```go
// æ¨èï¼šåœ¨contextä¸­ä¼ é€’logger
func processRequest(ctx context.Context, data interface{}) error {
    logger := log.FromContext(ctx)
    logger.Info("Processing request", log.Any("data", data))
    // ...
}

// ä½¿ç”¨
ctx := log.WithContext(context.Background())
err := processRequest(ctx, data)
```

## ğŸ“ˆ ç›‘æ§å’Œå‘Šè­¦

### æ—¥å¿—èšåˆ

- ä½¿ç”¨ELK Stack (Elasticsearch, Logstash, Kibana)
- ä½¿ç”¨Fluentdè¿›è¡Œæ—¥å¿—æ”¶é›†
- ä½¿ç”¨Prometheus + Grafanaè¿›è¡Œç›‘æ§

### å‘Šè­¦è§„åˆ™

```yaml
# Prometheuså‘Šè­¦è§„åˆ™ç¤ºä¾‹
groups:
  - name: application_alerts
    rules:
      - alert: HighErrorRate
        expr: rate(log_errors_total[5m]) > 0.1
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value }} errors per second"
```

### æ—¥å¿—åˆ†æ

```sql
-- åˆ†æé”™è¯¯æ—¥å¿—
SELECT 
    DATE(timestamp) as date,
    COUNT(*) as error_count,
    error_type
FROM logs 
WHERE level = 'error' 
GROUP BY DATE(timestamp), error_type
ORDER BY date DESC;
```
