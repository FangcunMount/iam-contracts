# 框架设计总览

## 🎯 设计理念

iam contracts 基于**六边形架构（Hexagonal Architecture）**设计，也称为端口与适配器模式（Ports and Adapters Pattern）。这种架构的核心思想是将业务逻辑与外部依赖分离，使系统更加灵活、可测试和可维护。

## 🏗️ 架构层次

```text
┌─────────────────────────────────────────────────────────────┐
│                    Interface Layer                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   REST API  │  │   gRPC API  │  │   CLI       │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                  Application Layer                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   Services  │  │   DTOs      │  │   Mappers   │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                    Domain Layer                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   Entities  │  │   Ports     │  │   Services  │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                infra Layer                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   MySQL     │  │   Redis     │  │   HTTP      │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
```

## 📁 项目结构

```text
iam-contracts/
├── cmd/                           # 应用程序入口
│   └── apiserver/                # API服务器入口
├── configs/                      # 配置文件
│   ├── apiserver.yaml           # 完整配置
│   ├── apiserver-simple.yaml    # 简化配置
│   └── env/                     # 环境变量配置
├── internal/                     # 内部包
│   ├── apiserver/               # API服务器核心
│   │   ├── application/         # 应用层
│   │   │   ├── user/           # 用户应用服务
│   │   │   └── auth/           # 认证应用服务
│   │   ├── container/          # 依赖注入容器
│   │   │   └── assembler/      # 模块组装器
│   │   ├── domain/             # 领域层
│   │   │   ├── user/           # 用户领域模型
│   │   │   └── port/           # 端口定义
│   │   ├── infra/     # 基础设施层
│   │   │   ├── mysql/          # MySQL适配器
│   │   │   └── redis/          # Redis适配器
│   │   └── interface/          # 接口层
│   │       ├── restful/        # REST API
│   │       └── grpc/           # gRPC API
│   └── pkg/                    # 内部共享包
│       ├── options/            # 配置选项
│       ├── server/             # 服务器组件
│       └── middleware/         # 中间件
├── pkg/                        # 公共包
│   ├── database/               # 数据库抽象
│   ├── log/                    # 日志系统
│   ├── errors/                 # 错误处理
│   └── auth/                   # 认证工具
└── scripts/                    # 脚本工具
    └── base/                   # 脚本基础库
```

## 🔧 核心组件

### 1. 依赖注入容器 (Container)

负责管理所有模块的依赖注入和生命周期，实现松耦合的模块组装。

```go
container := container.NewContainer(mysqlDB)
container.Initialize()
```

### 2. 数据库注册器 (Registry)

提供统一的数据库连接管理，支持多种数据库类型。

```go
registry := database.NewRegistry()
registry.Register(databases.MySQL, config, connection)
```

### 3. 配置管理 (Options)

基于Viper的配置管理系统，支持多种配置源。

```go
opts := options.NewOptions()
viper.Unmarshal(opts)
```

### 4. 日志系统 (Log)

基于Zap的高性能日志系统，支持结构化日志。

```go
log.Init(&log.Options{
    Level: "info",
    Format: "json",
})
```

## 🎨 设计原则

### 1. 依赖倒置原则 (DIP)

- 高层模块不依赖低层模块
- 抽象不依赖具体实现
- 具体实现依赖抽象

### 2. 单一职责原则 (SRP)

- 每个模块只负责一个功能领域
- 清晰的模块边界
- 高内聚、低耦合

### 3. 开闭原则 (OCP)

- 对扩展开放
- 对修改关闭
- 通过接口实现扩展

### 4. 接口隔离原则 (ISP)

- 客户端不应该依赖它不需要的接口
- 接口应该小而精确
- 避免胖接口

## 🔄 数据流

```text
HTTP Request → Middleware → Handler → Service → Repository → Database
                ↓
HTTP Response ← Middleware ← Handler ← Service ← Repository ← Database
```

## 🧪 测试策略

### 1. 单元测试

- 领域逻辑测试
- 应用服务测试
- 工具函数测试

### 2. 集成测试

- 数据库集成测试
- API集成测试
- 容器集成测试

### 3. 端到端测试

- 完整业务流程测试
- 性能测试
- 压力测试

## 📈 扩展指南

### 添加新模块

1. 在`domain`层定义实体和端口
2. 在`application`层实现应用服务
3. 在`infra`层实现适配器
4. 在`interface`层实现API接口
5. 在`container`层组装模块

### 添加新数据库

1. 实现`DatabaseConnection`接口
2. 在`databases`包中注册新类型
3. 更新配置选项
4. 添加相应的适配器

## 🎯 最佳实践

1. **保持领域纯净**: 领域层不依赖外部框架
2. **使用依赖注入**: 通过容器管理依赖关系
3. **统一错误处理**: 使用统一的错误码和消息
4. **结构化日志**: 使用字段化日志记录
5. **配置外部化**: 所有配置都应该可配置
6. **健康检查**: 提供完整的健康检查机制
