# å…­è¾¹å½¢æ¶æ„å®¹å™¨è®¾è®¡

## ğŸ¯ å®¹å™¨è®¾è®¡ç†å¿µ

ä¾èµ–æ³¨å…¥å®¹å™¨æ˜¯å…­è¾¹å½¢æ¶æ„çš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£ç®¡ç†æ‰€æœ‰æ¨¡å—çš„ä¾èµ–å…³ç³»ã€ç”Ÿå‘½å‘¨æœŸå’Œæ¨¡å—ç»„è£…ã€‚å®¹å™¨å®ç°äº†æ¾è€¦åˆçš„æ¨¡å—è®¾è®¡ï¼Œä½¿å¾—ç³»ç»Ÿæ›´åŠ çµæ´»ã€å¯æµ‹è¯•å’Œå¯ç»´æŠ¤ã€‚

## ğŸ—ï¸ å®¹å™¨æ¶æ„

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Container                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    Modules                              â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚
â”‚  â”‚  â”‚ UserModule  â”‚  â”‚ AuthModule  â”‚  â”‚ OtherModule â”‚    â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                infra                           â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚
â”‚  â”‚  â”‚   MySQL     â”‚  â”‚   Redis     â”‚  â”‚   HTTP      â”‚    â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ å®¹å™¨å®ç°

### å®¹å™¨ç»“æ„

```go
// Container å®¹å™¨
type Container struct {
    // æ•°æ®åº“è¿æ¥
    mysqlDB *gorm.DB

    // ä¸šåŠ¡æ¨¡å—
    AuthModule *assembler.AuthModule
    UserModule *assembler.UserModule

    // å®¹å™¨çŠ¶æ€
    initialized bool
}
```

### å®¹å™¨åˆ›å»º

```go
// NewContainer åˆ›å»ºå®¹å™¨
func NewContainer(mysqlDB *gorm.DB) *Container {
    return &Container{
        mysqlDB: mysqlDB,
    }
}
```

### å®¹å™¨åˆå§‹åŒ–

```go
// Initialize åˆå§‹åŒ–å®¹å™¨
func (c *Container) Initialize() error {
    if c.initialized {
        return fmt.Errorf("container already initialized")
    }

    // åˆå§‹åŒ–è®¤è¯æ¨¡å—
    if err := c.initAuthModule(); err != nil {
        return fmt.Errorf("failed to initialize auth module: %w", err)
    }

    // åˆå§‹åŒ–ç”¨æˆ·æ¨¡å—
    if err := c.initUserModule(); err != nil {
        return fmt.Errorf("failed to initialize user module: %w", err)
    }

    c.initialized = true
    fmt.Printf("ğŸ—ï¸  Container initialized with modules: user, auth\n")

    return nil
}
```

## ğŸ”§ æ¨¡å—ç»„è£…å™¨

### æ¨¡å—æ¥å£

```go
// Module æ¨¡å—æ¥å£
type Module interface {
    // Initialize åˆå§‹åŒ–æ¨¡å—
    Initialize(db *gorm.DB) error
    
    // CheckHealth å¥åº·æ£€æŸ¥
    CheckHealth() error
    
    // Cleanup æ¸…ç†èµ„æº
    Cleanup() error
    
    // ModuleInfo æ¨¡å—ä¿¡æ¯
    ModuleInfo() ModuleInfo
}
```

### ç”¨æˆ·æ¨¡å—ç»„è£…å™¨

```go
// UserModule ç”¨æˆ·æ¨¡å—
type UserModule struct {
    // handler å±‚
    UserHandler *handler.UserHandler
}

// NewUserModule åˆ›å»ºç”¨æˆ·æ¨¡å—
func NewUserModule() *UserModule {
    return &UserModule{}
}

// Initialize åˆå§‹åŒ–ç”¨æˆ·æ¨¡å—
func (m *UserModule) Initialize(db *gorm.DB) error {
    if db == nil {
        return errors.WithCode(code.ErrModuleInitializationFailed, "database connection is nil")
    }

    // åˆå§‹åŒ– handler å±‚
    m.UserHandler = handler.NewUserHandler()
    
    return nil
}
```

### è®¤è¯æ¨¡å—ç»„è£…å™¨

```go
// AuthModule è®¤è¯æ¨¡å—
type AuthModule struct {
    // è¿™é‡Œå¯ä»¥æ·»åŠ è®¤è¯ç›¸å…³çš„ç»„ä»¶
}

// NewAuthModule åˆ›å»ºè®¤è¯æ¨¡å—
func NewAuthModule() *AuthModule {
    return &AuthModule{}
}

// Initialize åˆå§‹åŒ–è®¤è¯æ¨¡å—
func (m *AuthModule) Initialize(db *gorm.DB) error {
    if db == nil {
        return errors.WithCode(code.ErrModuleInitializationFailed, "database connection is nil")
    }

    // è¿™é‡Œå¯ä»¥åˆå§‹åŒ–è®¤è¯ç›¸å…³çš„ç»„ä»¶
    // ç›®å‰ç®€åŒ–å¤„ç†ï¼Œä¸ä¾èµ–å…·ä½“çš„ä¸šåŠ¡é€»è¾‘
    
    return nil
}
```

## ğŸ”„ ç”Ÿå‘½å‘¨æœŸç®¡ç†

### åˆå§‹åŒ–æµç¨‹

```go
// 1. åˆ›å»ºå®¹å™¨
container := container.NewContainer(mysqlDB)

// 2. åˆå§‹åŒ–å®¹å™¨
if err := container.Initialize(); err != nil {
    log.Fatalf("Failed to initialize container: %v", err)
}

// 3. ä½¿ç”¨æ¨¡å—
userHandler := container.UserModule.UserHandler
authModule := container.AuthModule
```

### å¥åº·æ£€æŸ¥

```go
// HealthCheck å¥åº·æ£€æŸ¥
func (c *Container) HealthCheck(ctx context.Context) error {
    // æ£€æŸ¥MySQLè¿æ¥
    if c.mysqlDB != nil {
        if err := c.mysqlDB.WithContext(ctx).Raw("SELECT 1").Error; err != nil {
            return fmt.Errorf("mysql health check failed: %w", err)
        }
    }

    return nil
}
```

### çŠ¶æ€ç›‘æ§

```go
// PrintStatus æ‰“å°å®¹å™¨çŠ¶æ€
func (c *Container) PrintStatus() {
    fmt.Printf("ğŸ“Š Container Status:\n")
    fmt.Printf("   â€¢ Initialized: %t\n", c.initialized)
    
    // æ•°æ®åº“è¿æ¥çŠ¶æ€
    fmt.Printf("   â€¢ MySQL: ")
    if c.mysqlDB != nil {
        fmt.Printf("âœ…\n")
    } else {
        fmt.Printf("âŒ\n")
    }

    // æ¨¡å—çŠ¶æ€
    fmt.Printf("   â€¢ Auth Module: ")
    if c.AuthModule != nil {
        fmt.Printf("âœ…\n")
    } else {
        fmt.Printf("âŒ\n")
    }

    fmt.Printf("   â€¢ User Module: ")
    if c.UserModule != nil {
        fmt.Printf("âœ…\n")
    } else {
        fmt.Printf("âŒ\n")
    }
}
```

## ğŸ¨ è®¾è®¡æ¨¡å¼

### 1. ä¾èµ–æ³¨å…¥æ¨¡å¼

å®¹å™¨é€šè¿‡ä¾èµ–æ³¨å…¥ç®¡ç†æ¨¡å—é—´çš„ä¾èµ–å…³ç³»ï¼Œå®ç°æ¾è€¦åˆã€‚

```go
// æ¨¡å—ä¾èµ–æ³¨å…¥
func (c *Container) initUserModule() error {
    userModule := assembler.NewUserModule()
    if err := userModule.Initialize(c.mysqlDB); err != nil {
        return fmt.Errorf("failed to initialize user module: %w", err)
    }
    c.UserModule = userModule
    return nil
}
```

### 2. å·¥å‚æ¨¡å¼

ä½¿ç”¨å·¥å‚æ¨¡å¼åˆ›å»ºæ¨¡å—å®ä¾‹ã€‚

```go
// æ¨¡å—å·¥å‚
func NewUserModule() *UserModule {
    return &UserModule{}
}

func NewAuthModule() *AuthModule {
    return &AuthModule{}
}
```

### 3. æ¨¡æ¿æ–¹æ³•æ¨¡å¼

å®šä¹‰æ¨¡å—çš„æ ‡å‡†ç”Ÿå‘½å‘¨æœŸã€‚

```go
// æ¨¡å—ç”Ÿå‘½å‘¨æœŸæ¨¡æ¿
type Module interface {
    Initialize(db *gorm.DB) error
    CheckHealth() error
    Cleanup() error
}
```

## ğŸ“ˆ æ‰©å±•æŒ‡å—

### æ·»åŠ æ–°æ¨¡å—

1.**å®šä¹‰æ¨¡å—æ¥å£**

```go
type NewModule struct {
    // æ¨¡å—ç»„ä»¶
    Handler *handler.NewHandler
    Service *service.NewService
}
```

2.**å®ç°æ¨¡å—æ–¹æ³•**

```go
func (m *NewModule) Initialize(db *gorm.DB) error {
    // åˆå§‹åŒ–é€»è¾‘
    return nil
}

func (m *NewModule) CheckHealth() error {
    // å¥åº·æ£€æŸ¥é€»è¾‘
    return nil
}

func (m *NewModule) Cleanup() error {
    // æ¸…ç†é€»è¾‘
    return nil
}
```

3.**åœ¨å®¹å™¨ä¸­æ³¨å†Œ**

```go
// åœ¨Containerç»“æ„ä½“ä¸­æ·»åŠ 
type Container struct {
    // ... å…¶ä»–å­—æ®µ
    NewModule *assembler.NewModule
}

// åœ¨Initializeæ–¹æ³•ä¸­åˆå§‹åŒ–
func (c *Container) Initialize() error {
    // ... å…¶ä»–åˆå§‹åŒ–
    
    // åˆå§‹åŒ–æ–°æ¨¡å—
    if err := c.initNewModule(); err != nil {
        return fmt.Errorf("failed to initialize new module: %w", err)
    }
    
    return nil
}

func (c *Container) initNewModule() error {
    newModule := assembler.NewNewModule()
    if err := newModule.Initialize(c.mysqlDB); err != nil {
        return fmt.Errorf("failed to initialize new module: %w", err)
    }
    c.NewModule = newModule
    return nil
}
```

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•

```go
func TestContainer_Initialize(t *testing.T) {
    // åˆ›å»ºæµ‹è¯•æ•°æ®åº“
    db := setupTestDB(t)
    
    // åˆ›å»ºå®¹å™¨
    container := container.NewContainer(db)
    
    // æµ‹è¯•åˆå§‹åŒ–
    err := container.Initialize()
    assert.NoError(t, err)
    assert.True(t, container.IsInitialized())
    assert.NotNil(t, container.UserModule)
    assert.NotNil(t, container.AuthModule)
}
```

### é›†æˆæµ‹è¯•

```go
func TestContainer_HealthCheck(t *testing.T) {
    // åˆ›å»ºå®¹å™¨
    container := setupContainer(t)
    
    // æµ‹è¯•å¥åº·æ£€æŸ¥
    ctx := context.Background()
    err := container.HealthCheck(ctx)
    assert.NoError(t, err)
}
```

## ğŸ¯ æœ€ä½³å®è·µ

1. **å•ä¸€èŒè´£**: æ¯ä¸ªæ¨¡å—åªè´Ÿè´£ä¸€ä¸ªä¸šåŠ¡é¢†åŸŸ
2. **ä¾èµ–æ³¨å…¥**: é€šè¿‡å®¹å™¨ç®¡ç†ä¾èµ–å…³ç³»
3. **ç”Ÿå‘½å‘¨æœŸç®¡ç†**: ç»Ÿä¸€çš„åˆå§‹åŒ–å’Œæ¸…ç†æµç¨‹
4. **å¥åº·æ£€æŸ¥**: æä¾›å®Œæ•´çš„å¥åº·æ£€æŸ¥æœºåˆ¶
5. **çŠ¶æ€ç›‘æ§**: å®æ—¶ç›‘æ§å®¹å™¨å’Œæ¨¡å—çŠ¶æ€
6. **é”™è¯¯å¤„ç†**: ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
