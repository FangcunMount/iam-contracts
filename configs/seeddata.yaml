# ============================================================================
# IAM Contracts 种子数据配置文件
# ============================================================================
# 描述: 初始化系统所需的基础数据和测试数据
# 版本: 3.0.0
# 更新时间: 2025-11-01
# 说明: 与数据库迁移文件同步 (internal/pkg/migration/migrations/)
# ============================================================================

# ==================== 0. 加密配置 ====================
# IDP 模块加密密钥（用于加密微信 AppSecret 等敏感信息）
# 必须是 32 字节，可以是 Base64 编码的字符串
# ⚠️ 必须与生产环境 IAM_APISERVER_IDP_ENCRYPTION_KEY 保持一致
# ⚠️ 如果留空，将使用默认密钥（仅用于开发环境）
encryption_key: ""

# ==================== 1. 租户配置 ====================
tenants:
  # 默认租户
  - code: "default"
    name: "默认租户"
    contact_name: "admin"
    contact_phone: "13123456789"
    contact_email: "admin@system.com"
    status: "active"
    max_users: 1000
    max_roles: 100

# ==================== 2. 用户配置 (User Center) ====================
users:
  # 系统用户
  - alias: "system"
    id: 10001
    name: "系统用户"
    phone: "13112345671"
    email: "system@fangcunmount.com"
    id_card: ""
    status: 1
    # 员工配置（可选，用于 QS 服务创建员工）
    org_id: 1
    roles: ["qs:admin"]  # QS 服务的员工角色（使用完整角色名）
    is_active: true

  # 超级管理员
  - alias: "super_admin"
    id: 10002
    name: "超级管理员"
    phone: "13112345672"
    email: "super_admin@fangcunmount.com"
    id_card: ""
    status: 1
    # 员工配置（可选，用于 QS 服务创建员工）
    org_id: 1
    roles: ["qs:admin"]  # QS 服务的员工角色（使用完整角色名）
    is_active: true

  # 系统管理员
  - alias: "admin"
    id: 10003
    name: "系统管理员"
    phone: "13112345673"
    email: "admin@fangcunmount.com"
    id_card: ""
    status: 1
    is_active: true
    # 员工配置（可选，用于 QS 服务创建员工）
    org_id: 1
    roles: ["qs:admin"]  # QS 服务的员工角色（使用完整角色名）
    is_active: true

  - alias: "content_manager"
    id: 10004
    name: "内容管理员"
    phone: "13112345674"
    email: "content_manager@fangcunmount.com"
    id_card: ""
    status: 1
    is_active: true
    # 员工配置（可选，用于 QS 服务创建员工）
    org_id: 1
    roles: ["qs:content_manager"]  # QS 服务的员工角色（使用完整角色名）
    is_active: true

# ==================== 5. 认证账号配置 (Authentication) ====================
accounts:
  # 系统用户 - 运营账号
  - alias: "system_account"
    user_alias: "system"
    provider: "operation"
    external_id: "system"
    username: "system"
    password: "Admin@123"  # 注意: 生产环境应使用强密码
    app_id: ""
    status: 1

  # 超级管理员 - 运营账号
  - alias: "super_admin_account"
    user_alias: "super_admin"
    provider: "operation"
    external_id: "super_admin"
    username: "super_admin"
    password: "Admin@123"  # 注意: 生产环境应使用强密码
    app_id: ""
    status: 1

  # 系统管理员 - 运营账号
  - alias: "admin_account"
    user_alias: "admin"
    provider: "operation"
    external_id: "admin"
    username: "admin"
    password: "Admin@123"  # 注意: 生产环境应使用强密码
    app_id: ""
    status: 1

  # 内容管理员 - 运营账号
  - alias: "content_manager_account"
    user_alias: "content_manager"
    provider: "operation"
    external_id: "content_manager"
    username: "content_manager"
    password: "Admin@123"  # 注意: 生产环境应使用强密码
    app_id: ""
    status: 1
    

# ==================== 5.5 角色配置 (Authorization) ====================
roles:
  # ========== IAM 系统角色（建议补充，确保 seeddata 可统一管理） ==========
  - alias: "super_admin"
    name: "super_admin"
    display_name: "超级管理员"
    tenant_id: "default"
    description: "拥有所有权限"

  - alias: "tenant_admin"
    name: "tenant_admin"
    display_name: "租户管理员"
    tenant_id: "default"
    description: "管理本租户内的所有资源"

  - alias: "user"
    name: "user"
    display_name: "普通用户"
    tenant_id: "default"
    description: "普通用户权限"

  # ========== QS 服务角色 ==========
  - alias: "qs_admin"
    name: "qs:admin"
    display_name: "QS管理员"
    tenant_id: "default"
    description: "QS服务所有资源的管理权限"
  
  - alias: "qs_content_manager"
    name: "qs:content_manager"
    display_name: "内容管理员"
    tenant_id: "default"
    description: "问卷和量表的管理权限"
  
  - alias: "qs_evaluator"
    name: "qs:evaluator"
    display_name: "评估员"
    tenant_id: "default"
    description: "测评相关只读权限"
  
  - alias: "qs_staff"
    name: "qs:staff"
    display_name: "普通员工"
    tenant_id: "default"
    description: "基本查看权限"
  
  - alias: "qs_evaluation_plan_manager"
    name: "qs:evaluation_plan_manager"
    display_name: "测评计划管理员"
    tenant_id: "default"
    description: "测评计划的管理权限"
  
  - alias: "qs_screening_plan_manager"
    name: "qs:screening_plan_manager"
    display_name: "筛查计划管理员"
    tenant_id: "default"
    description: "筛查计划的管理权限"
  
# ==================== 6. 授权资源配置 (Authorization) ====================
resources:
  # ========== IAM 服务资源 ==========
  
  # 用户管理资源
  - alias: "res_iam_users"
    key: "iam:users"
    display_name: "用户管理"
    app_name: "iam"
    domain: "uc"
    type: "collection"
    actions: ["create", "read", "update", "delete", "list"]
    description: "用户中心的用户管理权限"
  
  # 儿童管理资源
  - alias: "res_iam_children"
    key: "iam:children"
    display_name: "儿童管理"
    app_name: "iam"
    domain: "uc"
    type: "collection"
    actions: ["create", "read", "update", "delete", "list"]
    description: "用户中心的儿童档案管理权限"
  
  # 监护关系管理资源
  - alias: "res_iam_guardianships"
    key: "iam:guardianships"
    display_name: "监护关系管理"
    app_name: "iam"
    domain: "uc"
    type: "collection"
    actions: ["create", "read", "update", "delete", "list", "revoke"]
    description: "用户中心的监护关系管理权限"
  
  # 角色管理资源
  - alias: "res_iam_roles"
    key: "iam:roles"
    display_name: "角色管理"
    app_name: "iam"
    domain: "authz"
    type: "collection"
    actions: ["create", "read", "update", "delete", "list", "assign"]
    description: "授权模块的角色管理权限"
  
  # 策略管理资源
  - alias: "res_iam_policies"
    key: "iam:policies"
    display_name: "策略管理"
    app_name: "iam"
    domain: "authz"
    type: "collection"
    actions: ["create", "read", "update", "delete", "list"]
    description: "授权模块的策略管理权限"

  # ========== QS 服务资源 ==========
  
  # 问卷管理
  - alias: "res_qs_questionnaires"
    key: "qs:questionnaires"
    display_name: "问卷管理"
    app_name: "qs"
    domain: "questionnaire"
    type: "collection"
    actions: ["create", "read", "update", "delete", "list", "publish", "unpublish", "archive"]
    description: "问卷的创建、编辑、发布等权限"
  
  # 量表管理
  - alias: "res_qs_scales"
    key: "qs:scales"
    display_name: "量表管理"
    app_name: "qs"
    domain: "scale"
    type: "collection"
    actions: ["create", "read", "update", "delete", "list", "publish", "unpublish", "archive"]
    description: "量表的创建、编辑、发布等权限"
  
  # 测评管理
  - alias: "res_qs_evaluations"
    key: "qs:evaluations"
    display_name: "测评管理"
    app_name: "qs"
    domain: "evaluation"
    type: "collection"
    actions: ["read", "list", "retry", "statistics"]
    description: "测评结果的查看、重试等权限"
  
  # 答卷管理
  - alias: "res_qs_answersheets"
    key: "qs:answersheets"
    display_name: "答卷管理"
    app_name: "qs"
    domain: "answersheet"
    type: "collection"
    actions: ["read", "list", "statistics"]
    description: "答卷的查看、统计等权限"
  
  # 员工管理
  - alias: "res_qs_staff"
    key: "qs:staff"
    display_name: "员工管理"
    app_name: "qs"
    domain: "actor"
    type: "collection"
    actions: ["create", "read", "delete", "list"]
    description: "员工的增删查权限"
  
  # 受试者管理
  - alias: "res_qs_testees"
    key: "qs:testees"
    display_name: "受试者管理"
    app_name: "qs"
    domain: "actor"
    type: "collection"
    actions: ["read", "list", "update"]
    description: "受试者的查看、更新权限"
  
  # 测评计划管理
  - alias: "res_qs_evaluation_plans"
    key: "qs:evaluation_plans"
    display_name: "测评计划管理"
    app_name: "qs"
    domain: "plan"
    type: "collection"
    actions: ["create", "read", "update", "delete", "list", "publish", "unpublish", "archive"]
    description: "测评计划的创建、编辑、发布等权限"
  
  # 筛查计划管理
  - alias: "res_qs_screening_plans"
    key: "qs:screening_plans"
    display_name: "筛查计划管理"
    app_name: "qs"
    domain: "plan"
    type: "collection"
    actions: ["create", "read", "update", "delete", "list", "publish", "unpublish", "archive"]
    description: "筛查计划的创建、编辑、发布等权限"

# ==================== 7. 角色分配配置 (Authorization) ====================
# 注意：
# - subject_id 使用 @alias 语法引用 users 中的别名，运行时替换为实际用户ID
# - role_alias 使用 @alias 语法引用 roles 中的别名；也可以直接用 role_id
assignments:
  # 系统管理员拥有 super_admin 角色（用 alias 解析，避免写死 ID）
  - subject_type: "user"
    subject_id: "@admin"
    role_alias: "@super_admin"
    tenant_id: "default"
    granted_by: "system"
  
  # 系统管理员同时拥有 qs:admin 角色（使用 role_alias 引用）
  - subject_type: "user"
    subject_id: "@admin"
    role_alias: "@qs_admin"
    tenant_id: "default"
    granted_by: "system"
  
# ==================== 8. Casbin 策略配置 (Authorization) ====================
policies:
  # ========== IAM 全局角色策略 ==========
  
  # 超级管理员：所有资源的所有操作
  - type: "p"
    subject: "role:super_admin"
    values: ["*", "*", "allow"]
  
  # 租户管理员：管理租户内资源
  - type: "p"
    subject: "role:tenant_admin"
    values: ["tenant:*", "*", "allow"]
  
  # 普通用户：只能读取和更新自己的信息
  - type: "p"
    subject: "role:user"
    values: ["user:self", "read", "allow"]
  - type: "p"
    subject: "role:user"
    values: ["user:self", "update", "allow"]
  
  # ========== QS 服务角色策略 ==========
  
  # QS 管理员：所有 QS 资源的所有操作
  - type: "p"
    subject: "role:qs:admin"
    values: ["qs:*", "*", "allow"]
  
  # 内容管理员：问卷和量表的完整管理
  - type: "p"
    subject: "role:qs:content_manager"
    values: ["qs:questionnaires", "*", "allow"]
  - type: "p"
    subject: "role:qs:content_manager"
    values: ["qs:scales", "*", "allow"]
  - type: "p"
    subject: "role:qs:content_manager"
    values: ["qs:answersheets", "read|list|statistics", "allow"]
  
  # 评估员：测评相关只读 + 重试
  - type: "p"
    subject: "role:qs:evaluator"
    values: ["qs:evaluations", "read|list|retry|statistics", "allow"]
  - type: "p"
    subject: "role:qs:evaluator"
    values: ["qs:answersheets", "read|list|statistics", "allow"]
  - type: "p"
    subject: "role:qs:evaluator"
    values: ["qs:testees", "read|list", "allow"]
  
  # 普通员工：只能查看受试者
  - type: "p"
    subject: "role:qs:staff"
    values: ["qs:testees", "read|list", "allow"]
  
  # 测评计划管理员：测评计划的完整管理
  - type: "p"
    subject: "role:qs:evaluation_plan_manager"
    values: ["qs:evaluation_plans", "*", "allow"]
  
  # 筛查计划管理员：筛查计划的完整管理
  - type: "p"
    subject: "role:qs:screening_plan_manager"
    values: ["qs:screening_plans", "*", "allow"]
  
  # ========== 角色继承 ==========
  
  # IAM 角色继承
  - type: "g"
    subject: "role:super_admin"
    values: ["role:tenant_admin"]
  - type: "g"
    subject: "role:tenant_admin"
    values: ["role:user"]
  
  # super_admin 继承 qs:admin
  - type: "g"
    subject: "role:super_admin"
    values: ["role:qs:admin"]
  
  # QS 角色继承链: qs:admin -> qs:content_manager -> qs:evaluator -> qs:staff
  - type: "g"
    subject: "role:qs:admin"
    values: ["role:qs:content_manager"]
  - type: "g"
    subject: "role:qs:content_manager"
    values: ["role:qs:evaluator"]
  - type: "g"
    subject: "role:qs:evaluator"
    values: ["role:qs:staff"]  
  - type: "g"
    subject: "role:qs:admin"
    values: ["role:qs:evaluation_plan_manager"]
  - type: "g"
    subject: "role:qs:admin"
    values: ["role:qs:screening_plan_manager"]

# ==================== 9. JWKS 密钥配置 (Authentication) ====================
jwks:
  key_id: "rsa-key-2025-10-31"
  algorithm: "RS256"
  key_size: 2048
  valid_years: 1

# ==================== 10. 微信应用配置 (IDP - WeChat) ====================
wechat_apps:
  # 问卷笔记本小程序
  - alias: "questionnaire_notebook"
    app_id: "wx72ade250b619a649"
    name: "问卷笔记本小程序"
    type: "MiniProgram"
    status: "Enabled"
    app_secret: ""  # 生产环境中应通过环境变量或密钥管理系统设置

# ==================== 11. Collection 服务配置 ====================
# Collection 服务用于创建受试者（testee）数据
# 在 seed_family 过程中，每创建一个儿童（child）后，会自动调用 collection 服务创建对应的受试者
collection_url: "https://collect.yangshujie.com/api/v1"  # Collection 服务 API 地址
# 注意：Collection 服务认证通过 IAM 服务动态获取超级管理员 token，无需预配置

# ==================== 12. QS 服务配置 ====================
# QS 服务用于创建员工、受试者等数据
# 在 seed_system 过程中，创建管理员后会自动调用 QS 服务创建对应的员工
qs_service_url: "https://qs.yangshujie.com/api/v1"  # QS 服务 API 地址

# ==================== 13. IAM 服务配置 ====================
# IAM 服务 URL（用于 seeddata 工具登录获取 token）
# 在创建员工前，需要先登录 IAM 获取 access_token
iam_service_url: "https://iam.yangshujie.com/api/v1"  # IAM 服务 API 地址
