# ============================================================================
# iam-apiserver å¼€å‘ç¯å¢ƒé…ç½®
# ============================================================================
# ç”¨é€”ï¼šIAM èº«ä»½è®¤è¯ä¸æˆæƒæœåŠ¡æœ¬åœ°å¼€å‘ç¯å¢ƒé…ç½®
# ç»´æŠ¤ï¼šå¼€å‘å›¢é˜Ÿ
# æ›´æ–°æ—¶é—´ï¼š2025-12-10
# ============================================================================

# ============================================================================
# 1. åº”ç”¨åŸºç¡€é…ç½®
# ============================================================================
app:
  name: "iam"
  version: "1.0.0"
  mode: "development"  # development, production

# ============================================================================
# 2. æœåŠ¡ç«¯å£é…ç½®
# ============================================================================

# ----------------------------------------------------------------------------
# 2.1 RESTful HTTP/HTTPS æœåŠ¡é…ç½®
# ----------------------------------------------------------------------------
server:
  name: "iam"
  run-mode: "debug"   # Gin å¼€å‘æ¨¡å¼: debug, release, test
  read-timeout: 60    # ç§’
  write-timeout: 60   # ç§’

# HTTP REST API é…ç½®ï¼ˆä¸å®‰å…¨ï¼Œå†…ç½‘ä½¿ç”¨ï¼‰
# ç”¨é€”ï¼šæœ¬åœ°å¼€å‘è°ƒè¯•ï¼Œå¥åº·æ£€æŸ¥
insecure:
  bind-address: "0.0.0.0"
  bind-port: 18081

# HTTPS REST API é…ç½®ï¼ˆå®‰å…¨ï¼Œå¤–ç½‘è®¿é—®ï¼‰
# ç”¨é€”ï¼šæœ¬åœ°å¼€å‘ HTTPS æµ‹è¯•
secure:
  bind-address: "0.0.0.0"
  bind-port: 18441
  tls:
    cert-file: /data/infra/ssl/web/iam-apiserver.crt
    private-key-file: /data/infra/ssl/web/iam-apiserver.key

# CORS è·¨åŸŸé…ç½®ï¼ˆå¼€å‘ç¯å¢ƒå…è®¸æ‰€æœ‰æ¥æºï¼‰
cors:
  allowed-origins:
    - "*"
  allowed-methods:
    - "GET"
    - "POST"
    - "PUT"
    - "DELETE"
    - "OPTIONS"
    - "PATCH"
  allowed-headers:
    - "Content-Type"
    - "Authorization"
    - "X-Requested-With"

# ----------------------------------------------------------------------------
# 2.2 gRPC æœåŠ¡é…ç½®ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
# ----------------------------------------------------------------------------
grpc:
  bind-address: "0.0.0.0"
  bind-port: 19091
  healthz-port: 19092
  
  # mTLS åŒå‘è®¤è¯é…ç½®ï¼ˆç”± infra é¡¹ç›®ç»Ÿä¸€ç®¡ç†ï¼‰
  mtls:
    enabled: true   # å¼€å‘ç¯å¢ƒå¼€å¯ mTLS
    cert-file: "/data/infra/ssl/grpc/server/iam-apiserver.crt"
    key-file: "/data/infra/ssl/grpc/server/iam-apiserver.key"
    ca-file: "/data/infra/ssl/grpc/ca/ca-chain.crt"
    # ca-dir: "/data/infra/ssl/grpc/ca/"  # å¯é€‰ï¼šCA è¯ä¹¦ç›®å½•ï¼Œæ”¯æŒå¤šçº§ CA ä¿¡ä»»é“¾
    require-client-cert: true
    
    # å…è®¸çš„å®¢æˆ·ç«¯è¯ä¹¦ OU åˆ—è¡¨
    allowed-ous:
      - QS
      - Admin
      - Ops
    
    # è¯ä¹¦è‡ªåŠ¨é‡è½½
    enable-auto-reload: true
    reload-interval: 5m
  
  # åº”ç”¨å±‚å‡­è¯è®¤è¯é…ç½®
  auth:
    enabled: false  # å¼€å‘ç¯å¢ƒé»˜è®¤ç¦ç”¨
    enable-bearer: true   # JWT Bearer Token
    enable-hmac: true     # HMAC ç­¾å
    enable-api-key: true  # API Key
    hmac-timestamp-validity: 5m
    require-identity-match: true
  
  # æœåŠ¡çº§ ACL é…ç½®
  acl:
    enabled: false  # å¼€å‘ç¯å¢ƒé»˜è®¤ç¦ç”¨
    config-file: "./configs/grpc_acl.yaml"
  
  # å®¡è®¡æ—¥å¿—é…ç½®
  audit:
    enabled: true  # å¼€å‘ç¯å¢ƒå¼€å¯å®¡è®¡æ—¥å¿—ï¼Œä¾¿äºè°ƒè¯•

# ============================================================================
# 3. æ•°æ®å­˜å‚¨é…ç½®
# ============================================================================

# ----------------------------------------------------------------------------
# 3.1 MySQL æ•°æ®åº“é…ç½®
# ----------------------------------------------------------------------------
mysql:
  host: "127.0.0.1:3306"
  username: "infra_dev"        # å¯¹åº” build/docker/infra/dev.env -> MYSQL_USER
  password: "dev_pass_123"     # å¯¹åº” build/docker/infra/dev.env -> MYSQL_PASSWORD
  database: "iam_contracts"
  max-idle-conns: 10
  max-open-conns: 100
  conn-max-lifetime: 3600  # ç§’
  log-level: 4 # GORM log level, 1: silent, 2:error, 3:warn, 4:info (å¼€å‘ç¯å¢ƒä½¿ç”¨ info)

# ----------------------------------------------------------------------------
# 3.2 æ•°æ®åº“è¿ç§»é…ç½®
# ----------------------------------------------------------------------------
migration:
  enabled: true  # å¼€å‘ç¯å¢ƒå¯ç”¨è‡ªåŠ¨è¿ç§»
  autoseed: true  # å¼€å‘ç¯å¢ƒè‡ªåŠ¨åŠ è½½ç§å­æ•°æ®
  database: "iam_contracts"

# ----------------------------------------------------------------------------
# 3.3 Redis é…ç½®ï¼ˆåŒå®ä¾‹æ¶æ„ï¼‰
# ----------------------------------------------------------------------------
redis:
  # Cache Redis - ç”¨äºç¼“å­˜ã€ä¼šè¯ã€é™æµç­‰ä¸´æ—¶æ•°æ®ï¼ˆç«¯å£ 6379ï¼‰
  cache:
    host: "127.0.0.1"
    port: 6379
    username: "app"  # å¼€å‘ç¯å¢ƒé»˜è®¤ä½¿ç”¨ default ç”¨æˆ·
    password: "dev_app_123"  # å¯¹åº” build/docker/infra/dev.env -> REDIS_CACHE_PASSWORD/REDIS_AUTH_APP_PASSWORD
    database: 0  # Cache ä½¿ç”¨ DB 0
    max-idle: 50
    max-active: 100
    timeout: 5
    enable-cluster: false
    use-ssl: false
    enable-logging: true  # å¼€å¯ Redis å‘½ä»¤æ—¥å¿—ï¼ˆç”¨äºè°ƒè¯•ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®å…³é—­ï¼‰
  
  # Store Redis (Auth) - ç”¨äºæŒä¹…åŒ–å­˜å‚¨ã€é˜Ÿåˆ—ã€å‘å¸ƒè®¢é˜…ç­‰ï¼ˆç«¯å£ 6380ï¼‰
  store:
    host: "127.0.0.1"
    port: 6380
    username: "app"  # å¯¹åº” build/docker/infra/dev.env -> REDIS_AUTH_APP_USERNAME
    password: "dev_app_123"  # ä¸ build/docker/infra/dev.env -> REDIS_AUTH_APP_PASSWORD ä¸€è‡´
    database: 0  # Auth å®ä¾‹ä½¿ç”¨ DB 0ï¼ˆå•ç‹¬å®ä¾‹ä¸éœ€è¦ä¸åŒ DBï¼‰
    max-idle: 50
    max-active: 100
    timeout: 5
    enable-cluster: false
    use-ssl: false
    enable-logging: true  # å¼€å¯ Redis å‘½ä»¤æ—¥å¿—ï¼ˆç”¨äºè°ƒè¯•ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®å…³é—­ï¼‰

# ============================================================================
# 4. å®‰å…¨ä¸è®¤è¯é…ç½®
# ============================================================================

# ----------------------------------------------------------------------------
# 4.1 JWKS å¯†é’¥ç®¡ç†
# ----------------------------------------------------------------------------
jwks:
  keys_dir: "./configs/keys"  # ç§é’¥å­˜æ”¾ç›®å½•ï¼ˆç›¸å¯¹æˆ–ç»å¯¹è·¯å¾„ï¼‰
  auto_init: true           # å¯åŠ¨æ—¶è‹¥æ—  active key åˆ™è‡ªåŠ¨ç”Ÿæˆï¼ˆä»…å»ºè®®åœ¨å¼€å‘ç¯å¢ƒå¯ç”¨ï¼‰

# ----------------------------------------------------------------------------
# 4.2 TLS è¯ä¹¦ï¼ˆé€šç”¨ï¼‰
# ----------------------------------------------------------------------------
tls:
  cert: /data/infra/ssl/web/iam-apiserver.crt
  key: /data/infra/ssl/web/iam-apiserver.key
  strict: false  # å¼€å‘ç¯å¢ƒä¸ä¸¥æ ¼éªŒè¯

# ----------------------------------------------------------------------------
# 4.3 IDP èº«ä»½æä¾›å•†
# ----------------------------------------------------------------------------
idp:
  encryption-key: ""  # ç•™ç©ºä½¿ç”¨é»˜è®¤å¯†é’¥ï¼ˆå¼€å‘ç¯å¢ƒï¼‰æˆ–é€šè¿‡ç¯å¢ƒå˜é‡ IAM_APISERVER_IDP_ENCRYPTION_KEY è®¾ç½®

# ============================================================================
# 5. ç³»ç»Ÿè¿è¡Œé…ç½®
# ============================================================================

# ----------------------------------------------------------------------------
# 5.1 æ—¥å¿—é…ç½®ï¼ˆå¼€å‘ç¯å¢ƒ - ä½¿ç”¨ component-base v0.2.9 duplicate æ¨¡å¼ï¼‰
# ----------------------------------------------------------------------------
log:
  # åŸºç¡€é…ç½®
  disable-caller: false        # å¼€å‘ç¯å¢ƒæ˜¾ç¤ºè°ƒç”¨è€…ä¿¡æ¯
  disable-stacktrace: false    # å¼€å‘ç¯å¢ƒæ˜¾ç¤ºå †æ ˆ
  level: debug                 # å¼€å‘ç¯å¢ƒä½¿ç”¨ debug çº§åˆ«
  format: console              # æ§åˆ¶å°æ ¼å¼ï¼ˆconsole/jsonï¼‰
  enable-color: true           # ğŸ¨ å¼€å‘ç¯å¢ƒå¯ç”¨å½©è‰²è¾“å‡ºï¼Œä¾¿äºè°ƒè¯•
  development: true            # å¼€å‘æ¨¡å¼
  
  # ğŸ“Š æ—¥å¿—è½®è½¬é…ç½®ï¼ˆæŒ‰å¤§å°ï¼‰
  max-size: 100                # å•ä¸ªæ—¥å¿—æ–‡ä»¶æœ€å¤§å¤§å°ï¼ˆMBï¼‰
  max-age: 7                   # ä¿ç•™ 7 å¤©
  max-backups: 10              # ä¿ç•™ 10 ä¸ªå¤‡ä»½æ–‡ä»¶
  compress: true               # å‹ç¼©æ—§æ–‡ä»¶
  
  # â° æŒ‰æ—¶é—´è½®è½¬ï¼ˆå¯é€‰ï¼Œä¸å¤§å°è½®è½¬äºŒé€‰ä¸€ï¼‰
  enable-time-rotation: false  # å¼€å‘ç¯å¢ƒæš‚ä¸å¯ç”¨
  time-rotation-format: "2006-01-02"  # æŒ‰å¤©è½®è½¬æ ¼å¼
  
  # ğŸ¯ åˆ†çº§è¾“å‡ºï¼ˆv0.2.9 duplicate æ¨¡å¼ï¼‰
  enable-level-output: true       # å¯ç”¨åˆ†çº§è¾“å‡º
  level-output-mode: "duplicate"  # è¾“å‡ºæ¨¡å¼ï¼šduplicate=é‡å¤è¾“å‡ºï¼ˆæ¨èï¼‰
  level-output-paths:
    all:
      - stdout                    # æ‰€æœ‰æ—¥å¿—è¾“å‡ºåˆ°æ§åˆ¶å°ï¼ˆå½©è‰²ï¼Œå¼€å‘ç¯å¢ƒï¼‰
      - logs/iam-apiserver.log    # æ‰€æœ‰æ—¥å¿—è®°å½•åˆ°æ–‡ä»¶ï¼ˆå®Œæ•´æ—¥å¿—ï¼‰
    warn:
      - logs/iam-warn.log         # WARN ä»¥ä¸Šé¢å¤–è®°å½•ï¼Œè¾…åŠ©æ’æŸ¥æ€§èƒ½/é…ç½®é—®é¢˜
    error:
      - logs/iam-error.log        # ERROR é¢å¤–è½ç›˜ï¼Œä¾¿äºå¿«é€Ÿå®šä½æ•…éšœ

# ----------------------------------------------------------------------------
# 5.2 NSQ æ¶ˆæ¯é˜Ÿåˆ—é…ç½®ï¼ˆå¯é€‰ï¼Œç”¨äºäº‹ä»¶é©±åŠ¨ï¼‰
# ----------------------------------------------------------------------------
nsq:
  enabled: false                              # å¼€å‘ç¯å¢ƒé»˜è®¤ç¦ç”¨
  lookupd-addrs:                              # NSQLookupd åœ°å€
    - "127.0.0.1:4161"
  nsqd-addr: "127.0.0.1:4150"                # NSQd åœ°å€
  max-attempts: 5                             # æ¶ˆæ¯æœ€å¤§é‡è¯•æ¬¡æ•°
  max-in-flight: 200                          # æœ€å¤§å¹¶å‘å¤„ç†æ•°
  msg-timeout: 60                             # æ¶ˆæ¯è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
  requeue-delay: 5                            # é‡æ–°å…¥é˜Ÿå»¶è¿Ÿï¼ˆç§’ï¼‰
