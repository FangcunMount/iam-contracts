# ============================================================================
# iam-apiserver ç”Ÿäº§ç¯å¢ƒé…ç½®
# ============================================================================
# ç”¨é€”ï¼šIAM èº«ä»½è®¤è¯ä¸æˆæƒæœåŠ¡ï¼Œæä¾› REST API å’Œ gRPC æœåŠ¡
# ç»´æŠ¤ï¼šè¿ç»´å›¢é˜Ÿ
# æ›´æ–°æ—¶é—´ï¼š2025-12-10
# ============================================================================

# ============================================================================
# 1. åº”ç”¨åŸºç¡€é…ç½®
# ============================================================================
app:
  name: "iam"
  version: "1.0.0"
  mode: "production"  # development, production

# ============================================================================
# 2. æœåŠ¡ç«¯å£é…ç½®
# ============================================================================

# ----------------------------------------------------------------------------
# 2.1 RESTful HTTP/HTTPS æœåŠ¡é…ç½®
# ----------------------------------------------------------------------------
server:
  name: "iam"
  run-mode: "release"   # Gin å¼€å‘æ¨¡å¼, å¯é€‰å€¼æœ‰ï¼šdebug, release, test
  read-timeout: 60    # ç§’
  write-timeout: 60   # ç§’

# HTTP REST API é…ç½®ï¼ˆä¸å®‰å…¨ï¼Œå†…ç½‘ä½¿ç”¨ï¼‰
# ç”¨é€”ï¼šå†…ç½‘æœåŠ¡é—´è°ƒç”¨ã€å¥åº·æ£€æŸ¥ï¼Œæ€§èƒ½ä¼˜å…ˆï¼ˆæ—  TLS æ¡æ‰‹å¼€é”€ï¼‰
# å®‰å…¨ç­–ç•¥ï¼šé€šè¿‡ Docker ç½‘ç»œéš”ç¦» + é˜²ç«å¢™è§„åˆ™é™åˆ¶è®¿é—®
insecure:
  bind-address: "0.0.0.0"
  bind-port: 9080

# HTTPS REST API é…ç½®ï¼ˆå®‰å…¨ï¼Œå¤–ç½‘è®¿é—®ï¼‰
# ç”¨é€”ï¼šå¤–éƒ¨å®¢æˆ·ç«¯è®¿é—®ï¼ˆç§»åŠ¨ç«¯ã€Webã€ç¬¬ä¸‰æ–¹æœåŠ¡ï¼‰
# è®¿é—®è·¯å¾„ï¼šå®¢æˆ·ç«¯ -> Nginx (443) -> iam-apiserver (9444)
secure:
  bind-address: "0.0.0.0"
  bind-port: 9444
  tls:
    cert-file: /etc/iam-contracts/ssl/yangshujie.com.crt
    private-key-file: /etc/iam-contracts/ssl/yangshujie.com.key

# CORS è·¨åŸŸé…ç½®
cors:
  allowed-origins:
    - "*"
  allowed-methods:
    - "GET"
    - "POST"
    - "PUT"
    - "DELETE"
    - "OPTIONS"
  allowed-headers:
    - "Content-Type"
    - "Authorization"

# ----------------------------------------------------------------------------
# 2.2 gRPC æœåŠ¡é…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒ - å®‰å…¨æ¨¡å¼ï¼‰
# ----------------------------------------------------------------------------
# ç«¯å£ç­–ç•¥ï¼š
#   - 9090: gRPC æœåŠ¡ç«¯å£ï¼Œå¯ç”¨ mTLS åŒå‘è®¤è¯ï¼Œä»…é™å†…ç½‘å¯ä¿¡æœåŠ¡è®¿é—®
#   - 9091: å¥åº·æ£€æŸ¥ç«¯å£ï¼ŒHTTP åè®®ï¼Œä¾›ç›‘æ§ç³»ç»Ÿä½¿ç”¨ï¼ˆä¸éœ€è¦å®¢æˆ·ç«¯è¯ä¹¦ï¼‰
grpc:
  bind-address: "0.0.0.0"  # ç›‘å¬æ‰€æœ‰æ¥å£ï¼ˆå®¹å™¨å†…ç½‘ç»œï¼‰
  bind-port: 9090        # gRPC æœåŠ¡ç«¯å£
  healthz-port: 9091     # å¥åº·æ£€æŸ¥ç«¯å£ï¼ˆç‹¬ç«‹ HTTP ç«¯å£ï¼Œæ— éœ€ mTLSï¼‰
  
  # mTLS åŒå‘è®¤è¯é…ç½®ï¼ˆç”¨äºå†…éƒ¨æœåŠ¡é—´é€šä¿¡ï¼‰
  mtls:
    enabled: true        # å¯ç”¨ mTLS åŒå‘è®¤è¯ï¼Œå¼ºåˆ¶å®¢æˆ·ç«¯æä¾›è¯ä¹¦
    cert-file: /etc/iam-contracts/grpc/server/iam-grpc.crt
    key-file: /etc/iam-contracts/grpc/server/iam-grpc.key
    ca-file: /etc/iam-contracts/grpc/ca/ca-chain.crt
    # ca-dir: /etc/iam-contracts/grpc/ca/  # å¯é€‰ï¼šCA è¯ä¹¦ç›®å½•ï¼Œæ”¯æŒå¤šçº§ CA ä¿¡ä»»é“¾
    require-client-cert: true  # å¼ºåˆ¶å®¢æˆ·ç«¯æä¾›è¯ä¹¦
    
    # ç»„ç»‡å•å…ƒç™½åå•
    allowed-ous:
      - QS
      - Admin
      - Ops
    
    # è¯ä¹¦è‡ªåŠ¨é‡è½½ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
    enable-auto-reload: true
    reload-interval: 5m
  
  # è®¤è¯é…ç½®
  auth:
    enabled: true
    enable-bearer: true
    enable-hmac: true
    enable-api-key: true
    hmac-timestamp-validity: 5m
    require-identity-match: true
  
  # è®¿é—®æ§åˆ¶åˆ—è¡¨
  acl:
    enabled: true
    config-file: "/app/configs/grpc_acl.yaml"
  
  # å®¡è®¡æ—¥å¿—
  audit:
    enabled: true

# ============================================================================
# 3. æ•°æ®å­˜å‚¨é…ç½®
# ============================================================================

# ----------------------------------------------------------------------------
# 3.1 MySQL æ•°æ®åº“é…ç½®
# ----------------------------------------------------------------------------
mysql:
  host: "your-rds.mysql.rds.aliyuncs.com:3306"  # ç”Ÿäº§ç¯å¢ƒä½¿ç”¨äº‘ RDS å†…ç½‘åœ°å€
  username: "iam"
  password: "iam_contracts_pass123"
  database: "iam_contracts"
  max-idle-conns: 10
  max-open-conns: 100
  conn-max-lifetime: 3600  # ç§’
  log-level: 4 # GORM log level, 1: silent, 2:error, 3:warn, 4:info (ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ silent)

# ----------------------------------------------------------------------------
# 3.2 æ•°æ®åº“è¿ç§»é…ç½®
# ----------------------------------------------------------------------------
migration:
  enabled: true  # æ˜¯å¦å¯ç”¨è‡ªåŠ¨è¿ç§»ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®å¯ç”¨ï¼‰
  autoseed: false  # æ˜¯å¦è‡ªåŠ¨åŠ è½½ç§å­æ•°æ®ï¼ˆä»…å¼€å‘/æµ‹è¯•ç¯å¢ƒï¼‰
  database: "iam_contracts"  # æ•°æ®åº“åç§°

# ----------------------------------------------------------------------------
# 3.3 Redis é…ç½®ï¼ˆåŒå®ä¾‹æ¶æ„ï¼‰
# ----------------------------------------------------------------------------
redis:
  # Cache Redis - ç”¨äºç¼“å­˜ã€ä¼šè¯ã€é™æµç­‰ä¸´æ—¶æ•°æ®
  cache:
    host: "redis-cache"  # ServerA æœ¬åœ°ç¼“å­˜å®ä¾‹ï¼ˆSwarm å®¹å™¨åï¼‰
    port: 6379
    username: ""  # Redis 6.0+ ACL ç”¨æˆ·åï¼Œç•™ç©ºè¡¨ç¤ºä½¿ç”¨ default ç”¨æˆ·
    password: ""
    database: 0  # ç¼“å­˜ä½¿ç”¨ DB 0
    max-idle: 50
    max-active: 100
    timeout: 5
    enable-cluster: false
    use-ssl: false
    enable-logging: false  # ç”Ÿäº§ç¯å¢ƒå…³é—­å‘½ä»¤æ—¥å¿—

  # Store Redis - ç”¨äºæŒä¹…åŒ–å­˜å‚¨ã€é˜Ÿåˆ—ã€å‘å¸ƒè®¢é˜…ç­‰
  store:
    host: "your-redis.redis.rds.aliyuncs.com"  # äº‘ Redis-Store å†…ç½‘åœ°å€ï¼ˆæŒä¹…åŒ–ï¼‰
    port: 6380
    username: ""  # Redis 6.0+ ACL ç”¨æˆ·åï¼Œç•™ç©ºè¡¨ç¤ºä½¿ç”¨ default ç”¨æˆ·
    password: ""
    database: 1  # å­˜å‚¨ä½¿ç”¨ DB 1
    max-idle: 50
    max-active: 100
    timeout: 5
    enable-cluster: false
    use-ssl: false
    enable-logging: false  # ç”Ÿäº§ç¯å¢ƒå…³é—­å‘½ä»¤æ—¥å¿—

# ============================================================================
# 4. å®‰å…¨ä¸è®¤è¯é…ç½®
# ============================================================================

# ----------------------------------------------------------------------------
# 4.1 JWKS å¯†é’¥ç®¡ç†
# ----------------------------------------------------------------------------
jwks:
  keys_dir: "/app/data/keys"
  auto_init: true  # å¯ç”¨è‡ªåŠ¨åˆå§‹åŒ–ï¼Œç¡®ä¿å¯åŠ¨æ—¶è‡³å°‘æœ‰ä¸€ä¸ªæ´»è·ƒå¯†é’¥

# ----------------------------------------------------------------------------
# 4.2 TLS è¯ä¹¦ï¼ˆé€šç”¨ï¼‰
# ----------------------------------------------------------------------------
tls:
  cert: /etc/iam-contracts/ssl/yangshujie.com.crt
  key: /etc/iam-contracts/ssl/yangshujie.com.key
  strict: false

# ----------------------------------------------------------------------------
# 4.3 IDP èº«ä»½æä¾›å•†
# ----------------------------------------------------------------------------
idp:
  encryption-key: "CHANGE_ME_WITH_32_BYTE_BASE64_SECRET"  # å ä½ç¬¦ï¼Œè¯·é€šè¿‡å®‰å…¨æ¸ é“æ³¨å…¥32å­—èŠ‚å¯†é’¥

# ============================================================================
# 5. ç³»ç»Ÿè¿è¡Œé…ç½®
# ============================================================================

# ----------------------------------------------------------------------------
# 5.1 æ—¥å¿—é…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒ - ä½¿ç”¨ component-base v0.2.9 duplicate æ¨¡å¼ï¼‰
# ----------------------------------------------------------------------------
log:
  # åŸºç¡€é…ç½®
  disable-caller: true          # ç”Ÿäº§ç¯å¢ƒç¦ç”¨è°ƒç”¨è€…ä¿¡æ¯ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
  disable-stacktrace: true      # ä»…åœ¨ panic æ—¶è®°å½•å †æ ˆ
  level: debug                   # æ—¥å¿—åŸºæœ¬çº§åˆ«ï¼šdebug, info, warn, error, fatal, panic
  format: console                # æ—¥å¿—æ ¼å¼ï¼ˆjson é€‚åˆç”Ÿäº§ç¯å¢ƒï¼Œconsole é€‚åˆå¼€å‘ç¯å¢ƒï¼‰
  enable-color: false           # æ–‡ä»¶è¾“å‡ºç¦ç”¨é¢œè‰²
  development: false            # ç”Ÿäº§æ¨¡å¼
  name: "iam-apiserver"         # æ—¥å¿—åç§°
  
  # ğŸ“Š æ—¥å¿—è½®è½¬é…ç½®
  max-size: 100                 # å•ä¸ªæ—¥å¿—æ–‡ä»¶æœ€å¤§ 100MB
  max-age: 30                   # ä¿ç•™ 30 å¤©
  max-backups: 10               # ä¿ç•™ 10 ä¸ªå¤‡ä»½æ–‡ä»¶
  compress: true                # å‹ç¼©æ—§æ–‡ä»¶èŠ‚çœç©ºé—´
  
  # â° æŒ‰æ—¶é—´è½®è½¬ï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼‰
  enable-time-rotation: true    # å¯ç”¨æŒ‰å¤©è½®è½¬
  time-rotation-format: "2006-01-02"  # æŒ‰å¤©è½®è½¬
  
  # ğŸ¯ åˆ†çº§è¾“å‡ºï¼ˆv0.2.9 duplicate æ¨¡å¼ - ç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
  enable-level-output: true       # å¯ç”¨åˆ†çº§è¾“å‡º
  level-output-mode: "duplicate"  # é‡å¤è¾“å‡ºæ¨¡å¼ï¼ˆæ¨èï¼‰
  level-output-paths:
    all:
      - stdout                              # å®¹å™¨/è¿›ç¨‹æ ‡å‡†è¾“å‡ºä¿ç•™å®Œæ•´æ—¥å¿—
      - /var/log/iam-contracts/app.log      # å®Œæ•´æ—¥å¿—ï¼ˆæ‰€æœ‰çº§åˆ«ï¼‰
    warn:
      - /var/log/iam-contracts/warn.log     # é¢å¤–è®°å½• WARNï¼ˆå‘ç°æ½œåœ¨é—®é¢˜ï¼Œå¯é€‰ï¼‰
    error:
      - stderr                              # ERROR çº§åˆ«å†™å…¥æ ‡å‡†é”™è¯¯ï¼Œä¾¿äºç›‘æ§é‡‡é›†
      - /var/log/iam-contracts/error.log    # é¢å¤–è®°å½• ERRORï¼ˆå¿«é€Ÿå®šä½æ•…éšœï¼‰
